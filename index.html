<html>  
	
	<!--
	This program is written by AYUSH MANDWAL
	
	For any further questions, please contact us at this email address: ayush.mandwal@ucalgary.ca

	It is made available under a CC-BY-NC-ND 4.0 International license.
	
	Copyright 2021 AYUSH MANDWAL
	-->
	
	
	<head>
	<link rel="stylesheet" href="Ex2.css"/>
        <link type="text/css" href="dropdownmenu2.css" rel="stylesheet"/>
        <link rel="stylesheet" href="bootstrap.min.css" type="text/css"/>
        <link rel="stylesheet" href="bootstrap-multiselect.css" type="text/css"/>
        <link rel="shortcut icon" href="#">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />
        <meta charset="utf-8">
        
        <title>User-interactive visualization</title>

        <script type="text/javascript" src="jquery.min.js"></script>
        <script type="text/javascript" src="jquery.csv.min.js"></script>
        <script type="text/javascript" src="bootstrap.min.js"></script>
	<script type="text/javascript" src="bootstrap-multiselect.js"></script>
	<script type="text/javascript" src="d3.v5.min.js"></script>
        <script type="text/javascript" src="canvas-toBlob.js"></script>
        <script type="text/javascript" src="FileSaver.min.js"></script>
        <script type="text/javascript" src="require.js"></script>
	<script src="https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/vkbeautify/vkbeautify.0.99.00.beta.js"></script>
		
    </head>
    
	<style>
		
		html{ width: 100%; }
		body{ 
		  width: 100%; 
		  margin: 0; padding: 0; 
		  display: flex; 
		  font-family: sans-serif; font-size: 75%; }
		  	
		.controls {
		  flex-basis: 200px;
		  padding: 0 5px;
		}
		.controls .force {
		  background-color:#eee;
		  border-radius: 3px;
		  padding: 5px;
		  margin: 5px 0;
		}
		.controls .force p label { margin-right: .5em; font-size: 120%; font-weight: bold;}
		.controls .force p { margin-top: 0;}
		.controls .force label { display: inline-block; }
		.controls input[type="checkbox"] { transform: scale(1.2, 1.2); }
		.controls input[type="range"] { margin: 0 5% 0.5em 5%; width: 90%; }
		/* alpha viewer */
		.controls .alpha p { margin-bottom: .25em; }
		.controls .alpha .alpha_bar { height: .5em; border: 1px #777 solid; border-radius: 2px; padding: 1px; display: flex; }
		.controls .alpha .alpha_bar #alpha_value { background-color: #555; border-radius: 1px; flex-basis: 100% }
		.controls .alpha .alpha_bar:hover { border-width: 2px; margin:-1px; }
		.controls .alpha .alpha_bar:active #alpha_value { background-color: #222 }
         
        
        .menu {
		  position: absolute;
		  width: 200px;
		  padding: 2px;
		  margin: 0;
		  border: 1px solid #bbb;
		  background: #2c8ae8;
		  z-index: 100;
		  border-radius: 3px;
		  box-shadow: 1px 1px 4px rgba(0,0,0,.2);
		  opacity: 0;
		  -webkit-transform: translate(0, 15px) scale(.95);
		  transform: translate(0, 15px) scale(.95);
		  transition: transform 0.1s ease-out, opacity 0.1s ease-out;
		  pointer-events: none;
		}
		/*
		 background: -webkit-linear-gradient(to bottom, #fff 0%, #e5e5e5 100px, #e5e5e5 100%);
		  background: linear-gradient(to bottom, #fff 0%, #e5e5e5 100px, #e5e5e5 100%);
		*/

		.menu-item {
		  display: block;
		  position: relative;
		  margin: 0;
		  padding: 0;
		  white-space: nowrap;
		}

		.menu-btn {
		  background: none;
		  line-height: normal;
		  overflow: visible;
		  -webkit-user-select: none;
		  -moz-user-select: none;
		  -ms-user-select: none;
		  display: block;
		  width: 100%;
		  color: #fff;
		  font-family: 'Roboto', sans-serif;
		  font-size: 13px;
		  text-align: left;
		  cursor: pointer;
		  border: 1px solid transparent;
		  white-space: nowrap;
		  padding: 6px 8px;
		  border-radius: 3px;
		}
		 .menu-btn::-moz-focus-inner, .menu-btn::-moz-focus-inner {
		 border: 0;
		 padding: 0;
		}

		.menu-text { margin-left: 25px; }

		.menu-btn .fa {
		  position: absolute;
		  left: 8px;
		  top: 50%;
		  -webkit-transform: translateY(-50%);
		  transform: translateY(-50%);
		}

		.menu-item:hover > .menu-btn {
		  color: #fff;
		  outline: none;
		  background-color: #2E3940;
		  border: 1px solid #2E3940;
		}
		
		/*
		background: -webkit-linear-gradient(to bottom, #5D6D79, #2E3940);
		  background: linear-gradient(to bottom, #5D6D79, #2E3940);
		*/

		.menu-item.disabled {
		  opacity: .5;
		  pointer-events: none;
		}

		.menu-item.disabled .menu-btn { cursor: default; }

		.menu-separator {
		  display: block;
		  margin: 7px 5px;
		  height: 1px;
		  border-bottom: 1px solid #fff;
		  background-color: #aaa;
		}

		.menu-item.submenu::after {
		  content: "";
		  position: absolute;
		  right: 6px;
		  top: 50%;
		  -webkit-transform: translateY(-50%);
		  transform: translateY(-50%);
		  border: 5px solid transparent;
		  border-left-color: #808080;
		}

		.menu-item.submenu:hover::after { border-left-color: #fff; }

		.menu .menu {
		  top: 4px;
		  left: 99%;
		}

		.show-menu, .menu-item:hover > .menu {
		  opacity: 1;
		  -webkit-transform: translate(0, 0) scale(1);
		  transform: translate(0, 0) scale(1);
		  pointer-events: auto;
		}

		.menu-item:hover > .menu {
		  -webkit-transition-delay: 100ms;
		  transition-delay: 300ms;
		}
        
		.selected{
              stroke: #000000;
              stroke-width: 3px;
              fill:green;
            }

        .fixed{
              fill: #000000;
            }
            	
		.point{
				r:10;
				fill:red;
				stroke:black;
				stroke-width:2.0;
			}
			
		.spointer{
				width:1;
				height:20;
				fill:black;
			}
		
		.nodes{
				stroke:#000000;
				stroke-width: 2px;
			}
		
		.bdry{
				stroke:#000000;
			}
			
		.new_bdry{
				stroke:#000000;
				stroke-width: 2px;
				fill:orange;
				rx:10.0;
				ry:10.0;
			}
			
		.slider_brush{
				stroke:#000000;
				stroke-width: 1px;
				fill:grey;
				height:20;
			}
		/*	
		.curved{
				stroke: #000000;
              stroke-width: 2px;
			}
		*/	
		.axis {
				opacity: 0.5;
				stroke: black;
			}
			
		.slider {
		  -webkit-appearance: none;
		  width: 100%;
		  height: 10px;
		  border-radius: 5px;
		  background: #d3d3d3;
		  outline: none;
		  opacity: 0.7;
		  -webkit-transition: .2s;
		  transition: opacity .2s;
		}

		.slider:hover {
		  opacity: 1;
		}

		.slider::-webkit-slider-thumb {
		  -webkit-appearance: none;
		  appearance: none;
		  width: 15px;
		  height: 15px;
		  border-radius: 50%;
		  background: #197ee3;
		  cursor: pointer;
		}

		.slider::-moz-range-thumb {
		  width: 15px;
		  height: 15px;
		  border-radius: 50%;
		  background: #197ee3;
		  cursor: pointer;
		}
		
		/* Center the loader */
		#loader {
		  position: absolute;
		  left: 70%;
		  top: 50%;
		  z-index: 1;
		  width: 120px;
		  height: 120px;
		  margin: -76px 0 0 -76px;
		  border: 16px solid #f3f3f3;
		  border-radius: 50%;
		  border-top: 16px solid #3498db;
		  -webkit-animation: spin 2s linear infinite;
		  animation: spin 2s linear infinite;
		}
		
		
		.logowrapper {
		  background: url('MINNO Logo LRG version.svg') center no-repeat;
		  background-size:150%;
		}
		
		@-webkit-keyframes spin {
		  0% { -webkit-transform: rotate(0deg); }
		  100% { -webkit-transform: rotate(360deg); }
		}

		@keyframes spin {
		  0% { transform: rotate(0deg); }
		  100% { transform: rotate(360deg); }
		}

		/* Add animation to "page content" */
		.animate-bottom {
		  position: relative;
		  -webkit-animation-name: animatebottom;
		  -webkit-animation-duration: 1s;
		  animation-name: animatebottom;
		  animation-duration: 1s
		}

		@-webkit-keyframes animatebottom {
		  from { bottom:-100px; opacity:0 } 
		  to { bottom:0px; opacity:1 }
		}

		@keyframes animatebottom { 
		  from{ bottom:-100px; opacity:0 } 
		  to{ bottom:0; opacity:1 }
		}

		#myDiv {
		  display: none;
		  text-align: center;
		}
		
		
		.tgl {
		  display: none;
		}
		.tgl, .tgl:after, .tgl:before, .tgl *, .tgl *:after, .tgl *:before, .tgl + .tgl-btn {
		  box-sizing: border-box;
		}
		.tgl::-moz-selection, .tgl:after::-moz-selection, .tgl:before::-moz-selection, .tgl *::-moz-selection, .tgl *:after::-moz-selection, .tgl *:before::-moz-selection, .tgl + .tgl-btn::-moz-selection {
		  background: none;
		}
		.tgl::selection, .tgl:after::selection, .tgl:before::selection, .tgl *::selection, .tgl *:after::selection, .tgl *:before::selection, .tgl + .tgl-btn::selection {
		  background: none;
		}
		.tgl + .tgl-btn {
		  outline: 0;
		  display: inline-flex;
		  width: 17.4em;
		  height: 4.0em;
		  position: relative;
		  cursor: pointer;
		  -webkit-user-select: none;
			 -moz-user-select: none;
			  -ms-user-select: none;
				  user-select: none;
		}
		.tgl + .tgl-btn:after, .tgl + .tgl-btn:before {
		  position: relative;
		  display: block;
		  content: "";
		  width: 50%;
		  height: 100%;
		}
		.tgl + .tgl-btn:after {
		  left: 0;
		}
		.tgl + .tgl-btn:before {
		  display: none;
		}
		.tgl:checked + .tgl-btn:after {
		  left: 50%;
		}

		.tgl-skewed + .tgl-btn {
		  overflow: hidden;
		  transform: skew(0deg);
		  -webkit-backface-visibility: hidden;
				  backface-visibility: hidden;
		  transition: all 0.2s ease;
		  font-family: sans-serif;
		  background: #888;
		}
		.tgl-skewed + .tgl-btn:after, .tgl-skewed + .tgl-btn:before {
		  transform: skew(0deg);
		  display: inline-block;
		  transition: all 0.2s ease;
		  width: 100%;
		  text-align: center;
		  position: absolute;
		  line-height: 2em;
		  font-weight: bold;
		  color: #fff;
		  text-shadow: 0 1px 0 rgba(0, 0, 0, 0.4);
		}
		.tgl-skewed + .tgl-btn:after {
		  left: 100%;
		  content: attr(data-tg-on);
		  font-family: sans-serif;
		  font-size: 14px;
		  color: #fff;
		  font-weight: 500;
		}
		.tgl-skewed + .tgl-btn:before {
		  left: 0;
		  content: attr(data-tg-off);
		  font-family: 'Roboto Medium', sans-serif;
		  font-size: 14px;
		  color: #fff;
		  font-weight: 500;
		}
		.tgl-skewed + .tgl-btn:active {
		  background: #888;
		}
		.tgl-skewed + .tgl-btn:active:before {
		  left: -10%;
		}
		.tgl-skewed:checked + .tgl-btn {
		  background: #197ee3;
		}
		.tgl-skewed:checked + .tgl-btn:before {
		  left: -100%;
		}
		.tgl-skewed:checked + .tgl-btn:after {
		  left: 0;
		}
		.tgl-skewed:checked + .tgl-btn:active:after {
		  left: 10%;
		}

		
		input.chk-btn {
		  display: none;
		}
		input.chk-btn + label {
		  border: 1px solid grey;
		  background: ghoswhite;
		  padding: 7px 6px;
		  cursor: pointer;
		  border-radius: 5px;
		  font-family: 'Roboto Medium', sans-serif;
		  font-size: 10px;
		}
		input.chk-btn:not(:checked) + label:hover {
		  box-shadow: 0px 1px 3px;
		}
		input.chk-btn + label:active,
		input.chk-btn:checked + label {
		  box-shadow: 0px 0px 3px inset;
		  background: #197ee3;
		  color: #fff;
		}
		
		
		input[type="checkbox"] {
			display: none;
		}
				
		
		.quantity {
		  position: relative;
		}
		
		input[type=number]::-webkit-inner-spin-button,
		input[type=number]::-webkit-outer-spin-button {
		  -webkit-appearance: none;
		  margin: 0;
		}

		input[type=number] {
		  -moz-appearance: textfield;
		}
		
		
		.number-input {
		  border: 2px solid #ddd;
		  display: inline-flex;
		}

		.number-input,
		.number-input * {
		  box-sizing: border-box;
		}

		.number-input button {
		  outline:none;
		  -webkit-appearance: none;
		  background-color: transparent;
		  border: none;
		  align-items: center;
		  justify-content: center;
		  width: 1rem;
		  height: 3rem;
		  cursor: pointer;
		  margin: 0;
		  position: relative;
		}

		.number-input button:after {
		  display: inline-block;
		  position: absolute;
		  font-family: "Font Awesome 5 Free"; 
		  font-weight: 900;
		  content: '\f077';
		  transform: translate(-50%, -50%) rotate(180deg);;
		}
		.number-input button.plus:after {
		  transform: translate(-50%, -50%) rotate(0deg);
		}

		.number-input input[type=number] {
		  font-family: sans-serif;
		  max-width: 5rem;
		  padding: .5rem;
		  border: solid #ddd;
		  border-width: 0 2px;
		  font-size: 1.5rem;
		  height: 3rem;
		  font-weight: bold;
		  text-align: center;
		}
		
	.loader1,
        .loader1:after {
            border-radius: 50%;
            width: 10em;
            height: 10em;
        }
        .loader1 {            
            margin: 60px auto;
            font-size: 10px;
            position: relative;
            text-indent: -9999em;
            border-top: 1.1em solid rgba(0, 0, 0, 0.2);
            border-right: 1.1em solid rgba(0, 0, 0, 0.2);
            border-bottom: 1.1em solid rgba(0, 0, 0, 0.2);
            border-left: 1.1em solid #000000;
            -webkit-transform: translateZ(0);
            -ms-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-animation: load8 1.1s infinite linear;
            animation: load8 1.1s infinite linear;
        }

	.species_loader1,
        .species_loader1:after {
            border-radius: 20%;
            width: 4em;
            height: 4em;
        }
        .species_loader1 {  
			margin: 20px auto;
            font-size: 10px;
            position: relative;
            text-indent: -9em;
            border-top: 1.1em solid rgba(0, 0, 0, 0.2);
            border-right: 1.1em solid rgba(0, 0, 0, 0.2);
            border-bottom: 1.1em solid rgba(0, 0, 0, 0.2);
            border-left: 1.1em solid #000000;
            -webkit-transform: translateZ(0);
            -ms-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-animation: load8 1.1s infinite linear;
            animation: load8 1.1s infinite linear;
        }
		
        @-webkit-keyframes load8 {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
        @keyframes load8 {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
        #loadingDiv1 {
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            opacity: 0.85;
            background-color:#FFFFFF;
        }
	#loadingDiv2 {
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            opacity: 1.0;
            background-color:#FFFFFF;
        }
	h1 {
	text-align: center;
	color:black;
	font-size:30;
	}
	
	.center1 {
	  display: block;
	  margin-left: auto;
	  margin-right: auto;
	  width: 70%;
	}

	.btn_div_container {
		margin-top: 50px;
		display: flex;
		justify-content: center;
		/*
		align-items: center;
		*/
		height: 7vh; /* Adjust the height as needed */
	}

	.btn_div_container1 {
		margin-top: 200px;
		display: flex;
		justify-content: center;
		/*
		align-items: center;
		*/
		height: 20vh; /* Adjust the height as needed */
	}
	
	.default-btn {
		margin: 0 10px;
		background-color: #ffffff;
		color: #000;
		display: inline-block;
		padding: 10px 20px;
		font-size: 16px;
		font-weight: bold;
		text-align: center;
		text-decoration: none;
		cursor: pointer;
		border-radius: 5px;
		transition: background-color 0.3s ease;
	}

	.default-btn1 {
		margin: 0 10px;
		background-color: #ffffff;
		color: #000;
		display: inline-block;
		padding: 10px 20px;
		font-size: 26px;
		font-weight: bold;
		text-align: center;
		text-decoration: none;
		cursor: pointer;
		border-radius: 5px;
		transition: background-color 0.3s ease;
	}

	/* Hover effect */
		.default-btn:hover {
		background-color: #2980b9;
	}

	/* Hover effect */
		.default-btn1:hover {
		background-color: #2980b9;
	}

	.dropmenu_div_container {
		margin-top: 50px;
		display: flex;
		justify-content: center;
		/*
		align-items: center;
		*/
		height: 7vh; /* Adjust the height as needed */
	}

	.dropmenu_div_container2 {
		margin-top: 100px;
		padding: 100px;
		display: flex;
		justify-content: center;
		align-items: center;
		height: 5vh; /* Adjust the height as needed */
	}
	
	.dropmenu_div_container3 {
		margin-top: 0px;
		padding: 10px;
		display: flex;
		justify-content: right;
		align-items: center;
		height: 2vh; /* Adjust the height as needed */
		font-size: 16px;
		font-weight: bold;
		text-align: center;
	}

	.dropmenu_div_container4 {
		margin-top: 50px;
		display: flex;
		justify-content: right;
		/*
		align-items: center;
		*/
		height: 7vh; /* Adjust the height as needed */
	}
	
	.solid_back{
	opacity: 1.0;
	background-color:white;
	}
	
	.typing-text {
		width: 200px;
		white-space: pre-line;
		white-space: nowrap;

		border-right: 1px solid #000;
		font-family: monospace;
		font-size: 1.5em;
		animation: typing 3s steps(40) infinite;
		overflow: hidden;
	}
	
	.typing_text_Div {
		position: absolute;
		top: 200px;
		left: 200px;
		width: 800px; /* Set the width as needed */
		height: 600px; /* Set the height as needed */
	}

		
    </style>
    
    <!--<body onload="myFunction()" style="margin:0;"> -->
     <body>   
	<staticContent>
          <remove fileExtension=".woff" />
          <mimeMap fileExtension=".woff" mimeType="application/x-font-woff" />
          <remove fileExtension=".woff2" />
          <mimeMap fileExtension=".woff2" mimeType="application/font-woff2" />
	  </staticContent>

	  <div class="controls">
		<!--
		<input  type="checkbox" class="tgl tgl-skewed" id="simulationkey"/>
		<label class="tgl-btn" data-tg-off="Simulation OFF" data-tg-on="Simulation ON" for="simulationkey"></label>
		<input  type="checkbox" class="tgl tgl-skewed" id="freezekey"/>
		<label class="tgl-btn" data-tg-off="Freeze OFF" data-tg-on="Freeze ON" for="freezekey"></label>
		-->
		<select id="data_group"></select>
		<select id="ab_data"></select>
		<select id="time_data"></select>
				
		<div id="toolbox">
			<input type="file" multiple id="hidden-file-upload" hidden/>
			<input type="file" id="meta_file" style="display:none">
			<input type="file" multiple id="image_file" style="display:none">
			<!--
			<div>
				<select id="BiGG_models"></select>
				<select id="KEGG_models"></select>
			</div>
			<select id="KEGG_orgs" multiple="multiple"></select>
			-->
			<select id="list_menu" multiple="multiple"></select>
			<select id="remove_nodes" multiple="multiple"></select>
			<!--
			<select id="repeat_nodes" multiple="multiple"></select>
			-->
			<select id="show_names" multiple="multiple"></select>
			<select id="data_analysis"></select>
			<output id="para_slider_output">0</output>
				<input type="range" min="0" max="5"  value="1.0" step="0.1" class="slider" id = "para_slider" oninput="d3.select('#para_slider_output').text(value)">
			<label>
			<!--	
			<input  type="checkbox" class="tgl tgl-skewed" id="dataset" checked/>
			<label class="tgl-btn" data-tg-off="Multiset data" data-tg-on="Singleset data" for="dataset" style="visibility:hidden"></label>
			<input  type="checkbox" class="tgl tgl-skewed" id="settings" checked/>
			<label class="tgl-btn" data-tg-off="Conserve style" data-tg-on="Default style" for="settings" style="visibility:hidden"></label>	
			<select id="var_para"></select>	
			-->	
			
			</label>
			<div class="input-group">					
				<select  class="form-control d-inline-block" id="assign_gp"></select>
				<select class="form-control d-inline-block" id="hide" multiple="multiple"></select>	
			</div>
		</div>
	
	<div class="force">
		<select id="attributes"></select>
		<div class="number-input" >
			<button onclick="this.parentNode.querySelector('#input3').stepDown()" class="minus" id="btn1_input3"></button>
			<input class="quantity" min="-1000" max="1000" name="quantity" value="1" type="number" id="input3">
			<button onclick="this.parentNode.querySelector('#input3').stepUp()" class="plus" id="btn2_input3"></button> 
			<label>
				<output id="random_slider_output">12</output>
				<input type = "range" min = "10" max = "72"  value = "12" class="slider" id = "random_slider" oninput="d3.select('#random_slider_output').text(value)">
			</label>
			<button onclick="this.parentNode.querySelector('#input4').stepDown()" class="minus" id="btn1_input4"></button>
			<input class="quantity" min="-1000" max="1000" name="quantity" value="100" type="number" id="input4">
			<button onclick="this.parentNode.querySelector('#input4').stepUp()" class="plus" id="btn2_input4"></button>
		</div>
	
		<div class="force">
			<select id="color_scales"></select>
			<div width="20px" class="number-input">
				<input type="checkbox" id='invert' class='chk-btn' checked/>
				<label for='invert'>Invert</label>
				<div id="c_scale_fil" float="left">
				</div>
			</div>
			  
		</div>
	  
	</div>
       
        <div id="menu_options">
			<menu class="menu">
				<!--
				<li class="menu-item submenu" id="submenu1">
					<button type="button" class="menu-btn"> <i class="fa fa-users1"></i> <span class="menu-text">Import</span> </button>
					<menu class="menu" id="menu1">
						<li class="menu-item">
							<button type="button" class="menu-btn"  id='upload-input'> <i class="fa fa-comment1"></i> <span class="menu-text">Network file</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn"  id='meta_file_upload'> <i class="fa fa-comment1"></i> <span class="menu-text">Data file</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn"  id='image_file_upload'> <i class="fa fa-comment1"></i> <span class="menu-text">Image</span> </button>
						</li>
					</menu>
				</li>
				-->
				<li class="menu-item submenu" id="submenu2">
					<button type="button" class="menu-btn"> <i class="fa fa-users1"></i> <span class="menu-text">Export</span> </button>
					<menu class="menu" id="menu2">
						<li class="menu-item submenu">
							<button type="button" class="menu-btn"> <i class="fa fa-share1"></i> <span class="menu-text">Network</span> </button>
							<menu class="menu">
							<li class="menu-item">
								<button type="button" class="menu-btn" id='download-input'><i class="fa fa-google-plus1"></i><span class="menu-text">JSON</span></button>
							</li>
							<li class="menu-item">
								<button type="button" class="menu-btn" id='download-kgml'> <i class="fa fa-twitter1"></i><span class="menu-text">KGML</span></button>
							</li>
							<li class="menu-item">
								<button type="button" class="menu-btn" id='savepng'> <i class="fa fa-facebook-official1"></i> <span class="menu-text">PNG</span> </button>
							</li>
							<li class="menu-item">
								<button type="button" class="menu-btn" id='savesvg' > <i class="fa fa-google-plus1"></i> <span class="menu-text">SVG</span> </button>
							</li>
							</menu>
						</li>
						<li class="menu-item submenu">
							<button type="button" class="menu-btn"> <i class="fa fa-share1"></i> <span class="menu-text">Datafile</span> </button>
							<menu class="menu">
							<li class="menu-item disabled">
								<button type="button" class="menu-btn" id='save_datafile_csv'> <i class="fa fa-twitter1"></i> <span class="menu-text">CSV</span> </button>
							</li>
							<li class="menu-item">
								<button type="button" class="menu-btn" id='savesvg_datafile_json'> <i class="fa fa-facebook-official1"></i> <span class="menu-text">JSON</span> </button>
							</li>
							</menu>
						</li>
					</menu>
				</li>
				<li class="menu-item submenu" id="submenu3">
					<button type="button" class="menu-btn"> <i class="fa fa-users1"></i> <span class="menu-text">Delete</span> </button>
					<menu class="menu" id="menu3">
					  <li class="menu-item">
						<button type="button" class="menu-btn"  id='remove-selected'> <i class="fa fa-comment1"></i> <span class="menu-text">Only selected</span> </button>
					  </li>
					  <li class="menu-item">
						<button type="button" class="menu-btn"  id='delete-graph'> <i class="fa fa-comment1"></i> <span class="menu-text">All</span> </button>
					  </li>
					  <li class="menu-item">
						<button type="button" class="menu-btn"  id='delete-color_scale'> <i class="fa fa-comment1"></i> <span class="menu-text">Color Scale</span> </button>
					  </li>
					</menu>
				</li>
				<li class="menu-item submenu" id="submenu4">
					<button type="button" class="menu-btn"> <i class="fa fa-users1"></i> <span class="menu-text">Insert</span> </button>
					<menu class="menu" id="menu4">
					  <li class="menu-item">
						<button type="button" class="menu-btn"  id='insert_text'> <i class="fa fa-comment1"></i> <span class="menu-text">Text</span> </button>
					  </li>
					  <li class="menu-item">
						<button type="button" class="menu-btn"  id='insert_reaction'> <i class="fa fa-comment1"></i> <span class="menu-text">Reaction</span> </button>
					  </li>
					  <li class="menu-item">
						<button type="button" class="menu-btn"  id='insert_node'> <i class="fa fa-comment1"></i> <span class="menu-text">Node</span> </button>
					  </li>
					  <li class="menu-item">
						<button type="button" class="menu-btn"  id='insert_link-node'> <i class="fa fa-comment1"></i> <span class="menu-text">Link-node</span> </button>
					  </li>
					  <li class="menu-item">
						<button type="button" class="menu-btn"  id='insert_rectangle'> <i class="fa fa-comment1"></i> <span class="menu-text">Rectangle</span> </button>
					  </li>
					  <li class="menu-item">
						<button type="button" class="menu-btn"  id='insert_color_scale'> <i class="fa fa-comment1"></i> <span class="menu-text">Color Scale</span> </button>
					  </li>
					</menu>
				</li>
				<li class="menu-item submenu" id="submenu6">
					<button type="button" class="menu-btn"> <i class="fa fa-users1"></i> <span class="menu-text">Select</span> </button>
					<menu class="menu" id="menu6">
						<li class="menu-item submenu">
							<button type="button" class="menu-btn"  id='select_All'> <i class="fa fa-comment1"></i> <span class="menu-text">Select All</span> </button>
							<menu class="menu">
								<li class="menu-item">
									<button type="button" class="menu-btn" id='texts_all'><i class="fa fa-google-plus1"></i><span class="menu-text">All Text</span></button>
								</li>
								<li class="menu-item">
									<button type="button" class="menu-btn" id='labels_all'> <i class="fa fa-twitter1"></i><span class="menu-text">All Labels</span></button>
								</li>
								<li class="menu-item">
									<button type="button" class="menu-btn" id='nodes_all'> <i class="fa fa-facebook-official1"></i> <span class="menu-text">All Nodes</span> </button>
								</li>
								<li class="menu-item">
									<button type="button" class="menu-btn" id='links_all' > <i class="fa fa-google-plus1"></i> <span class="menu-text">All Links</span> </button>
								</li>
								<li class="menu-item">
									<button type="button" class="menu-btn" id='recs_all' > <i class="fa fa-google-plus1"></i> <span class="menu-text">All Rectangles</span> </button>
								</li>
								<li class="menu-item">
									<button type="button" class="menu-btn" id='imgs_all' > <i class="fa fa-google-plus1"></i> <span class="menu-text">All Images</span> </button>
								</li>
							</menu>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn"  id='select_node'> <i class="fa fa-comment1"></i> <span class="menu-text">Node</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn"  id='select_l_node'> <i class="fa fa-comment1"></i> <span class="menu-text">Link Node</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn"  id='select_l'> <i class="fa fa-comment1"></i> <span class="menu-text">Link</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn"  id='select_l_node_both'> <i class="fa fa-comment1"></i> <span class="menu-text">Select nodes and links</span> </button>
						</li>
					</menu>
				</li>
				<li class="menu-separator"></li>
				<li class="menu-item submenu" id="submenu7">
					<button type="button" class="menu-btn"> <i class="fa fa-users1"></i> <span class="menu-text">Geometric operations</span> </button>
					<menu class="menu"  id="menu7">
						<li class="menu-item submenu">
							<button type="button" class="menu-btn"> <i class="fa fa-share1"></i> <span class="menu-text">Alignment</span> </button>
							<menu class="menu">
							<li class="menu-item">
								<button type="button" class="menu-btn" id='alignhorizontal'><i class="fa fa-google-plus1"></i><span class="menu-text">Horizontal</span></button>
							</li>
							<li class="menu-item">
								<button type="button" class="menu-btn" id='alignvertical'> <i class="fa fa-twitter1"></i><span class="menu-text">Vertical</span></button>
							</li>
							<li class="menu-item">
								<button type="button" class="menu-btn" id='aligncircular'> <i class="fa fa-facebook-official1"></i> <span class="menu-text">Circular</span> </button>
							</li>
							</menu>
						</li>
						<li class="menu-item submenu">
							<button type="button" class="menu-btn"> <i class="fa fa-share1"></i> <span class="menu-text">Layer</span> </button>
							<menu class="menu">
							<li class="menu-item">
								<button type="button" class="menu-btn" id='movetofront'> <i class="fa fa-twitter1"></i> <span class="menu-text">Bring to front</span> </button>
							</li>
							<li class="menu-item">
								<button type="button" class="menu-btn" id='movetoback'> <i class="fa fa-facebook-official1"></i> <span class="menu-text">Push to back</span> </button>
							</li>
							</menu>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn" id='duplicate'> <i class="fa fa-folder-open1"></i> <span class="menu-text">Duplicate</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn" id='rotate'> <i class="fa fa-folder-open1"></i> <span class="menu-text">Rotation</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn" id='make_arc'> <i class="fa fa-folder-open1"></i> <span class="menu-text">Make arc</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn" id='remove_arc'> <i class="fa fa-folder-open1"></i> <span class="menu-text">Remove arc</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn" id='highlight'> <i class="fa fa-folder-open1"></i> <span class="menu-text">Highlight</span> </button>
						</li>
						<li class="menu-item">
							<button type="button" class="menu-btn" id='unhighlight'> <i class="fa fa-folder-open1"></i> <span class="menu-text">Unhighlight</span> </button>
						</li>
					</menu>
				</li>
				<li class="menu-item">
					<button type="button" class="menu-btn" id='undo'> <i class="fa fa-folder-open1"></i> <span class="menu-text">Undo</span> </button>
				</li>
				<li class="menu-item">
					<button type="button" class="menu-btn" id='redo'> <i class="fa fa-folder-open1"></i> <span class="menu-text">Redo</span> </button>
				</li>
				<li class="menu-item">
					<button type="button" class="menu-btn" id='help'> <i class="fa fa-folder-open1"></i> <span class="menu-text">Help</span> </button>
				</li>
				<!--
				<li class="menu-item disabled">
					<button type="button" class="menu-btn"> <span class="menu-text">Open in another tab</span> </button>
				</li>
				-->
			</menu>	
        </div>
        
  	</div>
        
        <script>
		
		var prefix_url = 'https://ftp.ncbi.nlm.nih.gov/genomes/refseq/'
		
		$('body').append('<div style="" id="loadingDiv1"> <h1></h1> <img class="center1" src="MINNO Logo LRG_centered.svg" alt="logo" width="228" height="228"> <h1> Metabolic Interactive Nodular Network for Omics </h1> <h1>Loading files...</h1> <div class="loader1">Loading...</div></div>');
			
		$(window).on('load', function(){
			myFunction()				
			setTimeout(removeLoader, 1000); //wait for page load PLUS two seconds.
			//setTimeout(anotherdivremoveloader, 5000);
		});
		
		function removeLoader2(){
			$( "#loadingDiv1" ).remove();
		}
		
		function removeLoader(){
			$( "#loadingDiv1" ).fadeOut(500, function() {
			  // fadeOut complete. Remove the loading div
			$( "#loadingDiv1" ).remove(); //makes page more lightweight   
		    });	
		    
		    $('body').append('<div style="" id="loadingDiv2"> <div class="btn_div_container"> <button class="default-btn" onclick="addanotherdivloader1()">Tutorial</button> <button class="default-btn" onclick="addanotherdivloader2()">Load networks files</button> <button class="default-btn" onclick="addanotherdivloader3()">Build network files</button> </div> <h1 id="species_loading_h1_id" style="display: none;"> Please wait! Lists of species and pathways are being loaded. </h1> <div id="speciesloadingIcon" class="species_loader1" style="display: none;"> </div> <div class="dropmenu_div_container" id="dropmenu_species_div_container_id1" style="display: none;"> <select id="drop_menu_1"></select> </div> <div class="dropmenu_div_container" id="dropmenu_pathways_div_container_id2" style="display: none;"> <input type="file" id="networkfileInput" multiple style="display: none;" /> <input type="file" id="meta_file2" style="display: none;"/> <select id="KEGG_orth_models" multiple="multiple"></select> </div> <div class="dropmenu_div_container" id="dropmenu_pathways_div_container_id3" style="display: none;"></div> <div class="dropmenu_div_container" id="dropmenu_pathways_div_container_id4" style="display: none;"> <div id="datafilename1"></div> </div> <div class="dropmenu_div_container4" id="dropmenu_pathways_div_container_id5" style="display: none;"></div> <div id="myDiv_tutorial"><div id="typing-text" class="typing_text_Div"></div></div> <div id="myDiv_loadfiles"> <div id="loadfilediv1"><div id="fileNameDisplay1"></div></div> <div id="loadfilediv2"><div id="fileNameDisplay2"></div></div> <div id="loadfilediv3"></div> </div> <div id="myDiv_buildnet"></div>');
		    
			d3.select("#fileInput").on("change", function(){
			// HTML5 finally provides a standard way to interact with local files, via the File API specification. first line checks if the browser fully supports the File API or not.  

				if (window.File && window.FileReader && window.FileList && window.Blob) {
					
					 // Check if a file is selected
					if (fileInput.files.length > 0) {
					// Get the selected file
					var selectedFile = fileInput.files[0];

					// Use FileReader to read the file
					var reader = new FileReader();

					reader.onload = function(event) {
						// Display the content of the file
						var pathway_list = event.target.result.split('\n');
				
						var pathway_menu_data = []
						//pathway_menu_data.push({'label':'Select pathway','value':'Select pathway'})

						pathway_list.forEach(function(path,i){
							pathway_menu_data.push({'label':path,'value':path})
						});

						$('#KEGG_orth_models').multiselect('dataprovider', pathway_menu_data);
						
						
					};

					// Read the file as text
					reader.readAsText(selectedFile);
					} else {
						alert("Please select a file first.");
					}
				}
				else {
					alert("Your browser won't let you save this graph -- try upgrading your browser to IE 10+ or Chrome or Firefox.")
				};
			});
			
			
			//*/
			d3.select("#networkfileInput").on("change", function(){
			//document.getElementById("#networkfileInput").on("click", function(){
			// HTML5 finally provides a standard way to interact with local files, via the File API specification. first line checks if the browser fully supports the File API or not.  
				// For building the network files together.
				 if (window.File && window.FileReader && window.FileList && window.Blob) {
					
					var filelist = this.files,
						filenames = [];
					
					console.log(filelist)
					
					//var jsonObj = {"nodes":[],"links":[]}
					var nodeslst = []
					var linkslst = []
					var xcorlst = [];
					var ycorlst = [];
					
					
					// Example functions that return promises
					function firstFunction() {
						return new Promise(resolve => {
							setTimeout(() => {
							
							for(let filen = 0; filen< filelist.length; filen++)
							{	
								if(filen==0){
									console.log(filelist[filen].name)
									filenames.push(filelist[filen].name)
									var reader = new FileReader();
									reader.readAsText(filelist[filen]);
									
									reader.onload = function(event) {
										// Display the content of the file
										var network_data = event.target.result;
										var d_jsonobj = JSON.parse(network_data)
										//console.log(d_jsonobj)
										
										d_jsonobj["nodes"].forEach(function(n){
											nodeslst.push(n)
											console.log(n.x)
											xcorlst.push(n.x)
											ycorlst.push(n.y)
										})
										d_jsonobj["links"].forEach(function(n){
											linkslst.push(n)
										})
									}
									xmax = Math.max(xcorlst)
									ymax = Math.max(ycorlst)
								}
								else{
									console.log('xmax',xmax)
									console.log('xcorlst',xcorlst)
									console.log(filelist[filen].name)
									filenames.push(filelist[filen].name)
									var reader = new FileReader();
									reader.readAsText(filelist[filen]);
									
									reader.onload = function(event) {
										// Display the content of the file
										var network_data = event.target.result;
										var d_jsonobj = JSON.parse(network_data)
										//console.log(d_jsonobj)
										
										d_jsonobj["nodes"].forEach(function(n){
											n.x = n.x + 50.0 + xmax
											nodeslst.push(n)
											//xcorlst.push(n.x)
											//ycorlst.push(n.y)
										})
										d_jsonobj["links"].forEach(function(n){
											linkslst.push(n)
										})
									}
								}
							}

							console.log('First function');
							resolve();
							}, 2000); // Simulating an asynchronous operation with a timeout
						});
					}

					
					// Async function to call two functions in sequence
					async function callFunctionsInSequence() {
					await firstFunction();
					await secondFunction();
					}

					// Call the async function
					//callFunctionsInSequence();
					
					async function processFilesSequentially(fileUrls) {
						let nofrows = Math.floor(Math.sqrt(fileUrls.length))	
						let npr = Math.floor(fileUrls.length/nofrows)	
						console.log('npr',npr)					
						console.log('nofrows',nofrows)	
						
						var ymax = -100000000000000000;
						var ycorlst = [];
										
						for(let i=0; i<nofrows; i++){
							
							var xcorlst = [];
							
							var xmax = -100000000000000000;
							
							//for (const fileUrl of fileUrls) {
							if(i==0){
								for(let j=0; j<npr; j++){
									let fileUrl = fileUrls[npr*i+j]
									ymax = await processFile(fileUrl,j,i,npr*i+j,xcorlst,ycorlst,ymax);
									//console.log(Math.floor(Math.sqrt(2.6)))
								}
							}
							else if(i<nofrows-1){
								for(let j=0; j<npr; j++){
									let fileUrl = fileUrls[i*npr+j]
									ymax = await processFile(fileUrl,j,i,npr*i+j,xcorlst,ycorlst,ymax);
								}
							}
							else{
								if(fileUrls.length> npr*nofrows){
									for(let j=0; j<(fileUrls.length-i*nofrows); j++){
										let fileUrl = fileUrls[i*npr+j]
										ymax = await processFile(fileUrl,j,i,npr*i+j,xcorlst,ycorlst,ymax);
									}
								}
								else{
									for(let j=0; j<npr; j++){
										let fileUrl = fileUrls[i*npr+j]
										ymax = await processFile(fileUrl,j,i,npr*i+j,xcorlst,ycorlst,ymax);
									}
								}
							}
						}
					}

					async function processFile(fileUrl,i,chrow,fileno,xcorlst,ycorlst,ymax) {
					  return new Promise((resolve, reject) => {
						// Simulating an asynchronous operation, such as loading a file
						setTimeout(() => {
							console.log('fileno',fileno)
							if(i==0){
								if(xcorlst.length>0){
									xmax = xcorlst.reduce((max, current) => (current > max ? current : max), xcorlst[0])//Math.max(xcorlst)
									console.log('xmax',xmax)
								}
								if(ycorlst.length>0){
									ymax = ycorlst.reduce((max, current) => (current > max ? current : max), ycorlst[0])
									console.log('ymax',ymax)
								}
								//console.log(fileUrl.name)
								filenames.push(fileUrl.name)
								var reader = new FileReader();
								reader.readAsText(fileUrl);
								
								reader.onload = function(event) {
									// Display the content of the file
									var network_data = event.target.result;
									var d_jsonobj = JSON.parse(network_data)
									//console.log(d_jsonobj)
									
									d_jsonobj["nodes"].forEach(function(n){
										n.id = n.id + "_" + fileno
										if(chrow>0){
											n.y = n.y + 50.0 + ymax
										}
										else{
										}
										nodeslst.push(n)
										//console.log(n.x)
										xcorlst.push(n.x)
										ycorlst.push(n.y)
									})
									d_jsonobj["links"].forEach(function(n){
										n.id = n.id + "_"+fileno
										n.source = n.source + "_" + fileno
										n.target = n.target + "_" + fileno
										linkslst.push(n)
									})
								}
								
								xmax = xcorlst.reduce((max, current) => (current > max ? current : max), xcorlst[0])
								ymax = ycorlst.reduce((max, current) => (current > max ? current : max), ycorlst[0])
								
								//console.log(`Processed file: ${fileUrl.name}`);
							}
							else{
								//xmax = xcorlst.reduce((max, current) => (current > max ? current : max), xcorlst[0])
								ymax = ycorlst.reduce((max, current) => (current > max ? current : max), ycorlst[0])
								
								filenames.push(fileUrl.name)
								var reader = new FileReader();
								reader.readAsText(fileUrl);
								//console.log('xmax1',xmax)
								//console.log('ymax1',ymax)
								//console.log('xcorlst',xcorlst)
								reader.onload = function(event) {
									// Display the content of the file
									var network_data = event.target.result;
									var d_jsonobj = JSON.parse(network_data)
									//console.log(d_jsonobj)
									
									d_jsonobj["nodes"].forEach(function(n){
										n.id = n.id + "_" + fileno
										n.x = n.x + 50.0 + xmax
										if(chrow>0){
											n.y = n.y + 50.0 + ymax
										}
										else{
										}
										nodeslst.push(n)
										xcorlst.push(n.x)
										ycorlst.push(n.y)
									})
									d_jsonobj["links"].forEach(function(n){
										n.id = n.id + "_" + fileno
										n.source = n.source + "_" + fileno
										n.target = n.target + "_" + fileno
										linkslst.push(n)
									})
								}
								xmax = xcorlst.reduce((max, current) => (current > max ? current : max), xcorlst[0])
								ymax = ycorlst.reduce((max, current) => (current > max ? current : max), ycorlst[0])
								
								//console.log(`Processed file: ${fileUrl.name}`);
							}
							
							
							// Display the file name in a div
							var fileNameDisplay1 = document.getElementById("fileNameDisplay1");
							fileNameDisplay1.textContent = "Selected File: " + fileUrl.name;
							
						
						  console.log(`Processed file: ${fileUrl.name}`);
						  resolve();
						  return ymax
						}, 1000); // Simulated delay, adjust as needed
					  });
					}
					
					function secondFunction() {
						return new Promise(resolve => {
							setTimeout(() => {
							
							//console.log(nodeslst)
							//console.log(linkslst)
							
							jsonObj["nodes"] = nodeslst
							jsonObj["links"] = linkslst
							
							Main_visualization_code(jsonObj)
							Mainfunction(jsonObj)
							
							console.log('Second function');
							resolve();
							}, 1000); // Simulating an asynchronous operation with a timeout
						});
					}
					
					// Example usage
					//const fileUrls = ['file1.txt', 'file2.txt', 'file3.txt','file4.txt', 'file5.txt', 'file6.txt','file7.txt', 'file8.txt', 'file9.txt','file10.txt', 'file11.txt'];
					const fileUrls = filelist;

					// Call the function and await its completion
					async function startProcessing() {
					  await processFilesSequentially(fileUrls);
					  console.log('All files processed.');
					  await secondFunction();
					}

					// Call the async function
					startProcessing();

				}
				else {
					alert("Your browser won't let you save this graph -- try upgrading your browser to IE 10+ or Chrome or Firefox.")
				};
			});	
			//*/
			
			d3.select("#meta_file2").on("change", function(){
				if (window.File && window.FileReader && window.FileList && window.Blob){
					var uploadFile = this.files[0];
					
					var data_by_gp = [], cidx;
					
					d3.select("#para_slider").on("change", function(){						
						
						//scaling_val = d3.select('#para_slider').node().selectedOptions[0].value
						scaling_val = d3.select('#para_slider')['_groups']['0']['0'].value
						//console.log(d3.select('#para_slider')['_groups']['0']['0'].value)
							
						//console.log('scaling_val',scaling_val)
						
						async function callFunctionsInSequence() {
						//await firstFunction();
						await secondFunction();
						await thirdFunction();
						}

						// Call the async function
						callFunctionsInSequence();
						
					});
					
					$('#assign_gp').multiselect('dataprovider', no_of_grps);
					
					//$('#data_analysis').multiselect('dataprovider', Methods);
					
					//var variable_para = [
					//	{'label': 'None', value: 'None'},
					//	{'label': 'scaling', value: 'variation'}
					//]
					
					//$('#var_para').multiselect('dataprovider', variable_para);
					
					
					// Example functions that return promises
					function firstFunction() {
						return new Promise(resolve => {
							setTimeout(() => {
							
							if(uploadFile.type.includes("excel") || uploadFile.type.includes("text")){
								var reader = new FileReader();
								console.log(uploadFile)
								reader.readAsText(uploadFile);
								reader.onload = function(event){
									var csv = event.target.result,
										data = $.csv.toArrays(csv),
										keys = data[0];
									//console.log('keys',keys)
									var G1 = [],G2 = [],G3 = [], Gp = [];

									keys.forEach(function(d,i){
										if(i>1){
											var group = d.split("_")
											G1.push({'label':group[0],'value':group[0]})
											G2.push({'label':group[1],'value':group[1]})
											G3.push({'label':group[2],'value':group[2]})
										}
									});
									
									data.forEach(function(d,i){
										if(i>0)
											Gp.push({'label':d[1],'value':d[1]})
									})
									
									Gp.push({'label':"M",'value':"M"})
									Gp.push({'label':"R",'value':"R"})
									
									G1.push({'label':"None",'value':"None"})
									//G2.push({'label':"None",'value':"None"})
									
									data_group = removeDuplicates(G1, "value");
									ab_data = removeDuplicates(G2, "value");
									time_data = removeDuplicates(G3, "value");
									no_of_grps = removeDuplicates(Gp, "value");
									
									data_group.sort(compare);
									ab_data.sort(compare);
									time_data.sort(compare);
									
									Gval = data_group[0].value
									//Abval = ab_data[0].value
									tval = time_data[0].value
									
									for(let i=0; i<ab_data.length; i++){
										if(ab_data[i].value=="C"){
											ab_data[i]["disabled"] = true;
											//attributes_obj[3]["children"][1]["disabled"] = true;		
										}
										else{
											Abval = ab_data[i].value
										}
									}
									
									var container1 = {}; // main object
									
									for(let e1 = 0; e1<data_group.length; e1++){
										var container2 = { }; // main object
										for(let e2 = 0; e2<ab_data.length; e2++){
											var nodesele = [];
											
											for(var row in data) {
												if(row>0){
													var container3 = { }; // main object
													for(let e3 = 0; e3<time_data.length; e3++){
														let column = data_group[e1].value + "_" + ab_data[e2].value + "_" + time_data[e3].value
														let idx = keys.findIndex(x => x === column); 
														container3[time_data[e3].value] = parseFloat(data[row][idx])
														container3["name"] = data[row][0];	
														container3["gp"] = data[row][1];	
													}
													nodesele.push(container3);
												}
											}
											let obj = {};
											obj["nodes"] = nodesele;
											obj["links"] = [];
											container2[ab_data[e2].value] = obj;
										}
										container1[data_group[e1].value] = container2;
									}
									//console.log('container1',container1)
									cdata = jQuery.extend(true, {}, container1);
									
									let ab_data_lst = [];
									ab_data.forEach(function(ab){
										ab_data_lst.push(ab.value)
									})
									
									cidx = ab_data_lst.findIndex(x => x === "C"); 
									
									data_by_gp = get_data_std(cdata,cidx);
									
									$('#data_group').multiselect('dataprovider', data_group);
										
									$('#ab_data').multiselect('dataprovider', ab_data);

									$('#time_data').multiselect('dataprovider', time_data);
									
									$('#assign_gp').multiselect('dataprovider', no_of_grps);
																	
									no_of_grps.forEach(function(gp){
										Methods.push({'label':gp.value, 'children': basic_Methods})
									})
									
									$('#data_analysis').multiselect('dataprovider', Methods);
									
									// Display the file name in a div
									var fileNameDisplay2 = document.getElementById("fileNameDisplay2");
									fileNameDisplay2.textContent = "Selected File: " + uploadFile.name;
									

								};
								reader.onerror = function(){ alert('Unable to read ' + uploadFile.name); };
							}
							
							else{
								alert("Your datafile is not in correct format! \n\n Only CSV formats")
							}
							
							
							

							console.log('First function');
							resolve();
							}, 2000); // Simulating an asynchronous operation with a timeout
						});
					}

					function secondFunction() {
						return new Promise(resolve => {
							setTimeout(() => {
							
							Gval = d3.select('#data_group').node().selectedOptions[0].value;
							tval = d3.select('#time_data').node().selectedOptions[0].value;
							Abval = d3.select('#ab_data').node().selectedOptions[0].value;
							
							cdata_temp = jQuery.extend(true, {}, cdata);
							//console.log('cdata_temp',cdata_temp)
							
							
							//console.log('method',d3.select('#data_analysis').node().selectedOptions[0].value)
							
							//if(d3.select('#data_analysis').node().selectedOptions[0].value=="Control Normalization"){
								
							let gp_names = [], gp_name;
							
							/*
							let ab_data_lst = [],cidx;
							ab_data.forEach(function(ab){
								ab_data_lst.push(ab.value)
							})
							
							cidx = ab_data_lst.findIndex(x => x === "C"); 
							*/
							
							no_of_grps.forEach(function(gp){
								gp_names.push(" " + gp.value)
							})
							
							//console.log(no_of_grps,"no_of_grps")
							
							$(".multiselect-container").find("li.active:not(.multiselect-group)").each(function(index, item) {
								let gpname = $(this).prevAll(".multiselect-group:first");
								if(gp_names.includes($(this).prevAll(".multiselect-group:first").text())){
									gp_name = $(this).prevAll(".multiselect-group:first").text()
								}
							})
							
							
							for(let i=0; i< ab_data.length; i++){
								
								if(i!=cidx){
									let arr_n1 = copy_by_value(cdata_temp[Gval][ab_data[i].value]["nodes"])
									//console.log('cdata_temp',cdata_temp)
									arr_n1.forEach(function(n,k){
										if((" " + n.gp)==gp_name){
											let arr_n = copy_by_value(cdata_temp[Gval][ab_data[cidx].value]["nodes"])
											let n2 = arr_n.filter(function(n1){
												if(n1.name==n.name && (" " + n1.gp)==gp_name){
													return n1
												}
											});
											
											let std_dev = 0.0;
											
											//console.log('data_by_gp',data_by_gp)
											//console.log('n.gp',n.gp)
											
											data_by_gp[0][n.gp].forEach(function(n3){
												if(n3.name==n.name){
													std_dev = dev(n3["data-values"])
												}
											})
							
											//console.log("std",std_dev)
											
											for(let j=0; j<time_data.length; j++){
												n[time_data[j].value] = (n[time_data[j].value]-n2[0][time_data[j].value])*scaling_val*1.0/std_dev + base_val*1.0
												if((n[time_data[j].value])>20.0){
													n[time_data[j].value] = 20.0
												}
												else if((n[time_data[j].value])<0.0){
													n[time_data[j].value] = 0.0 
												}
											}
										}
									});	
									cdata_temp[Gval][ab_data[i].value]["nodes"] = arr_n1.slice(); 									
								}
							}
							
							if(Object.keys(cdata_final).length==0){
								cdata_final = jQuery.extend(true, {}, cdata_temp);
							}
							
							for(let i=0; i< ab_data.length; i++){
								for(let j=0; j<cdata_final[Gval][ab_data[i].value]["nodes"].length; j++ ){
									let n = cdata_final[Gval][ab_data[i].value]["nodes"][j]
									if((" " + n.gp)==gp_name){
										var arr_n = cdata_temp[Gval][ab_data[i].value]["nodes"].slice();
										var n2 = arr_n.filter(function(n1){
											if(n1.name==n.name && (" " + n1.gp)==gp_name){
												return n1
											}
										});
										cdata_final[Gval][ab_data[i].value]["nodes"][j] = n2[0];
									}
								}
							}	
							
							//console.log('cdata_final',cdata_final)
							
							
							console.log('Second function');
							resolve();
							}, 1000); // Simulating an asynchronous operation with a timeout
						});
					}
					
					function thirdFunction() {
						return new Promise(resolve => {
							setTimeout(() => {
							
							updateNet(cdata_final,Gval,Abval,tval)
							
							console.log('Third function');
							resolve();
							}, 1000); // Simulating an asynchronous operation with a timeout
						});
					}

					// Async function to call two functions in sequence
					async function callFunctionsInSequence() {
					await firstFunction();
					await secondFunction();
					await thirdFunction();
					}

					// Call the async function
					callFunctionsInSequence();
					
					function get_data_std(cdata,cidx){
						let data_by_gp = [];
							 
						let arr_n = copy_by_value(cdata[Gval][ab_data[cidx].value]["nodes"])
						
						let gp_dic = {};
						no_of_grps.forEach(function(gp){
							//if((" " + gp.value)!=" M" && (" " + gp.value)!=" R"){
							if((" " + gp.value)!=" R"){
								let gp_cat = [];
								arr_n.forEach(function(n1,k){
									let dic = {};
									let dummyarr = [];
									ab_data.forEach(function(ab){
										let arr_n1 = copy_by_value(cdata[Gval][ab.value]["nodes"])
										
										arr_n1.forEach(function(n,k){
											if((" " + n.gp)==(" " + gp.value) && (n1.name==n.name)){
												time_data.forEach(function(t){
													dummyarr.push(n[t.value])
												});	
											}
										});
									});
									if((" " + n1.gp)==(" " + gp.value)){
										dic["name"] = n1.name;									
										dic["data-values"] = dummyarr;
										gp_cat.push(dic)
									}
								});
								gp_dic[gp.value] = gp_cat;
							}
						});
						data_by_gp.push(gp_dic);
						//console.log("data_by_gp",data_by_gp)
						return data_by_gp;
						
					};
					
					
				}
				else{
					alert("Your browser won't let you save this graph -- try upgrading your browser to IE 10+ or Chrome or Firefox.")
				};
			});
			
		}
		
		function anotherdivremoveloader(){
			$("#loadingDiv2").fadeOut(500, function() {
			  // fadeOut complete. Remove the loading div
			$("#loadingDiv2").remove(); //makes page more lightweight 
			});
		}
		
		 const imageUrls = [
		'',	 
		'images/image1.png',
		'images/image2.png',
		'images/image3.png',
		'images/image3.png',
		'images/image4.png',
		'images/image5.png',
		'images/image6.png',
		'images/image7.png',
		'images/image8.png',
		'images/image9.png',
		'images/image10.png',
		'images/image11.png',
		'images/image11.png',
		'images/image12.png',
		'images/image13.png',
		'images/image13.png',
		'images/image13.png',
		'images/image13.png'
		];
		
		function addanotherdivloader1(){
			
			function addButtonToDiv() {
				
				var container = document.getElementById('loadingDiv2');
				var myDiv = document.getElementById('myDiv_tutorial');
				//var myDiv = document.createElement('div');
				var button = document.createElement('button');
				
				function firstFunction123() {
					return new Promise(resolve => {
						setTimeout(() => {
						
						
						//myDiv.id = 'myDiv_tutorial';
						//myDiv.classList.add('solid_back');
						// Create a button element
						
						//console.log('button',button)
						// Set button text and attributes
						button.textContent = 'Click Me';
						button.classList.add('default-btn');
						button.id = 'myButton12'; // Set a specific ID for the button if needed
						button.addEventListener('click', function() {
							
							$("#myDiv_tutorial").fadeOut(500, function() {
							  // fadeOut complete. Remove the loading div
							$("#myDiv_tutorial").remove(); //makes page more lightweight 
							});
							//alert('Button Clicked!');
						});
						
						console.log('First function');
						resolve();
						}, 1000); // Simulating an asynchronous operation with a timeout
					});
				}
				
				function secondFunction123() {
					return new Promise(resolve => {
						setTimeout(() => {
						
						myDiv.appendChild(button);
						container.appendChild(myDiv);
						
						console.log('Second function');
						resolve();
						}, 1000); // Simulating an asynchronous operation with a timeout
					});
				}
				
				//myDiv.textContent = 'This is a dynamically created div!';
				async function callFunctionsInSequence123() {
				await firstFunction123();
				await secondFunction123();
				}
				// Call the async function
				callFunctionsInSequence123();
			}
			
			//addButtonToDiv();

			function thirdFunction_tutorial() {
				return new Promise(resolve => {
					setTimeout(() => {
					
					//addButtonToDiv();
					$("#typing-text").fadeOut(500, function() {
					  // fadeOut complete. Remove the loading div
					$("#typing-text").remove(); //makes page more lightweight 
					});
					
					console.log('Third function');
					resolve();
					}, 5500); // Simulating an asynchronous operation with a timeout
				});
			}

			function fourthFunction_tutorial() {
				return new Promise(resolve => {
					setTimeout(() => {
					
					$("#myDiv_tutorial").fadeOut(500, function() {
					  // fadeOut complete. Remove the loading div
					$("#myDiv_tutorial").remove(); //makes page more lightweight 
					});
					
					console.log('Third function');
					resolve();
					}, 110000); // Simulating an asynchronous operation with a timeout
				});
			}
		
			function firstFunction_tutorial() {
				return new Promise(resolve => {
					setTimeout(() => {
						
					var picIndex = 0
					var myDiv = document.getElementById('myDiv_tutorial');	
					myDiv.classList.add('solid_back');
					myDiv.style.zIndex = 1;
					myDiv.style.width = '100%';
					myDiv.style.height = '100%';
					myDiv.style.top = '0px';
					myDiv.style.left = '0px';
					myDiv.style.backgroundPosition = 'center'; /* Adjust as needed: 'center', 'top', 'left', etc. */
					myDiv.style.backgroundRepeat = 'no-repeat'; /* Prevent image from repeating */
					myDiv.style.position = 'absolute';
					myDiv.style.backgroundSize = '100%'
					myDiv.style.backgroundImageheight = 'auto'
						
					function changeBackgroundImage() {
						myDiv.style.backgroundImage = `url('${imageUrls[picIndex]}')`;
						picIndex++
					}
						
					// Initial background image change
					changeBackgroundImage();
					
					// Change the background image every 5000 milliseconds (5 seconds)
					if(picIndex<imageUrls.length-1){
						setInterval(changeBackgroundImage, 6000);
					}
					else{
					}
					
					console.log('First function');
					resolve();
					}, 50); // Simulating an asynchronous operation with a timeout
				});
			}
			
			function secondFunction_tutorial() {
				return new Promise(resolve => {
					setTimeout(() => {
			
					// Text to be displayed
					var textToType = "Welcome to MINNO tutorial. \n\n This is a quick animated tutorial reviewing the functionality of the tool. \n\n Please pay attention. ";

					// Index to track the current position in the text
					var currentIndex = 0;

					// Reference to the typing text div
					var typingTextElement = document.getElementById('typing-text');
					
					//typingTextElement.classList.add('typing-text');
					typingTextElement.style.fontFamily = 'monospace';
					typingTextElement.style.fontSize = '2.5em';
					typingTextElement.style.animation = 'typing 3s steps(40) infinite';
					typingTextElement.style.overflow = 'hidden';

					var count = 0

					// Interval function to simulate typing effect
					var typingInterval = setInterval(function() {
						// Check if there are more characters to type
						if (currentIndex < textToType.length) {
							// Append the next character to the typing text
							typingTextElement.innerHTML += textToType.charAt(currentIndex);

							// If the character is a line break, create a new paragraph
							if (textToType.charAt(currentIndex) === '\n') {
								typingTextElement.innerHTML += '<p>';
								count++
							}

							//var myParagraph = document.querySelector('p'); // You can use other methods to select the paragraph

							// Assign a dynamic ID to the paragraph
							//myParagraph.setAttribute('id', 'para1');

							currentIndex++;
						} else {
							// Stop the interval once all characters are typed
							clearInterval(typingInterval);
						}
					}, 40); // Adjust the interval time as needed
				
				console.log('Second function');
					resolve();
					}, 50); // Simulating an asynchronous operation with a timeout
				});
			}
			
			//myDiv.textContent = 'This is a dynamically created div!';
			async function callFunctionsInSequence_tutorial() {
			await firstFunction_tutorial();
			await secondFunction_tutorial();
			await thirdFunction_tutorial();
			await fourthFunction_tutorial();
			console.log("Done")
			}

			// Call the async function
			callFunctionsInSequence_tutorial();
			
		}
		
		function addanotherdivloader2(){
			
			function addButtonToDiv() {
				
				var container = document.getElementById('loadingDiv2');
				var myDiv = document.getElementById('myDiv_loadfiles');
				var myDiv2 = document.getElementById('loadfilediv1');
				var myDiv3 = document.getElementById('loadfilediv2');
				var myDiv4 = document.getElementById('loadfilediv3');
				
				var mytextDiv1 = document.getElementById('fileNameDisplay1');
				var mytextDiv2 = document.getElementById('fileNameDisplay2');
				
				console.log('myDiv',myDiv)
				//var myDiv = document.createElement('div');
				var button1 = document.createElement('button');
				var button12 = document.createElement('button');
				var button2 = document.createElement('button');
				var button22 = document.createElement('button');
				var button3 = document.createElement('button');
				
				//var myDiv = document.getElementById('myDiv_loadfiles');	
				myDiv.classList.add('dropmenu_div_container');
				myDiv2.classList.add('dropmenu_div_container2');
				myDiv3.classList.add('dropmenu_div_container2');
				myDiv4.classList.add('dropmenu_div_container2');
				mytextDiv1.classList.add('dropmenu_div_container3');
				mytextDiv2.classList.add('dropmenu_div_container3');
				
				myDiv2.style.position = 'absolute';
				myDiv2.style.width = '90%';
				myDiv2.style.height = '20px';
				myDiv2.style.top = '0px';
				myDiv2.style.left = '50px';
				
				myDiv3.style.position = 'absolute';
				myDiv3.style.width = '90%';
				myDiv3.style.height = '20px';
				myDiv3.style.top = '100px';
				myDiv3.style.left = '50px';
				
				myDiv4.style.position = 'absolute';
				myDiv4.style.width = '90%';
				myDiv4.style.height = '20px';
				myDiv4.style.top = '300px';
				myDiv4.style.left = '500px';
				
				mytextDiv1.style.position = 'absolute';
				mytextDiv1.style.width = '40%';
				mytextDiv1.style.height = '20px';
				mytextDiv1.style.top = '90px';
				mytextDiv1.style.left = '700px';
				
				mytextDiv2.style.position = 'absolute';
				mytextDiv2.style.width = '50%';
				mytextDiv2.style.height = '20px';
				mytextDiv2.style.top = '120px';
				mytextDiv2.style.left = '700px';
				
				
				//myDiv.classList.add('solid_back');
				myDiv.style.zIndex = 2;
				myDiv.style.position = 'absolute';
				myDiv.style.width = '100%';
				myDiv.style.height = '100%';
				myDiv.style.top = '0px';
				myDiv.style.left = '0px';
				myDiv.style.backgroundColor = 'rgba(255, 255, 255, 1.0)';
				//myDiv.style.width = '100%';
				//myDiv.style.height = '100%';
				//myDiv.style.top = '0px';
				//myDiv.style.left = '0px';
				
				// Create a new heading element
				var heading1 = document.createElement("h1");
				var heading2 = document.createElement("h1");
				
				function firstFunction123() {
						return new Promise(resolve => {
							setTimeout(() => {
							
							//myDiv.id = 'myDiv_tutorial';
							//myDiv.classList.add('solid_back');
							// Create a button element
							
							//console.log('button',button)
							// Set button text and attributes
							
							// Set the text content of the heading
							heading1.textContent = "Load Network files:";
							
							button1.textContent = 'Load file';
							button1.classList.add('default-btn');
							button1.id = 'myButton1'; // Set a specific ID for the button if needed
							button1.addEventListener('click', function() {
								var uploadfile = document.getElementById("networkfileInput").click();
								//alert('Button Clicked!');
							});

							button12.textContent = 'Download sample file';
							button12.classList.add('default-btn');
							button12.id = 'myButton12'; // Set a specific ID for the button if needed
							button12.addEventListener('click', function() {
								const filePath = 'Edited_ortholog_networks/Arginine biosynthesis.json';
								
								// Fetch the file
								fetch(filePath)
									.then(response => response.json())
									.then(data => {
										// Create a blob from the JSON data
										const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });

										// Create a link element
										const a = document.createElement('a');

										// Set the href attribute with the blob data
										a.href = window.URL.createObjectURL(blob);

										// Set the download attribute with the desired file name
										a.download = 'Arginine_biosynthesis_pathway.json';

										// Append the link to the body
										document.body.appendChild(a);

										// Trigger a click event on the link
										a.click();

										// Remove the link from the body
										document.body.removeChild(a);
									})
									.catch(error => console.error('Error fetching file:', error));

							});
							
							
							// Set the text content of the heading
							heading2.textContent = "Load Data files:";
							
							button2.textContent = 'Load file';
							button2.classList.add('default-btn');
							button2.id = 'myButton2'; // Set a specific ID for the button if needed
							button2.addEventListener('click', function() {
								var uploadfile = document.getElementById("meta_file2").click();
							});

							button22.textContent = 'Download sample file';
							button22.classList.add('default-btn');
							button22.id = 'myButton22'; // Set a specific ID for the button if needed
							button22.addEventListener('click', function() {
								const filePath = '2022_07_15_MINNO_Supplemental_Sample_Data3.csv';

								// Create a link element
								const a = document.createElement('a');

								// Set the href attribute with the file path
								a.href = filePath;

								// Set the download attribute with the desired file name
								a.download = 'Arginine_biosynthesis_sample_data_file.csv';

								// Append the link to the body
								document.body.appendChild(a);

								// Trigger a click event on the link
								a.click();

								// Remove the link from the body
								document.body.removeChild(a);
							});
							
							button3.textContent = 'Finish';
							button3.classList.add('default-btn');
							button3.id = 'myButton3'; // Set a specific ID for the button if needed
							button3.addEventListener('click', function() {
								
								$("#myDiv_loadfiles").fadeOut(500, function() {
								  // fadeOut complete. Remove the loading div
								$("#myDiv_loadfiles").remove(); //makes page more lightweight 
								});
								
								$("#loadingDiv2").fadeOut(500, function() {
								  // fadeOut complete. Remove the loading div
								$("#loadingDiv2").remove(); //makes page more lightweight 
								});
								//alert('Button Clicked!');
							});
							
							console.log('First function');
							resolve();
							}, 200); // Simulating an asynchronous operation with a timeout
						});
				}
				
				function secondFunction123() {
						return new Promise(resolve => {
							setTimeout(() => {
							myDiv2.appendChild(heading1);
							myDiv2.appendChild(button1);
							myDiv2.appendChild(button12);
							myDiv3.appendChild(heading2);
							myDiv3.appendChild(button2);
							myDiv3.appendChild(button22);
							myDiv4.appendChild(button3);
							//container.appendChild(myDiv);
							
							console.log('Second function');
							resolve();
							}, 200); // Simulating an asynchronous operation with a timeout
						});
					}
				
				//myDiv.textContent = 'This is a dynamically created div!';
				async function callFunctionsInSequence123() {
				await firstFunction123();
				await secondFunction123();
				}
				// Call the async function
				callFunctionsInSequence123();
			}
			
			//addButtonToDiv();

			function thirdFunction_tutorial() {
				return new Promise(resolve => {
					setTimeout(() => {
					
					addButtonToDiv();
					
					console.log('Third function');
					resolve();
					}, 100); // Simulating an asynchronous operation with a timeout
				});
			}
		
			//myDiv.textContent = 'This is a dynamically created div!';
			async function callFunctionsInSequence_tutorial() {
			//await firstFunction_tutorial();
			//await secondFunction_tutorial();
			await thirdFunction_tutorial();
			console.log("DOne")
			}

			// Call the async function
			callFunctionsInSequence_tutorial();
			
		}

		var species_genes_list = [];

		function ncbi_gene_annotation_url(url){
			
			fetch(url)  // Replace 'file.gz' with the actual path to your Gzip file
			  .then(response => {
				if (!response.ok) {
				  throw new Error('Network response was not ok.');
				}
				return response.body;  // Get the response body as a ReadableStream
			  })
			  .then(stream => {
				const decompressionStream = new DecompressionStream('gzip');
				const readableStream = stream.pipeThrough(decompressionStream);

				const reader = readableStream.getReader();
				const decoder = new TextDecoder('utf-8');
				let result = '';

				function read() {
				  reader.read().then(({ done, value }) => {
					if (done) {
						
						// Split the content into lines
						const lines = result.split('\n');
						
						// Initialize an object to store key-value pairs
						const keyValuePairs = {};
						
						const nlines = lines.length;
						
						lines.slice(10,nlines).forEach(function(line){
							var elems = line.split('\t');
							if (elems.length > 8) {
								var subElems = elems[8].split(';');
								subElems.forEach(function (v) {
									if (v.indexOf('Name') == 0 && v.indexOf('LOC') == -1 && v.indexOf('WP') == -1 && v.indexOf('XM') == -1 && v.indexOf('Unknown') == -1 && v.indexOf('XR') == -1 && v.indexOf('XP') == -1 && v.indexOf('RS') == -1 && v.indexOf('_') == -1 && v.indexOf('ACA') == -1) {
										species_genes_list.push(v.slice(5));
									}
								});
							}
						});
						//console.log('species_genes_list',species_genes_list)
					} else {
					  result += decoder.decode(value, { stream: true });
					  read();
					}
				  });
				}

				read();
			  })
			  .catch(error => {
				console.error('There was a problem with the fetch operation:', error);
			  });
			
		}

		function findMatchingElements(arr1, arr2) {
			return arr1.filter(element => arr2.indexOf(element) !== -1);
		}
		
		var kegg_ids = [], kegg_genes = [];
		var kegg_gene_lst = {'kegg_id':kegg_ids, 'kegg_gene':kegg_genes};

		function firstFunction_kegg_gene(){
			return new Promise(resolve => {
				setTimeout(() => {
	
				const logFileText4 = async file => {
					const response = await fetch(file)
					const data = await response.text()
					const lines = data.split('\n');
				    let i = 0;
				
				    for (const line of lines) {
					i++;
				
					if (i > 0 && i < 11400000) {
					    const strg = line.trim();
				
					    try {
						const info = strg.split('\t')[1].split(';')[0];
						const info1 = strg.split('\t')[0];
				
						if (info.includes(',')) {
						    const refine_info = info.split(',');
				
						    for (const y of refine_info) {
							kegg_genes.push(y.replace(' ', ''));
							kegg_ids.push(info1);
						    }
						} else {
						    kegg_genes.push(info);
						    kegg_ids.push(info1);
						}
					    } catch (error) {
						console.error('Skipped');
					    }
					}
				    }
				}
	
				logFileText4('Edited_ortholog_networks/ko_genes.txt')
					
				resolve();
				}, 1000); // Simulating an asynchronous operation with a timeout
			});
		}
		
		function secondFunction_kegg_gene(){
			return new Promise(resolve => {
				setTimeout(() => {
				
					kegg_gene_lst = {'kegg_id':kegg_ids, 'kegg_gene':kegg_genes};
					console.log('kegg_gene_lst',kegg_gene_lst)
				
				resolve();
				}, 1000); // Simulating an asynchronous operation with a timeout
			});
		}
		
		async function callFunctionsInSequence_kegg_gene() {
			await firstFunction_kegg_gene();
			await secondFunction_kegg_gene();
		}
		// Call the async function
		callFunctionsInSequence_kegg_gene();
		
		function addanotherdivloader3(){
			
			var ncbi_category = "undefined";
	
			function addTopButtonsToDiv() {
				
				var container = document.getElementById('loadingDiv2');
				var myDiv = document.getElementById('myDiv_buildnet');
				
				//console.log('myDiv',myDiv)
				//var myDiv = document.createElement('div');
				var button1 = document.createElement('button');
				var button2 = document.createElement('button');
				
				//var myDiv = document.getElementById('myDiv_loadfiles');	
				myDiv.classList.add('btn_div_container');
				
				//myDiv.classList.add('solid_back');
				myDiv.style.zIndex = 2;
				myDiv.style.position = 'absolute';
				myDiv.style.width = '100%';
				//myDiv.style.height = '100%';
				myDiv.style.top = '0px';
				myDiv.style.left = '0px';
				myDiv.style.backgroundColor = 'rgba(255, 255, 255, 1.0)';
				//myDiv.style.width = '100%';
				//myDiv.style.height = '100%';
				//myDiv.style.top = '0px';
				//myDiv.style.left = '0px';
				
				
				function read_url_ncbi_species(value){
					
					var value1 = value.concat('/')
					
					var url = prefix_url.concat(value1)
					//console.log(url)
					
					//var url = 'https://ftp.ncbi.nlm.nih.gov/genomes/refseq/archaea/'

					fetch(url)
						.then(response => response.text())
						.then(html => {
					// Create a temporary container to parse the HTML
					const container = document.createElement('div');
					container.innerHTML = html;

					// Get all anchor tags (hyperlinks)
					const links = container.querySelectorAll('a');
					// Loop through each link and print its href attribute

					var drop_menu_1_data = []
					drop_menu_1_data.push({'label':'Select Species','value':'Select Species'})
					
					var nlinks = links.length;
					
					links.forEach(function(link,i){
						let linkarr = link.href.split('/');
						let lastele = linkarr.pop();
						let seclastele = linkarr.pop();
						
						if (i>0 && i<links.length-4){
							drop_menu_1_data.push({'label':seclastele,'value':seclastele})
						}
					});

					$('#drop_menu_1').multiselect('dataprovider', drop_menu_1_data);

					const logFileText3 = async file => {
						var KEGG_models = [];
						const response = await fetch(file)
						const text = await response.text()
						var childNodes = [];
						//childNodes.push({'label':'Organism specific list of pathways','value':'org_pathway_lst'})
						text.split("\n").forEach(function(str){
							let list = str.split(".json")
							childNodes.push({'label':list[0],'value':list[0]})
						});
						KEGG_models.push({'label':'Selected ortholog maps','children':childNodes})
						//console.log('KEGG_models',KEGG_models)
						$('#KEGG_orth_models').multiselect('dataprovider', KEGG_models); 
						//console.log("KEGG_models",KEGG_models)

					}

					logFileText3('Edited_ortholog_networks/ortholog_pathway_list.txt')

					})
					.catch(error => console.error('Error fetching data:', error));
				}		
				
				function ncbi_button_action(ncbi_btn){
					// Retrieve the button's value and log it to the console
					var buttonValue = ncbi_btn.value;
					read_url_ncbi_species(buttonValue);
					//console.log('Button value:', buttonValue);
				  
					var hiddenDiv1 = document.getElementById('speciesloadingIcon');
					hiddenDiv1.style.display = 'block';
					var hiddenDiv2 = document.getElementById('species_loading_h1_id');
					hiddenDiv2.style.display = 'block';
					ncbi_category = buttonValue
					
				}

				function ncbi_bacteria_action(ncbi_btn){
					// Retrieve the button's value and log it to the console
					var buttonValue = ncbi_btn.value;

					var logFileText1 = async file => {
						const response = await fetch(file)
						const text = await response.text()
						
						var drop_menu_1_data = []
						drop_menu_1_data.push({'label':'Select Species','value':'Select Species'})
						
						text.split("\n").forEach(function(str){
							let list = str.split("/")
							drop_menu_1_data.push({'label':list[0],'value':list[0]})
						});

						$('#drop_menu_1').multiselect('dataprovider', drop_menu_1_data);
					}
					
					logFileText1('Edited_ortholog_networks/bacteria_ncbi_list_4_minno.txt')
					
					var logFileText2 = async file => {
						var KEGG_models = [];
						const response = await fetch(file)
						const text = await response.text()
						var childNodes = [];
						//childNodes.push({'label':'Organism specific list of pathways','value':'org_pathway_lst'})
						text.split("\n").forEach(function(str){
							let list = str.split(".json")
							childNodes.push({'label':list[0],'value':list[0]})
						});
						KEGG_models.push({'label':'Selected ortholog maps','children':childNodes})
						//console.log('KEGG_models',KEGG_models)
						$('#KEGG_orth_models').multiselect('dataprovider', KEGG_models); 
						//console.log("KEGG_models",KEGG_models)

					}

					logFileText2('Edited_ortholog_networks/ortholog_pathway_list.txt')
				  
					var hiddenDiv1 = document.getElementById('speciesloadingIcon');
					hiddenDiv1.style.display = 'block';
					var hiddenDiv2 = document.getElementById('species_loading_h1_id');
					hiddenDiv2.style.display = 'block';
					ncbi_category = buttonValue
				}

				function hideLoadingIcon() {
					var loadingIcon = document.getElementById("speciesloadingIcon");
					var loadingIcon2 = document.getElementById("species_loading_h1_id");
					loadingIcon.style.display = 'none';
					loadingIcon2.style.display = 'none';
					
					var hiddenDiv1 = document.getElementById('dropmenu_species_div_container_id1');
					hiddenDiv1.style.display = 'flex';
					var hiddenDiv2 = document.getElementById('dropmenu_pathways_div_container_id2');
					hiddenDiv2.style.display = 'flex';
					var hiddenDiv3 = document.getElementById('dropmenu_pathways_div_container_id3');
					hiddenDiv3.style.display = 'flex';
					var hiddenDiv4 = document.getElementById('dropmenu_pathways_div_container_id4');
					hiddenDiv4.style.display = 'flex';
					var hiddenDiv4 = document.getElementById('dropmenu_pathways_div_container_id5');
					hiddenDiv4.style.display = 'flex';
				}

				function firstFunction123() {
					return new Promise(resolve => {
						setTimeout(() => {
						
						//myDiv.id = 'myDiv_tutorial';
						//myDiv.classList.add('solid_back');
						// Create a button element
						
						//console.log('button',button)
						// Set button text and attributes
						
						button1.textContent = 'Archaea';
						button1.classList.add('default-btn');
						button1.id = 'Archaea'; // Set a specific ID for the button if needed
						button1.value = 'archaea'; // Set a specific ID for the button if needed
						button1.addEventListener('click', function() {									
							let ncbi_btn1 = document.getElementById('Archaea');
							ncbi_button_action(ncbi_btn1);
							//console.log('ncbi_btn1',ncbi_btn1)
							// Set a timeout (e.g., 3000 milliseconds) to hide the loading icon
							setTimeout(hideLoadingIcon, 60000); // Adjust the duration as needed
						});
						
						button2.textContent = 'Bacteria';
						button2.classList.add('default-btn');
						button2.id = 'Bacteria'; // Set a specific ID for the button if needed
						button2.value = 'bacteria'; // Set a specific ID for the button if needed
						button2.addEventListener('click', function() {
							let ncbi_btn2 = document.getElementById('Bacteria');
							ncbi_bacteria_action(ncbi_btn2);
							// Set a timeout (e.g., 3000 milliseconds) to hide the loading icon
							setTimeout(hideLoadingIcon, 60000); // Adjust the duration as needed
						});
						
						console.log('First function');
						resolve();
						}, 200); // Simulating an asynchronous operation with a timeout
					});
				}
					
				function secondFunction123(){
					return new Promise(resolve => {
						setTimeout(() => {
						myDiv.appendChild(button1);
						myDiv.appendChild(button2);
						//myDiv.appendChild(button3);
						//container.appendChild(myDiv);
						
						console.log('Second function');
						resolve();
						}, 200); // Simulating an asynchronous operation with a timeout
					});
				}
				
				//myDiv.textContent = 'This is a dynamically created div!';
				async function callFunctionsInSequence123() {
				await firstFunction123();
				await secondFunction123();
				}
				// Call the async function
				callFunctionsInSequence123();
				}
				
				//addButtonToDiv();
				
				

				function firstFunction_build() {
					return new Promise(resolve => {
						setTimeout(() => {
						
						addTopButtonsToDiv();

						$("#typing-text").fadeOut(500, function() {
						  // fadeOut complete. Remove the loading div
						$("#typing-text").remove(); //makes page more lightweight 
						});
						
						$("#myDiv_tutorial").fadeOut(500, function() {
						  // fadeOut complete. Remove the loading div
						$("#myDiv_tutorial").remove(); //makes page more lightweight 
						});
						
						console.log('Third function');
						resolve();
						}, 100); // Simulating an asynchronous operation with a timeout
					});
				}
				
				function secondFunction_build() {
					return new Promise(resolve => {
						setTimeout(() => {
						
						var on_species_changed = function(){
							var value = d3.select('#drop_menu_1').node().selectedOptions[0].value;
							
							var species = value.concat('/')
							var ncbi_cat = ncbi_category.concat('/')
							console.log(value)
							console.log(ncbi_category)
							var url = prefix_url.concat(ncbi_cat).concat(species).concat('representative/')
							//console.log(url)
							
							fetch(url)
								.then(response => response.text())
								.then(html => {
							// Create a temporary container to parse the HTML
							const container = document.createElement('div');
							container.innerHTML = html;
	
							// Get all anchor tags (hyperlinks)
							const links = container.querySelectorAll('a');
	
							// Loop through each link and print its href attribute
	
							//links.forEach(function(link,i){
								let linkarr = links[1].href.split('/');
								let lastele = linkarr.pop();
								let seclastele = linkarr.pop();
	
								//if (i>0 && i<links.length-1){
									//console.log(seclastele)
									var mod_url = url.concat(seclastele).concat('/').concat(seclastele).concat('_genomic.gff.gz')
									ncbi_gene_annotation_url(mod_url)
								//}
							//});

						})
						.catch(error => console.error('Error fetching data:', error));
							
					}	
							
					var on_KEGG_orth_models_changed = function(){
						var value = d3.select('#KEGG_orth_models').node().selectedOptions[0].value;
						console.log(value)				
					}			
					
					$('#drop_menu_1').multiselect({
									buttonWidth: '300px',
									multiple: false,
									maxHeight: 250,
									enableClickableOptGroups: true,
									enableCollapsibleOptGroups: true,
									collapseOptGroupsByDefault: true,
									enableFiltering: true,
									enableCaseInsensitiveFiltering: false,
									filterPlaceholder: 'Cerca',
									includeSelectAllOption: false,
									selectAllJustVisible: false,
									selectAllText: 'Select All',
									nSelectedText: ' selected',
									allSelectedText: 'All selected',
									nonSelectedText: 'Select Species',
									onChange: on_species_changed,
									onSelectAll: on_species_changed,
									onDeselectAll: on_species_changed
								});
								
					$('#KEGG_orth_models').multiselect({
									buttonWidth: '300px',
									multiple: true,
									maxHeight: 250,
									enableClickableOptGroups: true,
									enableCollapsibleOptGroups: true,
									collapseOptGroupsByDefault: true,
									enableFiltering: true,
									enableCaseInsensitiveFiltering: false,
									filterPlaceholder: 'Cerca',
									includeSelectAllOption: false,
									selectAllJustVisible: false,
									selectAllText: 'Select All',
									nSelectedText: ' selected',
									allSelectedText: 'All selected',
									nonSelectedText: 'Select Pathways',
									onChange: on_KEGG_orth_models_changed,
									onSelectAll: on_KEGG_orth_models_changed,
									onDeselectAll: on_KEGG_orth_models_changed
								});
				
						
						console.log('Third function');
						resolve();
						}, 100); // Simulating an asynchronous operation with a timeout
					});
				}
			
				//myDiv.textContent = 'This is a dynamically created div!';
				async function callFunctionsInSequence_build() {
					await firstFunction_build();
					await secondFunction_build();
					//await thirdFunction_tutorial();
					console.log("Done")
				}

				// Call the async function
				callFunctionsInSequence_build();
				
				
				function addButtonToDiv() {
					
					var container = document.getElementById('loadingDiv2');
					var myDiv = document.getElementById('dropmenu_pathways_div_container_id3');
					var myDiv1 = document.getElementById('dropmenu_pathways_div_container_id4');
					var myDiv2 = document.getElementById('dropmenu_pathways_div_container_id5');
					
					var mytextDiv1 = document.getElementById('datafilename1');
					
					var button1 = document.createElement('button');
					var button2 = document.createElement('button');
					var button3 = document.createElement('button');
					
					mytextDiv1.classList.add('dropmenu_div_container3');
					
					mytextDiv1.style.position = 'absolute';
					mytextDiv1.style.width = '40%';
					mytextDiv1.style.height = '20px';
					mytextDiv1.style.top = '90px';
					mytextDiv1.style.left = '700px';
					
					// Create a new heading element
					var heading1 = document.createElement("h1");
					
					function firstFunction123() {
						return new Promise(resolve => {
							setTimeout(() => {
							
							//myDiv.id = 'myDiv_tutorial';
							//myDiv.classList.add('solid_back');
							// Create a button element
							
							//console.log('button',button)
							// Set button text and attributes
							
							button1.textContent = 'Build Network';
							button1.classList.add('default-btn');
							button1.id = 'myButton1_build'; // Set a specific ID for the button if needed
							button1.addEventListener('click', function() {
								var selected_options = [];
								
								var ref = d3.select('#KEGG_orth_models').node().selectedOptions;
								
								for (var i = 0; i<ref.length; i++) {
									selected_options.push(ref[i]);
								};
								
								//settings = false;
								
								var nodeslst = [], nodeslst1 = [], nodeslst2 = [];
								var linkslst = [], linkslst1 = [], linkslst2 = [];
								var xcorlst = [];
								var ycorlst = [];
					
								var gene_indexs = [];
								//console.log('species_genes_list',species_genes_list)
								species_genes_list.forEach(function(g,i){
									if (kegg_gene_lst['kegg_gene'].indexOf(g)!=-1){
										//console.log()
										gene_indexs.push(kegg_gene_lst['kegg_gene'].indexOf(g))
									}
								})
								//console.log("gene_indexs",gene_indexs)
								var species_rxnids = [];
								
								gene_indexs.forEach(function(i){
									species_rxnids.push(kegg_gene_lst['kegg_id'][i])
								})

								const fileUrls = selected_options;
					
								async function processFilesSequentially(fileUrls) {
									let nofrows = Math.floor(Math.sqrt(fileUrls.length))	
									let npr = Math.floor(fileUrls.length/nofrows)	
									console.log('npr',npr)					
									console.log('nofrows',nofrows)	
									
									var ymax = -100000000000000000;
									var ycorlst = [];
													
									for(let i=0; i<nofrows; i++){
										
										var xcorlst = [];
										
										var xmax = -100000000000000000;
										
										//for (const fileUrl of fileUrls) {
										if(i==0){
											for(let j=0; j<npr; j++){
												let fileUrl = fileUrls[npr*i+j]
												ymax = await processFile(fileUrl,j,i,npr*i+j,xcorlst,ycorlst,ymax);
												//console.log(Math.floor(Math.sqrt(2.6)))
											}
										}
										else if(i<nofrows-1){
											for(let j=0; j<npr; j++){
												let fileUrl = fileUrls[i*npr+j]
												ymax = await processFile(fileUrl,j,i,npr*i+j,xcorlst,ycorlst,ymax);
											}
										}
										else{
											if(fileUrls.length> npr*nofrows){
												for(let j=0; j<(fileUrls.length-i*nofrows); j++){
													let fileUrl = fileUrls[i*npr+j]
													ymax = await processFile(fileUrl,j,i,npr*i+j,xcorlst,ycorlst,ymax);
												}
											}
											else{
												for(let j=0; j<npr; j++){
													let fileUrl = fileUrls[i*npr+j]
													ymax = await processFile(fileUrl,j,i,npr*i+j,xcorlst,ycorlst,ymax);
												}
											}
										}
									}
								}

								async function processFile(fileUrl,i,chrow,fileno,xcorlst,ycorlst,ymax) {
								  return new Promise((resolve, reject) => {
									// Simulating an asynchronous operation, such as loading a file
									setTimeout(() => {
										console.log('fileno',fileno)
										console.log('species_kegg_gene_lst',species_rxnids)
										if(i==0){
											if(xcorlst.length>0){
												xmax = xcorlst.reduce((max, current) => (current > max ? current : max), xcorlst[0])//Math.max(xcorlst)
												console.log('xmax',xmax)
											}
											if(ycorlst.length>0){
												ymax = ycorlst.reduce((max, current) => (current > max ? current : max), ycorlst[0])
												console.log('ymax',ymax)
											}
											//console.log(fileUrl)

											var logFileText1 = async file => {
												const response = await fetch(file)
												const text = await response.text()
												var d_jsonobj = JSON.parse(text)
												
												d_jsonobj["nodes"].forEach(function(n){
													n.id = n.id + "_" + fileno
													if(chrow>0){
														n.y = n.y + 50.0 + ymax
													}
													else{
													}
													nodeslst.push(n)
													//console.log(n.x)
													xcorlst.push(n.x)
													ycorlst.push(n.y)
												})
												d_jsonobj["links"].forEach(function(n){
													n.id = n.id + "_"+fileno
													n.source = n.source + "_" + fileno
													n.target = n.target + "_" + fileno
													linkslst.push(n)
												})
												var rxnids = [];
												nodeslst.forEach(function(d){
													if(d.type=="R"){
														var rxn_genes = d.gene_link.split('?')[1].split("+")
														var matching_genes = findMatchingElements(species_rxnids, rxn_genes);
														if(matching_genes.length>0){
															rxnids.push(d.kegg_id)
															d.opacity = 1.0;
															nodeslst1.push(d)
														}
														else{
															d.opacity = 0.5;
															nodeslst1.push(d)
														}
													}
													else{
														d.opacity = 0.5;
														nodeslst1.push(d)
													}
												});
												//console.log('nodeslst1',nodeslst1)
												var meta_ids = [];
												linkslst.forEach(function(l){
													if(rxnids.includes(l.kegg_id)){
														l.opacity = 1.0;
														//console.log("found1")
														linkslst1.push(l)
														meta_ids.push(l.source)
														meta_ids.push(l.target)
													}
													else{
														l.opacity = 0.25;
														linkslst1.push(l)
													}
												});

												nodeslst1.forEach(function(d){
													if(d.type=="M"){
														if(meta_ids.includes(d.id)){
															d.opacity = 1.0;
															nodeslst2.push(d)
														}
														else{
															//d.opacity = 1.0;
															nodeslst2.push(d)
														}
													}
													else{
														nodeslst2.push(d)
													}
												});
												//console.log('nodeslst2',nodeslst2)

												linkslst1.forEach(function(l){
													linkslst2.push(l)
												});
											}
											
											logFileText1('Edited_ortholog_networks/'+fileUrl.value+'.json')
											
											xmax = xcorlst.reduce((max, current) => (current > max ? current : max), xcorlst[0])
											ymax = ycorlst.reduce((max, current) => (current > max ? current : max), ycorlst[0])
											
											//console.log(`Processed file: ${fileUrl.value}`);
										}
										else{
											//xmax = xcorlst.reduce((max, current) => (current > max ? current : max), xcorlst[0])
											ymax = ycorlst.reduce((max, current) => (current > max ? current : max), ycorlst[0])

											var logFileText1 = async file => {
												const response = await fetch(file)
												const text = await response.text()
												var d_jsonobj = JSON.parse(text)
												
												d_jsonobj["nodes"].forEach(function(n){
													n.id = n.id + "_" + fileno
													n.x = n.x + 50.0 + xmax
													if(chrow>0){
														n.y = n.y + 50.0 + ymax
													}
													else{
													}
													nodeslst.push(n)
													xcorlst.push(n.x)
													ycorlst.push(n.y)
												})
												d_jsonobj["links"].forEach(function(n){
													n.id = n.id + "_" + fileno
													n.source = n.source + "_" + fileno
													n.target = n.target + "_" + fileno
													linkslst.push(n)
												})
												var rxnids = [];
												nodeslst.forEach(function(d){
													if(d.type=="R"){
														var rxn_genes = d.gene_link.split('?')[1].split("+")
														var matching_genes = findMatchingElements(species_rxnids, rxn_genes);
														if(matching_genes.length>0){
															rxnids.push(d.kegg_id)
															d.opacity = 1.0;
															nodeslst1.push(d)
														}
														else{
															d.opacity = 0.5;
															nodeslst1.push(d)
														}
													}
													else{
														d.opacity = 0.5;
														nodeslst1.push(d)
													}
												});
												
												var meta_ids = [];
												linkslst.forEach(function(l){
													if(rxnids.includes(l.kegg_id)){
														l.opacity = 1.0;
														console.log("found1")
														linkslst1.push(l)
														meta_ids.push(l.source)
														meta_ids.push(l.target)
													}
													else{
														l.opacity = 0.25;
														linkslst1.push(l)
													}
												});

												nodeslst1.forEach(function(d){
													if(d.type=="M"){
														if(meta_ids.includes(d.id)){
															d.opacity = 1.0;
															nodeslst2.push(d)
														}
														else{
															//d.opacity = 1.0;
															nodeslst2.push(d)
														}
													}
													else{
														nodeslst2.push(d)
													}
												});

												linkslst1.forEach(function(l){
													linkslst2.push(l)
												});
											}
											
											logFileText1('Edited_ortholog_networks/'+fileUrl.value+'.json')

											xmax = xcorlst.reduce((max, current) => (current > max ? current : max), xcorlst[0])
											ymax = ycorlst.reduce((max, current) => (current > max ? current : max), ycorlst[0])
										}
										
										// Display the file name in a div
										var fileNameDisplay1 = document.getElementById("fileNameDisplay1");
										fileNameDisplay1.textContent = "Selected File: " + fileUrl.value;
										
									  console.log(`Processed file: ${fileUrl.value}`);
									  resolve();
									  return ymax
									}, 1000); // Simulated delay, adjust as needed
								  });
								}
								
								function secondFunction() {
									return new Promise(resolve => {
										setTimeout(() => {
										
										//console.log(nodeslst2)
										//console.log(linkslst2)
										
										jsonObj["nodes"] = nodeslst2
										jsonObj["links"] = linkslst2
										
										Main_visualization_code(jsonObj)
										Mainfunction(jsonObj)
										
										console.log('Second function');
										resolve();
										}, 1000); // Simulating an asynchronous operation with a timeout
									});
								}
								
								
								// Call the function and await its completion
								async function startProcessing() {
								  await processFilesSequentially(fileUrls);
								  console.log('All files processed.');
								  await secondFunction();
								}

								// Call the async function
								startProcessing();
							});
							
							// Set the text content of the heading
							heading1.textContent = "Load Data files:";
							
							button2.textContent = 'Load file';
							button2.classList.add('default-btn');
							button2.id = 'myButton2_build'; // Set a specific ID for the button if needed
							button2.addEventListener('click', function() {
								var uploadfile = document.getElementById("meta_file2").click();
								//alert('Button Clicked!');
							});

							button3.textContent = 'Finish';
							button3.classList.add('default-btn');
							button3.id = 'myButton3_bldnet'; // Set a specific ID for the button if needed
							button3.addEventListener('click', function() {
								
								$("#myDiv_loadfiles").fadeOut(500, function() {
								  // fadeOut complete. Remove the loading div
								$("#myDiv_loadfiles").remove(); //makes page more lightweight 
								});
								
								$("#loadingDiv2").fadeOut(500, function() {
								  // fadeOut complete. Remove the loading div
								$("#loadingDiv2").remove(); //makes page more lightweight 
								});
								//alert('Button Clicked!');
							});
							
							console.log('First function');
							resolve();
							}, 200); // Simulating an asynchronous operation with a timeout
						});
					}
					
					function secondFunction123() {
							return new Promise(resolve => {
								setTimeout(() => {
								myDiv.appendChild(button1);
								myDiv1.appendChild(heading1);
								myDiv1.appendChild(button2);
								myDiv2.appendChild(button3);
								
								console.log('Second function');
								resolve();
								}, 200); // Simulating an asynchronous operation with a timeout
							});
						}
					
					//myDiv.textContent = 'This is a dynamically created div!';
					async function callFunctionsInSequence123() {
					await firstFunction123();
					await secondFunction123();
					}
					// Call the async function
					callFunctionsInSequence123();
				}
				
				//addButtonToDiv();

				function thirdFunction_tutorial() {
					return new Promise(resolve => {
						setTimeout(() => {
						
						addButtonToDiv();
						
						console.log('Third function');
						resolve();
						}, 100); // Simulating an asynchronous operation with a timeout
					});
				}
			
				//myDiv.textContent = 'This is a dynamically created div!';
				async function callFunctionsInSequence_tutorial() {
				//await firstFunction_tutorial();
				//await secondFunction_tutorial();
				await thirdFunction_tutorial();
				console.log("Done")
				}

				// Call the async function
				callFunctionsInSequence_tutorial();
			
		}
			
		
	</script>
        
        <script>            
			
	var myVar, Bigg_models = [], KEGG_models = [], KEGG_orgs = [], kegg_rec = [], kegg_cpd = [];
	
	var alphaMIN = 0.98;
	
	var Zoomscale = 6.0;
	
	var zoomTrans = {x:0, y:0, scale:1};
	
	let currentZoom = 1.0// = d3.event.transform;
	
	var subsysgp, actualdata, finalupjsonobj_temp, nodedegobj, remelegp, repelegp;
			
	var jsonObj = {"nodes":[],"links":[],"labels":[],"boxes":[],"images":[]};
	
	var image_files;
            
	var keycode = 0;
	
	//var countloops = 0;
	
	// var duplicates = 0;
	
	var Curvature = 10;
    
	var acc_min = 100.0;
			
	var acc_max = 0.0;
	
	var no_of_grps = [];
			
	var mousedown_node = null, mouseup_node = null;
            
	var gBrush = null;
						
	var brushMode = false;
	
	var brushing = false;    
	
	var shiftKey;

	var dataset = true;

	var settings = false;	
	
	var bodyd3keyup = d3.select("body").on('keyup', keyup);
	
	var bodyd3keydown = d3.select("body").on('keydown', keydown);
			
	function myFunction() {

		function firstFunction1(_callback){
			// do some asynchronous work
			// and when the asynchronous stuff is complete
			function load_models(filename){ 
				
				const logFileText = async file => {
					const response = await fetch(file)
					const text = await response.text()
					var jsonparse = JSON.parse(text)
					
					Bigg_models.push({'label': 'BiGG Models','value': 'Models'})
					
					jsonparse['results'].forEach(function(str){
						Bigg_models.push({'label': str['bigg_id'],'value': str['bigg_id']})
					});
				
					$('#BiGG_models').multiselect('dataprovider', Bigg_models); 
					//console.log("KEGG_models",KEGG_models)
				}
				
				logFileText('BiGG_models/BiGG_models.json')
				
				
				/*
				fetch('http://bigg.ucsd.edu/api/v2/models')
				  .then(response => response.blob())
				  .then(blob => {
					const reader = new FileReader;
					reader.addEventListener('load', () => {	
					  var models_name = JSON.parse(reader.result)
					  Bigg_models.push({'label': 'BiGG Models','value': 'Models'})
					  for(let i=0; i<models_name.results_count; i++){
						  Bigg_models.push({'label': models_name.results[i]['bigg_id'],'value': models_name.results[i]['bigg_id']})
						}
						$('#BiGG_models').multiselect('dataprovider', Bigg_models); 
					});
					reader.readAsText(blob);
				  });
				*/
			}
			
			//window.onload = load_models;
			load_models();
			
			//console.log('1 is exe')
			_callback();    
		}
		
		function firstFunction2(_callback){
			// do some asynchronous work
			// and when the asynchronous stuff is complete
			var childNodes=[];
			childNodes.push({'label':'KEGG Database','value':'KEGG_database'})
			
			const logFileText1 = async file => {
				const response = await fetch(file)
				const text = await response.text()
				var childNodes = [];
				text.split("\n").forEach(function(str){
					let list = str.split("\t")
					//console.log(list)
					childNodes.push({'label':list[2],'value':list[1]})
				});
				KEGG_orgs.push({'label':'List of Organism','children':childNodes})
				//console.log(KEGG_orgs)
				$('#KEGG_orgs').multiselect('dataprovider', KEGG_orgs); 
			}
			
			const logFileText2 = async file => {
				const response = await fetch(file)
				const text = await response.text()
				var childNodes = [];
				childNodes.push({'label':'Organism specific list of pathways','value':'org_pathway_lst'})
				text.split("\n").forEach(function(str){
					let list = str.split("\t")
					childNodes.push({'label':list[1],'value':list[0]})
				});
				KEGG_models.push({'label':'List of Pathways','children':childNodes})
				$('#KEGG_models').multiselect('dataprovider', KEGG_models); 
				//console.log("KEGG_models",KEGG_models)
			}
			
			const logFileText3 = async file => {
				const response = await fetch(file)
				const text = await response.text()
				var childNodes = [];
				//childNodes.push({'label':'Organism specific list of pathways','value':'org_pathway_lst'})
				text.split("\n").forEach(function(str){
					let list = str.split(".json")
					childNodes.push({'label':list[0],'value':list[0]})
				});
				KEGG_models.push({'label':'Selected ortholog maps','children':childNodes})
				//console.log('KEGG_models',KEGG_models)
				$('#KEGG_models').multiselect('dataprovider', KEGG_models); 
				//console.log("KEGG_models",KEGG_models)
				
			}
			
			logFileText1('Edited_ortholog_networks/KEGG_organism.txt')
			
			logFileText3('Edited_ortholog_networks/ortholog_pathway_list.txt')
			
			logFileText2('Edited_ortholog_networks/KEGG_pathways.txt')
			
			
			
			/*
			var directory = '/Edited_ortholog_networks_up/';
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.open('GET', directory, false); // false for synchronous request
			xmlHttp.send(null);
			var ret = xmlHttp.responseText;
			//console.log(ret)
			var fileList = ret.split('<li>');
			for (i = 0; i < fileList.length; i++) {
				var fileinfo = fileList[i].split('>')[1].split('<')[0];
				//console.log(fileinfo.split(".")[1])
				if(fileinfo.split(".")[1]=="json"){
					childNodes.push({'label':fileinfo,'value':fileinfo})
				}
			}
			*/
			
			//KEGG_models.push({'label':'Selected ortholog maps','children':childNodes})
			//$('#KEGG_models').multiselect('dataprovider', KEGG_models); 
			
			const kegg_recReader = async file => {
				const response = await fetch(file)
				const text = await response.text()
				text.split("\n").forEach(function(str){
					if(str!=""){
						let list = str.split("\t")
						let rxnlist = list[1].split(";")
						kegg_rec.push({'id':list[0],'name':rxnlist[0],'rxn':rxnlist[rxnlist.length-1]})
					}
				});
			}
			
			kegg_recReader('Edited_ortholog_networks/KEGG_reactions.txt')
			
			const kegg_cpdReader = async file => {
				const response = await fetch(file)
				const text = await response.text()
				text.split("\n").forEach(function(str){
					if(str!=""){
						let list = str.split("\t")
						let cpdnames = list[1].split(";")
						kegg_cpd.push({'id':list[0],'name':cpdnames[0]})
					}
				});
			}
			
			kegg_cpdReader('Edited_ortholog_networks/KEGG_compound.txt')
			
			Main_visualization_code(jsonObj);
			Mainfunction(jsonObj);
			
			//console.log('2 is exe')
			_callback();    
		}
		
		function firstFunction3(){
			// do some asynchronous work
			// and when the asynchronous stuff is complete
			//console.log('3 is exe')
			//document.getElementById("loader").style.display = "none";
			//Main_visualization_code(jsonObj)
			//document.getElementById("myDiv").style.display = "none";
			//_callback();    
		}
		
		function secondFunction(){
			// call first function and pass in a callback function which
			// first function runs when it has completed
			
			//setTimeout(firstFunction3, 3000)
			
			firstFunction1(function(){
				firstFunction2(function(){
					setTimeout(firstFunction3, 3000);
				});
			});
		}
		
		secondFunction();

		//myVar = setTimeout(showPage, 3000);
	}

	function showPage() {
	  //document.getElementById("loader").style.display = "none";
	  //console.log('d')
	  //document.getElementById("myDiv").style.display = "block";
	}
	
	//$('#btn1_input1').on('click', function(){
	//	console.log('it is changes')
	//	console.log(document.getElementById('input3').value) 
	//})
	
	//$('#dataset').on('change', function(){
	//	console.log(d3.select('#dataset').property('checked'))
		//console.log(d3.select("#simulationkey").property("checked"))
	//})
	
	// creates an empty list
	var neighbors1 = []
            
	var gravity = 0.00
	
	var elecrep = 0.0
	
	var width = window.innerWidth - 250
	
	var height = window.innerHeight-0
	
	var svg = d3.select("body")     
			.append("div")
			.attr("id","div_main")
			.append("svg")
			.attr("id","svg_main")
			//.attr('fill','yellow')
			.attr('width', width)
			.attr('height', height);
    
	d3.select("#svg_main").append("defs").append('g').attr('id','arrowHead');
	d3.select("#svg_main").select("defs").append('g').attr('id','arrowEnd');
	//d3.select("#svg_main").append("def2");
	
	// Above zoom thing need to be fixed. Required to make it passive event listeners.
	var g_main = d3.select("#svg_main").append("g")
		.classed('g-main',true);
	
	// Creates a group into svg element. Groups are good to apply same operation on each element within the group
	var rect = g_main.append('rect')
		.attr('width', width)
		.attr('height', height)
		.style('fill', 'white')
		.style('stroke-width', 5)
		.style('stroke','Black')
		.attr('id','back_rect');
	
	var gp = g_main.append("g")   
		.attr("id","network");
    
	var lnks = d3.select("#network").append("g")
			 .attr("class", "links_g");
			 
	var nds = d3.select("#network").append("g")
			.attr("class", "nodes_g");
	
	var txts = d3.select("#network").append("g")
			 .attr("class","texts_g");
			 
	var lbs = d3.select("#network").append("g")
			 .attr("class","labels_g");
	
	var bdry = d3.select("#network").append("g")
			 .attr("class","bdry_g");
	
	var brs = gp.append("g")
			.attr("class","bars_g");
	
	var imgs = gp.append("g")
			.attr("class","images_g");
	
	var gBrushHolder = g_main.append('g')
			.attr('id','brush');
						
	var mouse_cor={x:0,y:0};
						
	
	var menu = document.querySelector('.menu');
	
	function showMenu(x, y){
	menu.style.left = x + 'px';
	menu.style.top = y + 'px';
	menu.classList.add('show-menu');
	}
	
	function hideMenu(){
	menu.classList.remove('show-menu');
	}
	
	function onContextMenu(e){
	e.preventDefault();				
	showMenu(e.pageX, e.pageY);
	document.addEventListener('click', onClick, false);
	}
	
	function onClick(e){
	hideMenu();
	document.removeEventListener('click', onClick);
	}
	
	document.getElementById('svg_main').addEventListener('contextmenu', onContextMenu, false);
			
	var colorScale = d3.scaleSequential(d3.interpolateRdBu)
					.domain([0, 200]);
	
	var cbars = d3.select("#c_scale")
			.append("svg")
			.attr("width",152)
			.attr("height",20);
		cbars
			.append("g")
			.attr("class","bars_g")
			.selectAll(".bars")
			.data(d3.range(200), function(d) { return d; })
			.enter().append("rect")
			.attr("class", "bars")
			.attr("x", function(d, i) { return i+9.0; })
			.attr("y", 0.0)
			.attr("height", 20.0)
			.attr("width", 1.0)
			.style("fill", function(d, i ) { return colorScale(d); });
						
            var cbars2 = d3.select("#c_scale_fil")
						.append("svg")
						.attr("id","c_scale_fil_svg")
						.attr("width",200)
						.attr("height",27);
					cbars2
						.append("g")
						.attr("class","bars_g")
						.selectAll(".bars")
						.data(d3.range(200), function(d) { return d; })
						.enter().append("rect")
						.attr("class", "bars")
						.attr("x", function(d, i) { return i+9.0; })
						.attr("y", 0.0)
						.attr("height", 27.0)
						.attr("width", 1.0)
						.style("fill", function(d, i ) { return colorScale(d*1.00); });
            
            d3.select('#menu_options').select('.menu').select('#submenu4').select('#menu4').select('#insert_color_scale').on('click', Insert_color_scale)
            
            d3.select('#menu_options').select('.menu').select('#submenu3').select('#menu3').select('#delete-color_scale').on('click', Delete_color_scale)
            
            function Insert_color_scale(){
				var bars = gp.select(".bars_g")
						.selectAll(".bars")
						.data(d3.range(200), function(d) { return d; })
						.enter().append("rect")
						.attr("class", "bars")
						.attr("x", 0)
						.attr("y", function(d, i) { return height - i; })
						.attr("height", 1)
						.attr("width", 20.0)
						.style("fill", function(d, i ) { 
							if(!d3.select("#invert").property("checked"))
								return colorScale(d);
							else 
								return colorScale(200-d);
						});
						
				gp.select(".bars_g")
				  .datum({
					x: 0,
					y: 0
				  })
				  .call(d3.drag()
					.on("drag", function(d) {
					  d3.select(this).attr("transform", "translate(" + 
					  (d.x = d3.event.x) + "," + (d.y = d3.event.y) + ")")
					}));				
			}
			
			function Delete_color_scale(){
				gp
				.selectAll(".bars")
				.remove();
			}
            	
			d3.select("#btn1_input3").on("click", function(d){
				if(parseFloat(document.getElementById("input3").value)<-1000.0)
					document.getElementById("input3").value = -1000.0
				else if(parseFloat(document.getElementById("input3").value)>(parseFloat(document.getElementById("input4").value)-1.0))
					document.getElementById("input3").value = document.getElementById("input4").value-1.0
				d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
				d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
				d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
			});
			
			d3.select("#btn2_input3").on("click", function(d){
				if(parseFloat(document.getElementById("input3").value)<-1000.0)
					document.getElementById("input3").value = -1000.0
				else if(parseFloat(document.getElementById("input3").value)>(parseFloat(document.getElementById("input4").value)-1.0))
					document.getElementById("input3").value = document.getElementById("input4").value-1.0
				d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
				d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
				d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
			});
			
			d3.select("#btn1_input4").on("click", function(d){
				if(parseFloat(document.getElementById("input4").value)<(parseFloat(document.getElementById("input3").value)+1.0))
					document.getElementById("input4").value = parseFloat(document.getElementById("input3").value) + 1.0
				else if(parseFloat(document.getElementById("input4").value)>1000.0)
					document.getElementById("input4").value = 1000.0
				d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
				d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
				d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
			});
			
			d3.select("#btn2_input4").on("click", function(d){
				if(parseFloat(document.getElementById("input4").value)<(parseFloat(document.getElementById("input3").value)+1.0))
					document.getElementById("input4").value = parseFloat(document.getElementById("input3").value) + 1.0
				else if(parseFloat(document.getElementById("input4").value)>1000.0)
					document.getElementById("input4").value = 1000.0
				d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
				d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
				d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
			});
			
			d3.select("#input3").on('change', function(){
				if(parseFloat(document.getElementById("input3").value)<-1000.0)
					document.getElementById("input3").value = -1000.0
				else if(parseFloat(document.getElementById("input3").value)>(parseFloat(document.getElementById("input4").value)-1.0))
					document.getElementById("input3").value = document.getElementById("input4").value-1.0
				d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
				d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
				d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
			});
			
			d3.select("#input4").on('change', function(){
				if(parseFloat(document.getElementById("input4").value)<(parseFloat(document.getElementById("input3").value)+1.0))
					document.getElementById("input4").value = parseFloat(document.getElementById("input3").value) + 1.0
				else if(parseFloat(document.getElementById("input4").value)>1000.0)
					document.getElementById("input4").value = 1000.0
				d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
				d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
				d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
			})
			
			var color_ch = d3.select("#c_scale_fil_svg")
							.append("rect")
							.attr("id","slit")
							.attr("width",2.0)
							.attr("height",27.0)
							.attr("fill","black")
							.attr("x",50.0)
							.attr("y",0.0)
							.call(d3.drag()
							.on("drag", function () {
								var ele = d3.select(this)
								var new_x = parseFloat(ele.attr('x'))
								new_x += d3.event.dx
								if(new_x>198.0)
									new_x=198.0
								else if(new_x<10.0)
									new_x = 10.0
								ele.attr("x", new_x)
								//console.log(new_x)
								if(!d3.select("#invert").property("checked")){
									
									d3.select("#network").select('.nodes_g').selectAll('.selected').attr('fill', colorScale(new_x-10));
									
									d3.select("#network").select('.bdry_g').selectAll('.selected').style('fill', colorScale(new_x-10));
									
									d3.select("#network").select('.labels_g').selectAll('.selected').attr('fill', colorScale(new_x-10));
									
									var ids = [], pre_ids=[];
									
									d3.select("#network").select(".links_g").selectAll('.selected').each(function(){
										let x = d3.select(this);
										ids.push(x.attr('id'))
										pre_ids.push(x.attr('id').split('_curved_')[0])
									});
									
									d3.select("#network").select(".links_g").selectAll('path').each(function(){
										let x = d3.select(this);
										if(ids.includes(x.attr('id'))){
											x.attr('stroke', colorScale(new_x-10));
										}
									});
									//console.log('ids',ids)
									
									actualdata.nodes.forEach(function(val,i){
										val.fill = gp.select('.nodes_g').selectAll('.nodes').filter(function(n){
											let x = d3.select(this)
											if(n.id==val.id)
												return n
										}).attr('fill');
									});
									
									actualdata.links.forEach(function(val,i){
										val.stroke = gp.select('.links_g').selectAll('path').filter(function(l){
											if(l.id==val.id)
												return l
										}).attr('stroke');
									});
									
									d3.select("#svg_main").select('defs').selectAll('marker').each(function(){
										let y = d3.select(this)
										let marker_id = y.attr('id')
										if(pre_ids.includes(y.attr('id').slice(0,-6))){
											y.remove();
											d3.select("#svg_main").select('defs')
												.append('marker')
												.attr("id",function(d){
													return marker_id;
												})
												.attr("viewBox","0 0 10 10")
												.attr("refX",5)
												.attr("refY",5)
												.attr("markerWidth",10)
												.attr("markerHeight",5)
												.attr("orient","auto")
												.append("path")
												.attr("d", "M 0 0 L 5 5 L 0 10 z")
												.attr("fill",function(d){
													return colorScale(new_x-10)
												})
												.attr("class","arrowHead");
										}
									})
								}
								else{
									d3.select("#network").select('.nodes_g').selectAll('.selected').attr('fill', colorScale(200-new_x));
									
									d3.select("#network").select('.bdry_g').selectAll('.selected').style('fill', colorScale(200-new_x));
									
									d3.select("#network").select('.labels_g').selectAll('.selected').attr('fill', colorScale(200-new_x));
									
									var ids = [];
									var pre_ids = [];
									
									d3.select("#network").select(".links_g").selectAll('.selected').each(function(){
										let x = d3.select(this);
										ids.push(x.attr('id'))
										pre_ids.push(x.attr('id').split('_curved_')[0])
									});
									
									//console.log('ids',ids)
									
									d3.select("#network").select(".links_g").selectAll('path').each(function(){
										let x = d3.select(this);
										if(ids.includes(x.attr('id'))){
											x.attr('stroke', colorScale(200-new_x));
										}
									});
									
									actualdata.nodes.forEach(function(val,i){
										val.fill = gp.select('.nodes_g').selectAll('.nodes').filter(function(n){
											let x = d3.select(this)
											if(n.id==val.id)
												return n
										}).attr('fill');
									});
									
									actualdata.links.forEach(function(val,i){
										val.stroke = gp.select('.links_g').selectAll('path').filter(function(l){
											if(l.id==val.id)
												return l
										}).attr('stroke');
									});
									
									d3.select("#svg_main").select('defs').selectAll('marker').each(function(){
										let y = d3.select(this)
										let marker_id = y.attr('id')
										if(pre_ids.includes(y.attr('id').slice(0,-6))){
											y.remove();
											d3.select("#svg_main").select('defs')
												.append('marker')
												.attr("id",function(d){
													return marker_id;
												})
												.attr("viewBox","0 0 10 10")
												.attr("refX",5)
												.attr("refY",5)
												.attr("markerWidth",10)
												.attr("markerHeight",5)
												.attr("orient","auto")
												.append("path")
												.attr("d", "M 0 0 L 5 5 L 0 10 z")
												.attr("fill",function(d){
													return colorScale(200-new_x)
												})
												.attr("class","arrowHead");
										}
									})
								}
							}));	
            
			var colorscales = [
				{'label':'Diverging', 'children':[{'label': 'BrBG', value: 'BrBG'},
				{'label': 'PRGn', value: 'PRGn'}, 
				{'label': 'PiYG', value: 'PiYG'}, 
				{'label': 'PuOr', value: 'PuOr'}, 
				{'label': 'RdBu', value: 'RdBu'}, 
				{'label': 'RdGy', value: 'RdGy'}, 
				{'label': 'RdYlBu', value: 'RdYlBu'}, 
				{'label': 'RdYlGn', value: 'RdYlGn'}, 
				{'label': 'Spectral', value: 'Spectral'}]},
				{'label':'Single Hue', 'children':[{'label': 'Blues', value: 'Blues'},
				{'label': 'Greens', value: 'Greens'},
				{'label': 'Reds', value: 'Reds'},
				{'label': 'Purples', value: 'Purples'},
				{'label': 'Oranges', value: 'Oranges'},
				{'label': 'Greys', value: 'Greys'}]},
				{'label':'Multi-Hue', 'children':[{'label': 'Turbo', value: 'Turbo'},
				{'label': 'Viridis', value: 'Viridis'},	
				{'label': 'Inferno', value: 'Inferno'},	
				{'label': 'Magma', value: 'Magma'},	
				{'label': 'Plasma', value: 'Plasma'},	
				{'label': 'Cividis', value: 'Cividis'},	
				{'label': 'Warm', value: 'Warm'},	
				{'label': 'Cool', value: 'Cool'},	
				{'label': 'CubehelixDefault', value: 'CubehelixDefault'},	
				{'label': 'BuGn', value: 'BuGn'},	
				{'label': 'BuPu', value: 'BuPu'},	
				{'label': 'GnBu', value: 'GnBu'},	
				{'label': 'OrRd', value: 'OrRd'},	
				{'label': 'PuBuGn', value: 'PuBuGn'},	
				{'label': 'PuBu', value: 'PuBu'},	
				{'label': 'PuRd', value: 'PuRd'},	
				{'label': 'RdPu', value: 'PuRd'},	
				{'label': 'YlGnBu', value: 'YlGnBu'},	
				{'label': 'YlGn', value: 'YlGn'},	
				{'label': 'YlOrBr', value: 'YlOrBr'},	
				{'label': 'YlOrRd', value: 'YlOrRd'}]},
				{'label':'Cyclical', 'children':[{'label': 'Rainbow', value: 'Rainbow'},
				{'label': 'Sinebow', value: 'Sinebow'}]}]
						
			on_bigg_models_changed = function(){
				settings = true;
				var value = d3.select('#BiGG_models').node().selectedOptions[0].value;
						
				const logFileText = async file => {
					const response = await fetch(file)
					const text = await response.text()
					var jsonparse = JSON.parse(text)
					
					//console.log(jsonparse)
					
					jsonObj = translate_model(jsonparse);
					  
					//console.log(jsonObj);
					jsonObj.links = filtering_edges(jsonObj);
					Main_visualization_code(jsonObj);
					
				}
				
				logFileText('BiGG_models/'+ value + '.json')
				
				/*
				var url  = 'http://bigg.ucsd.edu/api/v2/models/' + value + '/download';
				fetch(url)
				  .then(response => response.blob())
				  .then(blob => {
					const reader = new FileReader;
					reader.addEventListener('load', () => {
					  //console.log(reader.result)
					  var temp = JSON.parse(reader.result)
					  
					  jsonObj = translate_model(temp);
					  
					  console.log(jsonObj);
					  jsonObj.links = filtering_edges(jsonObj);
					  Main_visualization_code(jsonObj);
					});
					reader.readAsText(blob);
				});
				*/
			}
			
			function translate_model(arr){ 
				var meta = arr['metabolites']
				var rxn = arr['reactions']
				
				var nodes = [];
				meta.forEach(function(d){
					if(d.annotation["kegg.compound"]==undefined){
						let dummy_kegg_id = makeid(10)
						nodes.push({"id": d.id, "name": d.name, "type":"M", "x":0.0,"y":0.0,"r":8.0,"dx":10,"dy":2,"font_size":12, "formula":d.formula, "kegg_id": d.id, fill:'white',cpd_link:'undefined',"subsystem":'undefined'})
					}
					else{
						nodes.push({"id": d.id, "name": d.name, "type":"M", "x":0.0,"y":0.0,"r":8.0,"dx":10,"dy":2,"font_size":12, "formula":d.formula, "kegg_id": d.annotation["kegg.compound"][0], fill:'white',cpd_link:'undefined',"subsystem":"undefined"})
					}
				})
				
				var links = [];
				rxn.forEach(function(l){
					if(l.name.includes("biomass")==false){
						let rev = 0
						let dummy_kegg_id = makeid(10)
						if(l.lowerbound<-1){
							rev = 1
						}
						try{
							//console.log('l.annot',l.annotation["kegg.reaction"][0])
							nodes.push({"id":l.id, "rev":rev, "name": l.name, "subsystem":l.subsystem, "type":"R", "x":0.0, "y":0.0, "r":8, "dx":10, "dy":2, "font_size":12, "gene_reaction_rule": l.gene_reaction_rule,"kegg_id": l.annotation["kegg.reaction"][0], fill:"#d3d3d3", rxn:'undefined'})
						}
						catch(err){
							nodes.push({"id":l.id, "rev":rev, "name": l.name, "subsystem":l.subsystem, "type":"R", "x":0.0, "y":0.0, "r":8, "dx":10, "dy":2, "font_size":12, "gene_reaction_rule": l.gene_reaction_rule,"kegg_id": l.id, fill:"#d3d3d3", rxn:'undefined'})
						}
						//nodes.push({"id":l.id, "rev":rev, "name": l.name, "subsystem":l.subsystem, "type":"R", "x":0.0, "y":0.0, "r":8, "dx":10, "dy":2, "font_size":12, "gene_reaction_rule": l.gene_reaction_rule,"kegg_id": l.annotation["kegg.reaction"]})
						
						var keys = Object.keys(l.metabolites);
						keys.forEach(function(k){
							if(l.metabolites[k]>0){
								links.push({"source": l.id, "target":k, "strength":2, "id":l.id, "kegg_id": l.id , stroke: "rgb(0, 0, 0)", opacity: 1.0, subsystem: l.subsystem})
							}
							else{
								links.push({"source": k, "target": l.id, "strength":2, "id":l.id, "kegg_id": l.id , stroke: "rgb(0, 0, 0)", opacity: 1.0, subsystem: l.subsystem})
							}
						})
					}
				})
				
				return {"nodes":nodes, "links":links, "labels":[], "boxes":[], "images":[]} 
			}
			 
			$('#BiGG_models').multiselect({
				buttonWidth: '130px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: true,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'BiGG Database',
				onChange: on_bigg_models_changed,
				onSelectAll: on_bigg_models_changed,
				onDeselectAll: on_bigg_models_changed
			});
			
            on_kegg_models_changed = function(){ 
				
				var selected_options = [];
				var selected_options1 = [];
				
				var ref = d3.select('#KEGG_models').node().selectedOptions;
				var ref1 = d3.select('#KEGG_orgs').node().selectedOptions;
				
				for (var i = 0; i<ref.length; i++) {
					selected_options.push(ref[i]);
				};
				
				for (var i = 0; i<ref1.length; i++) {
					selected_options1.push(ref1[i]);
				};
				
				settings = false;
				
				let pathways = [];
				let organisms = [];
				
				selected_options1.forEach(function(d){
					if(d.parentNode.label=="List of Organism")
						organisms.push(d.value)
				})
				
				selected_options.forEach(function(d){
					
					if(d.parentNode.label=="List of Pathways")
						pathways.push(d.value)
					
					if(d.parentNode.label=="Selected ortholog maps"){
						
						var jsonObj_generic;
						
						function combining_files(selected_options,){
							selected_options.sort();
							for(filen=0; filen<selected_options.length; filen++){
								let filename = "Edited_ortholog_networks/" + selected_options[filen].value+".json"
								//console.log('filename',filename)
								d3.json(filename).then(function(d){ 
									if(jsonObj_generic==undefined){
										jsonObj_generic = d;
										jsonObj_generic["nodes"].forEach(function(d){
											if(d.name==null){
												d.name = makeid(20)	
											}
										})
									}
								});
								
							}
							return jsonObj_generic
						}	
						
						jsonObj_generic = combining_files(selected_options);
						
						function display_network(callback){
							//console.log('display network is executed')
							//your code to be executed after 2 second
							jsonObj = jsonObj_generic
							//console.log('jsonObj',jsonObj)
							if(jsonObj!=undefined){
								callback(jsonObj);
							}
						}
						
						setTimeout(function() {
							display_network(Main_visualization_code);
						}, 2000.0);
					}
				})
				
				//console.log(organisms,pathways)
				
				if (organisms.length>0 && pathways.length>0){
					organisms.forEach(function(org){
						pathways.forEach(function(map){
							//console.log(map)
							if(map=='org_pathway_lst'){
								let url = "http://rest.kegg.jp/list/pathway/" + org
								window.open(url, '_blank').focus();
							}
							else{
								let url = "http://rest.kegg.jp/get/" + org + map.slice(-5) + "/kgml"
								//window.open("http://rest.kegg.jp/get/hsa00010/kgml", '_blank').focus();
								window.open(url, '_blank').focus();
							}
						})
					})
				}
			};
			
			d3.select('#help').on('click', function(){
				//let url = "http://localhost:8000/help.html"
				let url = "help.html"
				window.open(url, '_blank').focus();
			})
			
			//KEGG_models.push({'label':'KEGG models','value':'KEGG_models'})
			
			$('#KEGG_models').multiselect({
				buttonWidth: '130px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: false,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'KEGG Database',
				onChange: on_kegg_models_changed,
				onSelectAll: on_kegg_models_changed,
				onDeselectAll: on_kegg_models_changed
			});
			
			on_kegg_orgs_changed = function(){
				
				var selected_options = [];
				var selected_options1 = [];
				
				var ref = d3.select('#KEGG_models').node().selectedOptions;
				var ref1 = d3.select('#KEGG_orgs').node().selectedOptions;
				
				for (var i = 0; i<ref.length; i++) {
					selected_options.push(ref[i]);
				};
				
				for (var i = 0; i<ref1.length; i++) {
					selected_options1.push(ref1[i]);
				};
				
				settings = false;
				
				let pathways = [];
				let organisms = [];
				
				selected_options1.forEach(function(d){
					if(d.parentNode.label=="List of Organism")
						organisms.push(d.value)
				})
				
				selected_options.forEach(function(d){
					
					if(d.parentNode.label=="List of Pathways")
						pathways.push(d.value)
					
					if(d.parentNode.label=="Selected ortholog maps"){
						
						var jsonObj_generic;
						
						function combining_files(selected_options,){
							selected_options.sort();
							for(filen=0; filen<selected_options.length; filen++){
								let filename = "Edited_ortholog_networks/" + selected_options[filen].value+".json"
								//console.log('filename',filename)
								d3.json(filename).then(function(d){ 
									if(jsonObj_generic==undefined){
										jsonObj_generic = d;
										jsonObj_generic["nodes"].forEach(function(d){
											if(d.name==null){
												d.name = makeid(20)	
											}
										})
									}
								});
								
							}
							return jsonObj_generic
						}	
						
						jsonObj_generic = combining_files(selected_options);
						
						function display_network(callback){
							//console.log('display network is executed')
							//your code to be executed after 2 second
							jsonObj = jsonObj_generic
							//console.log('jsonObj',jsonObj)
							if(jsonObj!=undefined){
								callback(jsonObj);
							}
						}
						
						setTimeout(function() {
							display_network(Main_visualization_code);
						}, 2000.0);
					}
				})
				
				//console.log(organisms,pathways)
				
				if (organisms.length>0 && pathways.length>0){
					organisms.forEach(function(org){
						pathways.forEach(function(map){
							//console.log(map)
							if(map=='org_pathway_lst'){
								let url = "http://rest.kegg.jp/list/pathway/" + org
								window.open(url, '_blank').focus();
							}
							else{
								let url = "http://rest.kegg.jp/get/" + org + map.slice(-5) + "/kgml"
								//window.open("http://rest.kegg.jp/get/hsa00010/kgml", '_blank').focus();
								window.open(url, '_blank').focus();
							}
						})
					})
				}
			
			}
			
			$('#KEGG_orgs').multiselect({
				buttonWidth: '265px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: false,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'KEGG Organisms list',
				onChange: on_kegg_orgs_changed,
				onSelectAll: on_kegg_orgs_changed,
				onDeselectAll: on_kegg_orgs_changed
			});
			
			d3.select("#invert").on("change", function(d) {
				if(d3.select(this).property("checked")){
					d3.select("#c_scale_fil")
						.selectAll(".bars")
						.transition(500)
						.style("fill", function(d) { return colorScale(200-d); });	
						
					if (!gp.selectAll(".bars").empty()){
						gp.selectAll(".bars")
							.transition()
							.style("fill", function(d) { return colorScale(200-d); });	
					}	
						
				}
				else{
					d3.select("#c_scale_fil")
						.selectAll(".bars")
						.transition(500)
						.style("fill", function(d) { return colorScale(d); });	
						
					if (!gp.selectAll(".bars").empty()){
						gp.selectAll(".bars")
							.transition()
							.style("fill", function(d) { return colorScale(d); });	
					}
				}
				
				//slider_g_main.selectAll('rect').each(function(d){
				//	console.log(d)
					//console.log(d.x,d.x+d.width)
				//})
				
			});
			
			var on_color_scale_changed = function(){
				var height = 200.0
				var value = d3.select('#color_scales').node().selectedOptions[0].value;
				colorScale = d3.scaleSequential(d3["interpolate" + value])
								.domain([0, height]);

				
				if (!gp.selectAll(".bars").empty()){
					gp.selectAll(".bars")
						.transition()
						.style("fill", function(d) { return colorScale(d); });	
				}
					
				d3.select("#c_scale").selectAll(".bars")
					.transition()
					.style("fill", function(d) { return colorScale(d); });	
								
				d3.select("#c_scale_fil").selectAll(".bars")
					.transition()
					.style("fill", function(d) { 
						if(!d3.select("#invert").property("checked"))
							return colorScale(d);
						else 
							return colorScale(200-d);
						});				
			}			  
			
			$('#color_scales').multiselect({
                                buttonWidth: '245px',
                                multiple: false,
                                maxHeight: 150,
                                enableClickableOptGroups: true,
                                enableCollapsibleOptGroups: true,
                                collapseOptGroupsByDefault: true,
                                enableFiltering: true,
                                enableCaseInsensitiveFiltering: false,
                                filterPlaceholder: 'Cerca',
                                includeSelectAllOption: false,
                                selectAllJustVisible: false,
                                selectAllText: 'Select All',
                                nSelectedText: ' selected',
                                allSelectedText: 'All selected',
                                nonSelectedText: 'Color scales',
                                onChange: on_color_scale_changed,
                                onSelectAll: on_color_scale_changed,
                                onDeselectAll: on_color_scale_changed
                            });
            
            $('#color_scales').multiselect('dataprovider', colorscales);
            
            var xrange = d3.scaleLinear()
					.domain([0,100])
					.range([0, 200]);
			
			
			//var ctrlKey;
			function keyup() {
				shiftKey = false;
				brushMode = false;
				keycode = 0
				//console.log('keyT',keyT)
				//if (!gBrush)
				//	return;
				
				if (!shiftKey) {
					//console.log(shiftKey)
					// if we already have a brush, don't do anything
					gBrush.remove();
					gBrush = null;
				}

				if (!brushing) {
					// only remove the brush if we're not actively brushing
					// otherwise it'll be removed when the brushing ends
					gBrush.remove();
					gBrush = null;
				}
				//ctrlKey = d3.event.ctrlKey
			};

			function keydown() {
				shiftKey = d3.event.shiftKey;
				keycode = d3.event.keyCode
				//ctrlKey = d3.event.ctrlKey;
				if (shiftKey) {
					//console.log(shiftKey)
					// if we already have a brush, don't do anything
					if (gBrush)
						return;

					brushMode = true;

					if (!gBrush) {
						gBrush = gBrushHolder.append('g');
						gBrush.call(brush);
					}
				}
				//console.log(d3.event.code)
				 // keycode==78 is for letter N
				 // keycode==76 is for letter L
				 // keycode==84 is for letter T
				
			};
			
			var brush = d3.brush()
				.on("start", brushstart)
				.on("brush",brushed)
				.on("end",brushend);
			
			function brushstart() {
				// keep track of whether we're actively brushing so that we
				// don't remove the brush on keyup in the middle of a selection
				brushing = true;

				gp.selectAll('.nodes').each(function(d) { 
					d.previouslySelected = shiftKey && d.selected; 
				});
			}
			
			function brushed() {
				if (!d3.event.sourceEvent) return;
				if (!d3.event.selection) return;

				var extent = d3.event.selection;

				gp.selectAll('.nodes').classed("selected", function(d) {
					return d.selected = d.previouslySelected ^
					(extent[0][0] <= (d.x * currentZoom.k + currentZoom.x) && (d.x * currentZoom.k + currentZoom.x) < extent[1][0]
					 && extent[0][1] <= (d.y * currentZoom.k + currentZoom.y) && (d.y * currentZoom.k + currentZoom.y) < extent[1][1]);
				});
			};

			function brushend() {
				if (!d3.event.sourceEvent) return;
				if (!d3.event.selection) return;
				if (!gBrush) return;

				gBrush.call(brush.move, null);

				if (!brushMode) {
					// the shift key has been release before we ended our brushing
					gBrush.remove();
					gBrush = null;
				}
				brushing = false;
				shiftKey = false;
				gBrush.remove();
				gBrush = null;
			};
			
			var xScale = d3.scaleLinear()
				.domain([-width / 2, width / 2])
				.range([0, width]);

			var yScale = d3.scaleLinear()
				.domain([-height / 2, height / 2])
				.range([height, 0]);


			var xAxis = d3.axisBottom(xScale)
				.ticks((width + 2) / (height + 2) * 10)
				.tickSize(height)
				.tickPadding(8 - height);

			var yAxis = d3.axisRight(yScale)
				.ticks(10)
				.tickSize(width)
				.tickPadding(8 - width);
			
			var hide_features = [{'label':'Grid', 'value':'Grid', 'selected':true},
			{'label':'Tooltip', 'value':'Tooltip', 'selected':true},
			{'label':'Reaction node name','value':'rxn_name', 'selected':true},
			{'label':'Link node','value':'l_node', 'selected':false}
			]
			
			var on_hide_fea_changed = function(){
				var ele_values = [];
				var ref = d3.select('#hide').node().selectedOptions;
				for (var i = 0; i < ref.length; i++) {
					ele_values.push(ref[i].value)
				}
				
				if(ele_values.includes('Grid')){
					d3.select("#svg_main").selectAll(".axis").remove();
				}
				else{
					if(document.getElementsByClassName('axis').length==0){
						gX = d3.select("#svg_main")
							.append("g")
							.attr("class", "axis")
							.call(xAxis);
							
						gY = d3.select("#svg_main")
							.append("g")
							.attr("class", "axis")
							.call(yAxis);
					}
				}
				
				let count1 = gp.select('.nodes_g').selectAll('.nodes').filter(function(n){
					if(n.type=="R" && n.r>0.0)
						return n
				}).size();
				
				if(count1>0 && ele_values.includes('l_node')==true){					
					actualdata.nodes.forEach(function(val,i){
						if(val.type=="R")
							val.r = 0.0;
					});
					Mainfunction(actualdata);
				}
				else if(count1==0 && ele_values.includes('l_node')==false){
					actualdata.nodes.forEach(function(val,i){
						if(val.type=="R")
							val.r = 8.0;
					});
					Mainfunction(actualdata);
				}
				
				let count2 = gp.select(".texts_g").selectAll(".texts").filter(function(n){
					if(n.type=="R" && d3.select(this)["_groups"]["0"]["0"].childNodes.length==0)
						return n
				}).size();
				
				let count3 = gp.select(".texts_g").selectAll(".texts").filter(function(n){
					if(n.type=="R")
						return n
				}).size();
				
				if(count2!=count3 && ele_values.includes('rxn_name')==true){
					gp.select(".texts_g")
					.selectAll(".texts")
					.text(function (d) {
						if (d.type!="R"){
							return d.name
						}
						else{								
							return ""
						}
					})
				}
				else if(ele_values.includes('rxn_name')==false && count2==count3){
					gp.select(".texts_g")
					.selectAll(".texts")
					.text(function (d) {
						if (d.type!="R"){
							return d.name
						}
						else{
							return d.name
						}
					})
				}
			}
			
			$('#hide').multiselect({
				buttonWidth: '130px',
				maxHeight: 200,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: false,
				enableCaseInsensitiveFiltering: false,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: false,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Hide',
				onChange: on_hide_fea_changed,
				onSelectAll: on_hide_fea_changed,
				onDeselectAll: on_hide_fea_changed
			});
			
			$('#hide').multiselect('dataprovider', hide_features);

			d3.select("#svg_main").call(d3.zoom()
				//.translateExtent([[0, 0], [width, height]])
				//.center([width / 2, height / 2])
				.scaleExtent([0.01, 10])
				.on("zoom", zoomed));
				
			function zoomed() {
				gp.attr("transform", d3.event.transform);
				zoomTrans.x = d3.event.transform.x;
				zoomTrans.y = d3.event.transform.y;
				zoomTrans.scale = d3.event.transform.k;
				currentZoom = d3.event.transform;
				
				var ele_values = [];
				var ref = d3.select('#hide').node().selectedOptions;
				//console.log('ref',ref)
				for (var i = 0; i < ref.length; i++) {
					ele_values.push(ref[i].value)
				}
				if(ele_values.includes('Grid')==false){
					gX.call(xAxis.scale(d3.event.transform.rescaleX(xScale)));
					gY.call(yAxis.scale(d3.event.transform.rescaleY(yScale)));
				}
			};

            var groupdata = ["0","1","2"]   // group number
            var simuoption = ["Simulation-ON","Simulation-OFF"] // option to stop simulation
            var showsecmeta = ['Include Sec. Meta','Exclude Sec. Meta']
 
            // default value of the simulation "on"
            var simukey = 1.0
            
//          simulation on/off
            d3.select("#simulationkey").on("change", function(d) {
                if(d3.select(this).property("checked")){
                    gravity = 0.015
                    elecrep = -25.0
                }
                else{
                    gravity = 0.0
                    elecrep = 0.0
                }
            });
           
            // Empty list
            var selection = [];
            
            function get_selection(){
                selection = [];
                node.each(function(d) {
                    if (d.selected) {
                    selection.push(d);
                    }
                });
            }
            
            // change properties of selected nodes
			function selectNode(selectedNode) {
				//console.log(selectedNode.id)
				//console.log(selectedNode.name)
			};
            
//             Sets selected class of nodes to false status. 
            function clear_selection() {
                node.classed('selected', function (d) { return d.selected = false; })
            }
					
			// sets node unfix by double click
			function dblclick(d) {
				var fixednode = d3.select(this).classed("fixed", d.fixes = false);
				d.fx = null
				d.fy = null
			};
			
			function makeid(length) {
				var result           = [];
				var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
				var charactersLength = characters.length;
				for ( var i = 0; i < length; i++ ) {
				  result.push(characters.charAt(Math.floor(Math.random() * 
			 charactersLength)));
			   }
			   return result.join('');
			}		
			
			function change_shape(){
				var ele = d3.select(this)
				ele.classed('selected', true)
				var new_width = parseFloat(ele.attr('width'))
				var new_height = parseFloat(ele.attr('height'))
				var new_x = parseFloat(ele.attr('x'))
				var new_y = parseFloat(ele.attr('y'))
				
				var pointer_c1 = gp.append('circle')
					.attr('cx',parseFloat(ele.attr('x')))
					.attr('cy',parseFloat(ele.attr('y')))
					//.style('fill','red')
					.attr('class', 'point')
					.call(d3.drag().on("drag", function () {
						d3.select(this)
							.attr("cx", d3.event.x)
							.attr("cy", d3.event.y)
						
						new_width -= d3.event.dx
						new_height -= d3.event.dy
						new_x += d3.event.dx
						new_y += d3.event.dy
						if(new_width>0)
							ele.attr('x',new_x)
						else
							ele.attr('x',new_x+new_width)
						if(new_height>0)
							ele.attr('y',new_y)
						else
							ele.attr('y',new_y+new_height)
						
						ele.attr('width',Math.abs(new_width))
						ele.attr('height',Math.abs(new_height))
					}));
					
				var pointer_c2 = gp.append('circle')
					.attr('cx',parseFloat(ele.attr('x'))+parseFloat(ele.attr('width')))
					.attr('cy',parseFloat(ele.attr('y'))+parseFloat(ele.attr('height')))
					//.style('fill','red')
					.attr('class', 'point')
					.call(d3.drag().on("drag", function () {
						d3.select(this)
							.attr("cx", d3.event.x)
							.attr("cy", d3.event.y)
						
						new_width += d3.event.dx
						new_height += d3.event.dy
						if(new_width<0)
							ele.attr('x',new_x+new_width)
						else
							ele.attr('x',new_x)
						if(new_height<0)
							ele.attr('y',new_y+new_height)
						else
							ele.attr('y',new_y)
						ele.attr('width',Math.abs(new_width))
						ele.attr('height',Math.abs(new_height))
					}));
			};
			
			function RGBToHex(rgb) {
			  // Choose correct separator
			  let sep = rgb.indexOf(",") > -1 ? "," : " ";
			  // Turn "rgb(r,g,b)" into [r,g,b]
			  rgb = rgb.substr(4).split(")")[0].split(sep);

			  let r = (+rgb[0]).toString(16),
				  g = (+rgb[1]).toString(16),
				  b = (+rgb[2]).toString(16);

			  if (r.length == 1)
				r = "0" + r;
			  if (g.length == 1)
				g = "0" + g;
			  if (b.length == 1)
				b = "0" + b;

			  return "#" + r + g + b;
			}
			
			function drawCurve(d) {
				//console.log(d)
				var sourceX = d.source.x;
				var sourceY = d.source.y;
				var targetX = d.target.x;
				var targetY = d.target.y;

				var theta = Math.atan((targetX - sourceX) / (targetY - sourceY));
				var phi = Math.atan((targetY - sourceY) / (targetX - sourceX));
				
				var sinTheta = d.source.r * Math.sin(theta);
				var cosTheta = d.source.r * Math.cos(theta);
				var sinPhi = d.target.r * Math.sin(phi);
				var cosPhi = d.target.r * Math.cos(phi);

				// Set the position of the link's end point at the source node
				// such that it is on the edge closest to the target node
				if (d.target.y > d.source.y) {
					sourceX = sourceX + sinTheta;
					sourceY = sourceY + cosTheta;
				}
				else {
					sourceX = sourceX - sinTheta;
					sourceY = sourceY - cosTheta;
				}

				// Set the position of the link's end point at the target node
				// such that it is on the edge closest to the source node
				if (d.source.x > d.target.x) {
					targetX = targetX + cosPhi;
					targetY = targetY + sinPhi;    
				}
				else {
					targetX = targetX - cosPhi;
					targetY = targetY - sinPhi;   
				}

				// Draw an arc between the two calculated points
				var dx = targetX - sourceX,
					dy = targetY - sourceY,
					dr = Math.sqrt(dx * dx + dy * dy);
				//return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;
				return "M" + sourceX + "," + sourceY + "L" + targetX + "," + targetY;
				//return "M" + sourceX + "," + sourceY + "L" + targetX + "," + targetY + "L" + targetX*0.9 + 5.0 + ","  + targetY*0.9  + 5.0 + "," + "z";
			}
			
			// To move to front
			d3.selection.prototype.moveToFront = function() {  
			  return this.each(function(){
				this.parentNode.appendChild(this);
			  });
			};
			
			// To move to back
			d3.selection.prototype.moveToBack = function() {  
				return this.each(function() { 
					var firstChild = this.parentNode.firstChild; 
					if (firstChild) { 
						this.parentNode.insertBefore(this, firstChild); 
					} 
				});
			};				
			
			var lineX2 = function (d) {
				
				var length = Math.sqrt(Math.pow(d.target.y - d.source.y, 2) + Math.pow(d.target.x - d.source.x, 2));
				
				var noderadius;
				if (d.target.r==undefined){
					noderadius = 8.0
				}
				else{
					noderadius = d.target.r
				}
				var scale = (length - noderadius) / length;
				var offset = (d.target.x - d.source.x) - (d.target.x - d.source.x) * scale;
				//if(d.target.type=="M"){
				//	offset = (d.target.x - d.source.x) - (d.target.x - d.source.x) * scale;
				//}
				return d.target.x - offset;
				
			};
			
			var lineY2 = function (d) {
				var length = Math.sqrt(Math.pow(d.target.y - d.source.y, 2) + Math.pow(d.target.x - d.source.x, 2));
				
				var noderadius;
				if (d.target.r==undefined){
					noderadius = 8.0
				}
				else{
					noderadius = d.target.r
				}
				
				var scale = (length - noderadius) / length;
				var offset = (d.target.y - d.source.y) - (d.target.y - d.source.y) * scale;
				//if(d.target.type=="M"){
				//	console.log(d.target.type)
				//	offset = (d.target.x - d.source.x) - (d.target.x - d.source.x) * scale;
				//}
				return d.target.y - offset;
			};
			
			function tick(){
				gp.selectAll('.nodes')
					.attr('cx', function (node) { return node.x })
					.attr('cy', function (node) { return node.y });
					//.attr("transform", d => `translate(${d.x}, ${d.y})`);
					
				gp.selectAll('.texts')
					.attr('x', function (node) { return node.x })
					.attr('y', function (node) { return node.y });
				
				function positionLink(d) {
					var ele = d3.select(this);
					
					if(ele.classed('curved')){
						//console.log('curved')
						var loopid = ele.attr('id').split("_curved_").reverse()[0]
						//console.log('loopid',loopid)
						let count = gp.select('.nodes_g').selectAll('.curved').filter(function(l){
							if(d3.select(this).attr('id').split("_curved_").reverse()[0]==loopid)
								return l
						}).size();
						
						var xtotal = 0
						var ytotal = 0
						var xcor = 0
						var ycor = 0
						
						gp.select('.nodes_g').selectAll('.curved').filter(function(l){
							if(d3.select(this).attr('id').split("_curved_").reverse()[0]==loopid)
								return l
						})
						.each(function(d) {
							xtotal+=d.x
							ytotal+=d.y
							xcor = d.x
							ycor = d.y
						});
						
						count = gp.select('.nodes_g').selectAll('.curved').filter(function(l){
							if(d3.select(this).attr('id').split("_curved_").reverse()[0]==loopid)
								return l
						}).size();
						
						//console.log('count',count)
						
						var xavg = xtotal/count;
						var yavg = ytotal/count;
						var xpos = d.source.x
						var ypos = d.source.y
						var x1pos = d.target.x
						var y1pos = d.target.y
						var radius = Math.sqrt((xpos-xavg)**2 + (ypos-yavg)**2)
						var angle = Math.atan2(ypos-yavg,xpos-xavg);
						var angle1 = Math.atan2(y1pos-yavg,x1pos-xavg);
						
						//console.log('radius',radius)
						
						var rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos)
						var dir = 1;
						
						if(angle>0 && angle1>0){
							if(angle1-angle>0){
								dir = 1;
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI;
							}
							else{
								dir = 0;
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI/2.0;
							}
						}
						else if((angle<0 && angle1<0)){
							if(angle1-angle>0){
								dir = 1
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI
							}
							else{
								dir = 0
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI/2.0
							}
						}
						else if((angle<0 && angle1>0) && (angle<0 && angle<-Math.PI/2.0) && (angle1>0 && angle1>Math.PI/2.0)){
							if(angle1-angle>0){
								dir = 0
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI/2.0
							}
							else{
								dir = 1
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI
							}
						}
						else if((angle>0 && angle1<0) && (angle>0 && angle>Math.PI/2.0) && (angle1<0 && angle1<-Math.PI/2.0)){
							if(angle1-angle>0){
								dir = 0
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI/2.0
							}
							else{
								dir = 1
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI
							}
						}
						else{
							if(angle1-angle>0){
								dir = 1
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI
							}
							else{
								dir = 0
								rot_angle = Math.atan2(y1pos-ypos,x1pos-xpos) + Math.PI/2.0
							}
						}

						var t_xoffset = d.target.r*(Math.cos(rot_angle) - Math.sin(rot_angle))/Math.sqrt(2.0)
						var t_yoffset = d.target.r*(Math.sin(rot_angle) + Math.cos(rot_angle))/Math.sqrt(2.0)
						
						return "M" + d.source.x + "," + d.source.y + "A" + radius + "," + radius + " 0 0, " + dir + " " + (d.target.x + t_xoffset) + "," + (d.target.y + t_yoffset);
					}
					else{
						var dx = d.target.x - d.source.x,
						dy = d.target.y - d.source.y,
						dr = Math.sqrt(dx * dx + dy * dy);
						
						var noderadius = 8.0
						if (d.target.r==undefined ||isNaN(d.target.r)){
							noderadius = 8.0
						}
						else{
							noderadius = d.target.r
						}
						var scale = (dr - noderadius) / dr;
						var xoffset = (dx) - (dx) * scale;
						var yoffset = (dy) - (dy) * scale;
						
						//return 'M' + d.source.x + "," + d.source.y + 'L' + (d.target.x - xoffset) + "," + (d.target.y - yoffset)
						//return 'M' + (d.source.x + 1.75*xoffset) + "," + (d.source.y + 1.75*yoffset) + 'L' + (d.target.x - 1.1*xoffset) + "," + (d.target.y - 1.1*yoffset)
						return 'M' + d.source.x + "," + d.source.y + 'L' + (d.target.x - 1.1*xoffset) + "," + (d.target.y - 1.1*yoffset)
						//return ele.attr('d')
					}
				}
				
				gp.selectAll('path')
					.attr('d', positionLink);
					
				
			}
			
			function removeDuplicates(originalArray, prop) {
				var newArray = [];
				var lookupObject  = {};

				for(var i in originalArray) {
					lookupObject[originalArray[i][prop]] = originalArray[i];
				}

				for(i in lookupObject) {
					newArray.push(lookupObject[i]);
				}
				return newArray;
			};
			
			function compare(a, b) {
				const valA = a.value.toUpperCase();
				const valB = b.value.toUpperCase();

				let comparison = 0;
				if (valA > valB) {
				comparison = 1;
				} else if (valA < valB) {
				comparison = -1;
				}
				return comparison;
			};
						
			function distanceBetweenPoints(p1x,p1y, p2x,p2y) {
				return Math.sqrt( Math.pow( p2y - p1y, 2 ) + Math.pow( p2x - p1x, 2 ) );
			}
			
			function compute_center(){				
				var xtotal = 0
				var ytotal = 0
				var xcor = 0
				var ycor = 0
				gp.select('.nodes_g').selectAll('.selected')
				.each(function(d) {
					xtotal+=d.x
					ytotal+=d.y
					xcor = d.x
					ycor = d.y
				});
				
				var count = gp.select('.nodes_g').selectAll('.selected').size();
				
				var xavg = xtotal/count;
				var yavg = ytotal/count;
				var radius = Math.sqrt((xcor-xavg)**2 + (ycor-yavg)**2)
				
				return [xavg,yavg,radius]
			}
			
			function dev(arr){
				// Creating the mean with Array.reduce
				let mean = arr.reduce((acc, curr)=>{
					return acc + curr
				}, 0) / arr.length;
					
				// Assigning (value - mean) ^ 2 to every array item
				arr = arr.map((k)=>{
					return (k - mean) ** 2
				})
					
				// Calculating the sum of updated array 
				let sum = arr.reduce((acc, curr)=> acc + curr, 0);
				   
				// Calculating the variance
				let variance = sum / arr.length
				   
				// Returning the Standered deviation
				return Math.sqrt(sum / arr.length)
			}
			
            function copy_by_value(arr){
				//console.log('copy',arr)
				var keys = Object.keys(arr[0])
				//console.log('keys',keys)
				var new_arr = []
				arr.forEach(function(n){
					let dic = {}
					//console.log('n',n)
					keys.forEach(function(k){
						dic[k] = n[k]
						//console.log(n[k])
					})
					new_arr.push(dic)
				})
				//console.log('new_arr',new_arr)
				return new_arr;
			}
			
			function update_rxnlist(arr){
				var lsubsysgp = []
				var grouped_data = d3.nest().key(function(d) {
					if (d.type=="R"){
						return d.subsystem;}
					else{
						return "NA"
					}
				}).entries(arr.nodes);
				
				//console.log(grouped_data)
				
				var groups_data = grouped_data.filter(function( obj ) {
					return obj.key !== "NA";
				});
				
					
				for (var i=0; i<groups_data.length; i++){
					var children = []
					for (var j=0; j<groups_data[i].values.length; j++){
						children.push({label: groups_data[i].values[j].name, 
									   value: groups_data[i].values[j].id
									   //selected: 'true'
									});
					}
					lsubsysgp.push({label:groups_data[i].key, children: children})
				};
				return lsubsysgp;
			}
			
			subsysgp = {'label':'None','children':[{'label':'None','value':'None'}]}
			remelegp = {'label':'None','children':[{'label':'None','value':'None'}]}
			repelegp = {'label':'None','children':[{'label':'None','value':'None'}]}
			
			/////////////      NODE DEGREE SELECTION    //////////////////////
			var selRemNodeList = [], selRemNodeidList = [], selRepNodeList = [], selRepNodeidList = [];
			
			function degfinder(arr){
				var nodes = []
				arr.nodes.forEach(function(x){
					if (x.type!="R"){
						arr.links.forEach(function(y){
								if (typeof y.source=="string"){
									if (y.source==x.id)
										nodes.push(x.name)
									else if(y.target==x.id)
										nodes.push(x.name)
								}
								else{
									if (y.source.id==x.id)
										nodes.push(x.name)
									else if(y.target.id==x.id)
										nodes.push(x.name)
								}
							})
					}
				})
				
				var counts = {};
				nodes.forEach(function(x) { counts[x] = (counts[x] || 0)+1; });
				var ky1 = Object.entries(counts)
				var repobj = []
				for (var i=0; i<ky1.length; i++){
					repobj.push({rep: ky1[i][1], ele:ky1[i][0]})
				}
				
				// Sorting function
				var sort_by = function(field, reverse, primer){
				   var key = primer ? 
					   function(x) {return primer(x[field])} : 
					   function(x) {return x[field]};

				   reverse = !reverse ? 1 : -1;

				   return function (a, b) {
					   return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
					 } 
				}
				repobj.sort(sort_by('rep',true,parseInt))
				
				//console.log('repobj', repobj)
				return repobj
			};
			
			function RemNodeObj(repobj){
				
				var groups_data = d3.nest().key(function(d) {
					return d.rep;
				}).entries(repobj);
				
				var eledeggp = [];
				for (var i=0; i<groups_data.length; i++){
					var group = {label:groups_data[i].key, children: []}
					for (var j=0; j<groups_data[i].values.length; j++){
						if (selRemNodeList.includes(groups_data[i].values[j].ele)){
							group['children'].push({label: groups_data[i].values[j].ele, 
												   value: groups_data[i].values[j].ele,
												   selected:'true'});
						}
						else if(selRepNodeList.includes(groups_data[i].values[j].ele)){
							group['children'].push({label: groups_data[i].values[j].ele, 
												   value: groups_data[i].values[j].ele,
												   disabled:'true'})
						}
						else{
							group['children'].push({label: groups_data[i].values[j].ele, 
													value: groups_data[i].values[j].ele});
						}
					}
					eledeggp.push(group)
				}
				return eledeggp
			};
			
			function RepNodeObj(repobj){
				var groups_data = d3.nest().key(function(d) {
					return d.rep;
				}).entries(repobj);
				
				var eledeggp = [];
				for (var i=0; i<groups_data.length; i++){
					var group = {label:groups_data[i].key, children: []}
					for (var j=0; j<groups_data[i].values.length; j++){
						if (selRepNodeList.includes(groups_data[i].values[j].ele)){
							group['children'].push({label: groups_data[i].values[j].ele, 
												   value: groups_data[i].values[j].ele,
												   selected:'true'});
						}
						else if (selRemNodeList.includes(groups_data[i].values[j].ele)){
							group['children'].push({label: groups_data[i].values[j].ele, 
												   value: groups_data[i].values[j].ele,
												   disabled:'true'});
						}
						else{
							group['children'].push({label: groups_data[i].values[j].ele, 
													value: groups_data[i].values[j].ele});
						}
					}
					eledeggp.push(group)
				}
				return eledeggp
			};
			
			var on_ele_rem_changed = function(){
				
				var ele_idvalues = [];
				var ele_values = [];
				var ref = d3.select('#remove_nodes').node().selectedOptions;
				for (var i = 0; i < ref.length; i++) {
					actualdata.nodes.filter(function(d){
						if (d.name==ref[i].value)
							ele_idvalues.push(d.id)
					})
					ele_values.push(ref[i].value)
				}
				selRemNodeidList = ele_idvalues;
				selRemNodeList = ele_values;
				
				var updatednodes = actualdata.nodes.filter(function(d){
					if (!selRemNodeidList.includes(d.id) && !selRepNodeidList.includes(d.id))
						return d
				});
				
				var updatedlinks = actualdata.links.filter(function(l){
					if (typeof l.source=="object"){
						if ((!selRemNodeidList.includes(l.source.id) && !selRemNodeidList.includes(l.target.id)) && (!selRepNodeidList.includes(l.source.id) && !selRepNodeidList.includes(l.target.id)))
							return l
					}
					else{
						if ((!selRemNodeidList.includes(l.source) && !selRemNodeidList.includes(l.target)) && (!selRepNodeidList.includes(l.source) && !selRepNodeidList.includes(l.target)))
							return l
					}
				});
				
				// Check do we need this portion
				nodedegobj = degfinder(actualdata);
				remelegp = RemNodeObj(nodedegobj);
				repelegp = RepNodeObj(nodedegobj);
				
				//console.log('remelegp',remelegp)
				
				$('#repeat_nodes').multiselect('dataprovider', repelegp);
				$('#remove_nodes').multiselect('dataprovider', remelegp);
			
				var didx = 0
				actualdata.links.forEach(function(l){
					if(typeof l.source=="object"){
						if (selRepNodeidList.includes(l.source.id)){
							if (l.target.rev>0){
								updatednodes.push({id: l.source.id + didx, name:l.source.name, type: l.source.type, x: l.source.x + Math.random()*10, y:l.source.y + Math.random()*10, vx:0, vy:0, r: l.source.r});
								updatedlinks.push({source: l.source.id + didx, target: l.target, strength: l.strength, id: l.id});
								updatedlinks.push({source: l.target, target: l.source.id + didx, strength: l.strength, id: l.id});
							}
							else{
								updatednodes.push({id: l.source.id + didx, name: l.source.name, type: l.source.type, x: l.source.x + Math.random()*10, y: l.source.y + Math.random()*10, vx: 0, vy: 0, r: l.source.r});
								updatedlinks.push({source: l.source.id + didx, target: l.target, strength: l.strength, id: l.id});
							}
							didx++;
						}
						else if (selRepNodeidList.includes(l.target.id) && l.source.rev==0){
							updatednodes.push({id: l.target.id + didx, name: l.target.name, type: l.target.type, x: l.target.x + Math.random()*10, y: l.target.y + Math.random()*10, vx: 0, vy: 0, r: l.source.r});
							updatedlinks.push({target: l.target.id + didx, source: l.source, strength: l.strength, id: l.id});
							didx++;
						}
					}
					else{
						if (selRepNodeidList.includes(l.source)){
							var nodm = actualdata.nodes.filter(function(d){
								if (l.source == d.id && d.type=="M"){
									return d 
								}
							});
							if (l.target.rev>0){
								updatednodes.push({id: l.source + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
								updatedlinks.push({source: l.source + didx, target: l.target, strength: l.strength, id: l.id});
								updatedlinks.push({source: l.target, target: l.source + didx, strength: l.strength, id: l.id});
							}
							else{
								updatednodes.push({id:l.source + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
								updatedlinks.push({source: l.source + didx, target: l.target, strength: l.strength, id: l.id});
							}
							didx++;
						}
						else if (selRepNodeidList.includes(l.target)){
							var nodr = actualdata.nodes.filter(function(d){
								if (l.source == d.id && d.type=="R"){
									return d 
								}
							});
							var nodm = actualdata.nodes.filter(function(d){
								if (l.target == d.id && d.type=="M"){
									return d 
								}
							});
							if (nodr.rev==0){
								updatednodes.push({id: l.target + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
								updatedlinks.push({target: l.target + didx, source: l.source, strength: l.strength, id: l.id});
								didx++;
							}
						}
					}
				});
				
				var upjsonobj1 = {nodes:updatednodes, links:updatedlinks, boxes:jsonObj.boxes, labels: jsonObj.labels}
				Mainfunction(upjsonobj1);                  
			};
			
			var on_ele_rep_changed = function(){
				
				var ele_values = [];
				var ele_idvalues = [];
				var ref = d3.select('#repeat_nodes').node().selectedOptions;
				for (var i = 0; i < ref.length; i++) {
					actualdata.nodes.filter(function(d){
						if (d.name==ref[i].value)
							ele_idvalues.push(d.id)
					});
					ele_values.push(ref[i].value)
				}
				selRepNodeList = ele_values;
				selRepNodeidList = ele_idvalues;
			   
				nodedegobj = degfinder(actualdata);
				remelegp = RemNodeObj(nodedegobj);
				repelegp = RepNodeObj(nodedegobj);
				
				$('#repeat_nodes').multiselect('dataprovider', repelegp);
				$('#remove_nodes').multiselect('dataprovider', remelegp);
				
				var updatednodes = actualdata.nodes.filter(function(d){
					if (!selRemNodeidList.includes(d.id) && !selRepNodeidList.includes(d.id))
						return d
				});
				

				var updatedlinks = actualdata.links.filter(function(l){
					if (typeof l.source=="object"){
						if ((!selRemNodeidList.includes(l.source.id) && !selRemNodeidList.includes(l.target.id)) && (!selRepNodeidList.includes(l.source.id) && !selRepNodeidList.includes(l.target.id)))
							return l
					}
					else{
						if ((!selRemNodeidList.includes(l.source) && !selRemNodeidList.includes(l.target)) && (!selRepNodeidList.includes(l.source) && !selRepNodeidList.includes(l.target)))
							return l
					}
				});
											  
				var didx = 0
				actualdata.links.forEach(function(l){
					if(typeof l.source=="object"){
						if (selRepNodeidList.includes(l.source.id)){
							if (l.target.rev==1){
								updatednodes.push({id: l.source.id + didx, name:l.source.name, type: l.source.type, x: l.source.x + Math.random()*10, y:l.source.y + Math.random()*10, vx:0, vy:0, r: l.source.r, kegg_id: l.source.kegg_id});
								updatedlinks.push({source: l.source.id + didx, target: l.target, strength: l.strength, id: l.id, kegg_id: l.kegg_id});
								updatedlinks.push({source: l.target, target: l.source.id + didx, strength: l.strength, id: l.id, kegg_id: l.kegg_id});
								didx++;
							}
							else{
								updatednodes.push({id: l.source.id + didx, name: l.source.name, type: l.source.type, x: l.source.x + Math.random()*10, y: l.source.y + Math.random()*10, vx: 0, vy: 0, r: l.source.r, kegg_id: l.source.kegg_id});
								updatedlinks.push({source: l.source.id + didx, target: l.target, strength: l.strength, id: l.id, kegg_id: l.kegg_id});
								didx++;
							}
						}
						else if (selRepNodeidList.includes(l.target.id)){
							if (l.source.rev==0){
							updatednodes.push({id: l.target.id + didx, name: l.target.name, type: l.target.type, x: l.target.x + Math.random()*10, y: l.target.y + Math.random()*10, vx: 0, vy: 0, r: l.source.r, kegg_id: l.target.kegg_id});
							updatedlinks.push({target: l.target.id + didx, source: l.source, strength: l.strength, id: l.id, kegg_id: l.kegg_id});
							didx++;
							}
						}
					}
					else{
						//console.log("other",l.source)
						if (selRepNodeidList.includes(l.source)){
							var nodm = actualdata.nodes.filter(function(d){
								if (l.source == d.id && d.type=="M"){
									return d 
								}
							});
							var nodr = actualdata.nodes.filter(function(d){
								if (l.target == d.id && d.type=="R"){
									return d 
								}
							});
							//console.log("other",nodr["0"].rev)
							if (nodr["0"].rev==1){
								updatednodes.push({id: l.source + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
								updatedlinks.push({source: l.source + didx, target: l.target, strength: l.strength, id: l.id, kegg_id: l.kegg_id});
								updatedlinks.push({source: l.target, target: l.source + didx, strength: l.strength, id: l.id, kegg_id: l.kegg_id});
								didx++;
							}
							else{
								updatednodes.push({id:l.source + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r, kegg_id: l.source.kegg_id});
								updatedlinks.push({source: l.source + didx, target: l.target, strength: l.strength, id: l.id, kegg_id: l.kegg_id});
								didx++;
							}
						}
						else if (selRepNodeidList.includes(l.target)){
							var nodr = actualdata.nodes.filter(function(d){
								if (l.source == d.id && d.type=="R"){
									return d 
								}
							});
							var nodm = actualdata.nodes.filter(function(d){
								if (l.target == d.id && d.type=="M"){
									return d 
								}
							});
							if (nodr["0"].rev==0){
								updatednodes.push({id: l.target + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r, kegg_id: l.target.kegg_id});
								updatedlinks.push({target: l.target + didx, source: l.source, strength: l.strength, id: l.id, kegg_id: l.kegg_id});
								didx++;
							}
						}
					}
				});
//                                
				
				var upjsonobj1 = {nodes:updatednodes, links:updatedlinks, boxes:jsonObj.boxes, labels: jsonObj.labels};
				
				Mainfunction(upjsonobj1);                  
			};
			
			$('#remove_nodes').multiselect({
				buttonWidth: '265px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: false,
				enableCaseInsensitiveFiltering: false,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: false,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Remove element',
				onChange: on_ele_rem_changed,
				onSelectAll: on_ele_rem_changed,
				onDeselectAll: on_ele_rem_changed
			});
			
			$('#repeat_nodes').multiselect({
				buttonWidth: '265px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: false,
				enableCaseInsensitiveFiltering: false,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: false,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Repeat element',
				onChange: on_ele_rep_changed,
				onSelectAll: on_ele_rep_changed,
				onDeselectAll: on_ele_rep_changed
			});
			
			$('#remove_nodes').multiselect('dataprovider', remelegp);
			
			$('#repeat_nodes').multiselect('dataprovider', repelegp);
			
			var on_changed = function() {
				//console.log("this is ok")
				if(dataset==false){
					let finalupjsonobj_temp = {nodes:[], links:[], boxes:[], labels: [], images: []};
					
					Mainfunction(finalupjsonobj_temp);
					
					if (d3.select('#list_menu').node().selectedOptions.length>0){
						var subsys_values = [];
						var ref = d3.select('#list_menu').node().selectedOptions;
						for (var i = 0; i<ref.length; i++) {
							subsys_values.push(ref[i].value);
						};
						cor_subsys_values = [];
						//console.log('subsys_values',subsys_values)
						jsonObj.links.forEach(function(link) {
							if (subsys_values.includes(link.id)){
								if (typeof link.source=="string"){
									cor_subsys_values.push(link.source)
									cor_subsys_values.push(link.target)
								}
								else{
									cor_subsys_values.push(link.source.id)
									cor_subsys_values.push(link.target.id)
								}
							}
						});
						
						var uniquecor_subsys_values = [];
						$.each(cor_subsys_values, function(i, el){
							if($.inArray(el, uniquecor_subsys_values) === -1) uniquecor_subsys_values.push(el);
						});
						//console.log('uniquecor_subsys_values',uniquecor_subsys_values)
						var updatednodes = jsonObj.nodes.filter(function(d){
							if (uniquecor_subsys_values.includes(d.id))
								return d
						});

						var updatedlinks = jsonObj.links.filter(function(l){
							if (subsys_values.includes(l.id))
								return l
						});
						
						jsonObj.nodes.filter(function(d){
							if(d.id.includes('center'))
								updatednodes.push(d)
						});
						
						var upjsonobj = {nodes:updatednodes, links:updatedlinks, labels: jsonObj.labels, boxes: jsonObj.boxes, images: jsonObj.images}
						//console.log('upjsonobj',upjsonobj)
						nodedegobj = degfinder(upjsonobj);
						remelegp = RemNodeObj(nodedegobj);
						repelegp = RepNodeObj(nodedegobj);
						
						actualdata = upjsonobj;
						$('#remove_nodes').multiselect('dataprovider', remelegp);
						$('#repeat_nodes').multiselect('dataprovider', repelegp);
						
						var updatednodes = actualdata.nodes.filter(function(d){
							if (!selRemNodeidList.includes(d.id) && !selRepNodeidList.includes(d.id))
								return d
						});
						
						var updatedlinks = actualdata.links.filter(function(l){
							if (typeof l.source=="object"){
								if ((!selRemNodeidList.includes(l.source.id) && !selRemNodeidList.includes(l.target.id)) && (!selRepNodeidList.includes(l.source.id) && !selRepNodeidList.includes(l.target.id)))
									return l
							}
							else{
								if ((!selRemNodeidList.includes(l.source) && !selRemNodeidList.includes(l.target)) && (!selRepNodeidList.includes(l.source) && !selRepNodeidList.includes(l.target)))
									return l
							}
						});
						
						var didx = 0
						actualdata.links.forEach(function(l){
							if(typeof l.source=="object"){
								if (selRepNodeidList.includes(l.source.id)){
									if (l.target.rev>0){
										updatednodes.push({id: l.source.id + didx, name:l.source.name, type: l.source.type, x: l.source.x + Math.random()*10, y:l.source.y + Math.random()*10, vx:0, vy:0, r: l.source.r});
										updatedlinks.push({source: l.source.id + didx, target: l.target, strength: l.strength, id: l.id});
										updatedlinks.push({source: l.target, target: l.source.id + didx, strength: l.strength, id: l.id});
									}
									else{
										updatednodes.push({id: l.source.id + didx, name: l.source.name, type: l.source.type, x: l.source.x + Math.random()*10, y: l.source.y + Math.random()*10, vx: 0, vy: 0, r: l.source.r});
										updatedlinks.push({source: l.source.id + didx, target: l.target, strength: l.strength, id: l.id});
									}
									didx++;
								}
								else if (selRepNodeidList.includes(l.target.id) && l.source.rev==0){
									updatednodes.push({id: l.target.id + didx, name: l.target.name, type: l.target.type, x: l.target.x + Math.random()*10, y: l.target.y + Math.random()*10, vx: 0, vy: 0, r: l.source.r});
									updatedlinks.push({target: l.target.id + didx, source: l.source, strength: l.strength, id: l.id});
									didx++;
								}
							}
							else{
								if (selRepNodeidList.includes(l.source)){
									var nodm = actualdata.nodes.filter(function(d){
										if (l.source == d.id && d.type=="M"){
											return d 
										}
									});
									if (l.target.rev>0){
										updatednodes.push({id: l.source + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
										updatedlinks.push({source: l.source + didx, target: l.target, strength: l.strength, id: l.id});
										updatedlinks.push({source: l.target, target: l.source + didx, strength: l.strength, id: l.id});
									}
									else{
										updatednodes.push({id:l.source + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
										updatedlinks.push({source: l.source + didx, target: l.target, strength: l.strength, id: l.id});
									}
									didx++;
								}
								else if (selRepNodeidList.includes(l.target)){
									var nodr = actualdata.nodes.filter(function(d){
										if (l.source == d.id && d.type=="R"){
											return d 
										}
									});
									var nodm = actualdata.nodes.filter(function(d){
										if (l.target == d.id && d.type=="M"){
											return d 
										}
									});
									if (nodr.rev==0){
										updatednodes.push({id: l.target + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
										updatedlinks.push({target: l.target + didx, source: l.source, strength: l.strength, id: l.id});
										didx++;
									}
								}
							}
						});
						
						var finalupjsonobj = {nodes:updatednodes, links:updatedlinks, boxes:jsonObj.boxes, labels: jsonObj.labels, images: jsonObj.images};
						
						let xmin = 1000000.0
						let xmax = -100000.0
						let ymin = 1000000.0
						let ymax = -100000.0
						
						updatednodes.forEach(function(d){
							if(d.x<xmin)
								xmin = d.x
							if(d.x>xmax)
								xmax = d.x
							if(d.y<ymin)
								ymin = d.y
							if(d.y>ymax)
								ymax = d.y
							//console.log('xmax',xmax)
						})
						
						if(xmax>0.0)
							xmax = xmax + 100.0
						else if(xmax<0.0)
							xmax = xmax - 100.0
						
						if(ymax>0.0)
							ymax = ymax + 200.0
						else if(ymax<0.0)
							ymax = ymax - 200.0
						
						//console.log('ymax',ymax)
						//console.log('xmax',xmax)
						
						let updatednodes_temp = []
						let updatedlinks_temp = []
						let updatedboxes_temp = []
						let updatedlabels_temp = []
						let updatedimages_temp = []
						
						let ab_ref = d3.select('#ab_data').node().selectedOptions;
						let data_ref = d3.select('#data_group').node().selectedOptions;
						
						for(let i=0; i<data_ref.length; i++){
							for(let j=0; j<ab_ref.length; j++){
								updatednodes.forEach(function(d){
									let keys = Object.keys(d)
									let dic = {}
									keys.forEach(function(key){
										if(key=="id")
											dic[key] = d[key] + "_" + i.toString() + "_" + j.toString();
										else if(key=="x")
											dic[key] = d[key] + (xmax)*j
										else if(key=="y")
											dic[key] = d[key] + (ymax)*i
										else
											dic[key] = d[key]
									})
									updatednodes_temp.push(dic)
								})
								
								updatedlinks.forEach(function(d){
									let keys = Object.keys(d)
									let dic = {}
									keys.forEach(function(key){
										if(key=="id")
											dic[key] = d[key] + "_" + i.toString() + "_" + j.toString();
										else if(key=="source")
											dic[key] = d[key].id + "_" + i.toString() + "_" + j.toString();
										else if(key=="target")
											dic[key] = d[key].id + "_" + i.toString() + "_" + j.toString();
										else
											dic[key] = d[key]
									})
									updatedlinks_temp.push(dic)
								})
								
								jsonObj.boxes.forEach(function(d){
									let keys = Object.keys(d)
									let dic = {}
									keys.forEach(function(key){
										if(key=="cor"){
											let cor_temp = d[key];
											cor_temp.forEach(function(c){
												c.x = c.x + (xmax)*j
												c.y = c.y + (ymax)*i
											})
											dic[key] = cor_temp;
										}
										else
											dic[key] = d[key]
									})
									updatedboxes_temp.push(dic)
								})
								
								jsonObj.labels.forEach(function(d){
									let keys = Object.keys(d)
									let dic = {}
									keys.forEach(function(key){
										if(key=="x")
											dic[key] = d[key] + (xmax)*j
										else if(key=="y")
											dic[key] = d[key] + (ymax)*i
										else
											dic[key] = d[key]
									})
									updatedlabels_temp.push(dic)
								})
								
								jsonObj.images.forEach(function(d){
									let keys = Object.keys(d)
									let dic = {}
									keys.forEach(function(key){
										if(key=="x")
											dic[key] = d[key] + (xmax)*j
										else if(key=="y")
											dic[key] = d[key] + (ymax)*i
										else
											dic[key] = d[key]
									})
									updatedimages_temp.push(dic)
								})
							}							
						}
						
						finalupjsonobj_temp = {nodes:updatednodes_temp, links:updatedlinks_temp, boxes:updatedboxes_temp, labels: updatedlabels_temp, images: updatedimages_temp};
						actualdata = finalupjsonobj_temp
						Mainfunction(finalupjsonobj_temp); 
					}
				}
				else{
					var subsys_values = [];
					var ref = d3.select('#list_menu').node().selectedOptions;
					for (var i = 0; i<ref.length; i++) {
						subsys_values.push(ref[i].value);
					};
					//console.log('jsonobj',jsonObj)
					cor_subsys_values = [];
					
					jsonObj.links.forEach(function(link) {
						if (subsys_values.includes(link.id)){
							if (typeof link.source=="string"){
								cor_subsys_values.push(link.source)
								cor_subsys_values.push(link.target)
							}
							else{
								cor_subsys_values.push(link.source.id)
								cor_subsys_values.push(link.target.id)
							}
						}
					});
					
					var uniquecor_subsys_values = [];
					$.each(cor_subsys_values, function(i, el){
						if($.inArray(el, uniquecor_subsys_values) === -1) uniquecor_subsys_values.push(el);
					});
					//console.log('uniquecor_subsys_values',uniquecor_subsys_values)
					var updatednodes = jsonObj.nodes.filter(function(d){
						if (uniquecor_subsys_values.includes(d.id))
							return d
					});

					var updatedlinks = jsonObj.links.filter(function(l){
						if (subsys_values.includes(l.id))
							return l
					});
					
					//jsonObj.nodes.filter(function(d){
					//	if(d.id.includes('center'))
					//		updatednodes.push(d)
					//});
					
					var upjsonobj = {nodes:updatednodes, links:updatedlinks, labels: jsonObj.labels, boxes: jsonObj.boxes, images: jsonObj.images}
					//console.log('upjsonobj',upjsonobj)
					nodedegobj = degfinder(upjsonobj);
					
					//console.log('nodedegobj',nodedegobj)
					
					remelegp = RemNodeObj(nodedegobj);
					repelegp = RepNodeObj(nodedegobj);
					
					//console.log('remelegp',remelegp)
					
					actualdata = upjsonobj;
					$('#remove_nodes').multiselect('dataprovider', remelegp);
					$('#repeat_nodes').multiselect('dataprovider', repelegp);
					
					var updatednodes = actualdata.nodes.filter(function(d){
						if (!selRemNodeidList.includes(d.id) && !selRepNodeidList.includes(d.id))
							return d
					});
					
					var updatedlinks = actualdata.links.filter(function(l){
						if (typeof l.source=="object"){
							if ((!selRemNodeidList.includes(l.source.id) && !selRemNodeidList.includes(l.target.id)) && (!selRepNodeidList.includes(l.source.id) && !selRepNodeidList.includes(l.target.id)))
								return l
						}
						else{
							if ((!selRemNodeidList.includes(l.source) && !selRemNodeidList.includes(l.target)) && (!selRepNodeidList.includes(l.source) && !selRepNodeidList.includes(l.target)))
								return l
						}
					});
					
					var didx = 0
					actualdata.links.forEach(function(l){
						if(typeof l.source=="object"){
							if (selRepNodeidList.includes(l.source.id)){
								if (l.target.rev>0){
									updatednodes.push({id: l.source.id + didx, name:l.source.name, type: l.source.type, x: l.source.x + Math.random()*10, y:l.source.y + Math.random()*10, vx:0, vy:0, r: l.source.r});
									updatedlinks.push({source: l.source.id + didx, target: l.target, strength: l.strength, id: l.id});
									updatedlinks.push({source: l.target, target: l.source.id + didx, strength: l.strength, id: l.id});
								}
								else{
									updatednodes.push({id: l.source.id + didx, name: l.source.name, type: l.source.type, x: l.source.x + Math.random()*10, y: l.source.y + Math.random()*10, vx: 0, vy: 0, r: l.source.r});
									updatedlinks.push({source: l.source.id + didx, target: l.target, strength: l.strength, id: l.id});
								}
								didx++;
							}
							else if (selRepNodeidList.includes(l.target.id) && l.source.rev==0){
								updatednodes.push({id: l.target.id + didx, name: l.target.name, type: l.target.type, x: l.target.x + Math.random()*10, y: l.target.y + Math.random()*10, vx: 0, vy: 0, r: l.source.r});
								updatedlinks.push({target: l.target.id + didx, source: l.source, strength: l.strength, id: l.id});
								didx++;
							}
						}
						else{
							if (selRepNodeidList.includes(l.source)){
								var nodm = actualdata.nodes.filter(function(d){
									if (l.source == d.id && d.type=="M"){
										return d 
									}
								});
								if (l.target.rev>0){
									updatednodes.push({id: l.source + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
									updatedlinks.push({source: l.source + didx, target: l.target, strength: l.strength, id: l.id});
									updatedlinks.push({source: l.target, target: l.source + didx, strength: l.strength, id: l.id});
								}
								else{
									updatednodes.push({id:l.source + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
									updatedlinks.push({source: l.source + didx, target: l.target, strength: l.strength, id: l.id});
								}
								didx++;
							}
							else if (selRepNodeidList.includes(l.target)){
								var nodr = actualdata.nodes.filter(function(d){
									if (l.source == d.id && d.type=="R"){
										return d 
									}
								});
								var nodm = actualdata.nodes.filter(function(d){
									if (l.target == d.id && d.type=="M"){
										return d 
									}
								});
								if (nodr.rev==0){
									updatednodes.push({id: l.target + didx, name: nodm["0"].name, type: nodm["0"].type, r: nodm["0"].r});
									updatedlinks.push({target: l.target + didx, source: l.source, strength: l.strength, id: l.id});
									didx++;
								}
							}
						}
					});
					
					var finalupjsonobj = {nodes:updatednodes, links:updatedlinks, boxes:jsonObj.boxes, labels: jsonObj.labels, images: jsonObj.images};
					
					Mainfunction(finalupjsonobj); 
				}					 
			};  
			
			$('#list_menu').multiselect({
				buttonWidth: '265px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: true,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Select Rxns',
				onChange: on_changed,
				onSelectAll: on_changed,
				onDeselectAll: on_changed
			});                                
			
			$('#list_menu').multiselect('dataprovider', subsysgp);
			
			function find_node(arr){
				var metabonodes = []
				var rxnnodes = []
				arr.nodes.forEach(function(val){
					if (val.type=="R"){
						rxnnodes.push({label: val.name, value: val.name})
					}
					else{
						metabonodes.push({label: val.name, value: val.name})
					}
				});
				
				var unimetabonodes = removeDuplicates(metabonodes, "value");
				var unirxnnodes = removeDuplicates(rxnnodes, "value");
				
				unimetabonodes.sort(compare)
				unirxnnodes.sort(compare)
				
				return [{label:"metabolites", children: unimetabonodes},{label:"Reactions",children: unirxnnodes}]
			}
			
			var netgroup = {'label':'None','children':[{'label':'None','value':'None'}]}
			
			var on_ele_selec_changed = function(){ 
				var ele_values = [];
				var ref = d3.select('#show_names').node().selectedOptions;
				for (var i = 0; i < ref.length; i++) {
					ele_values.push(ref[i].value)
				}
				
				gp.selectAll('.nodes').filter(function(d){
					if(ele_values.includes(d.name)){
						var ele = d3.select(this);
						ele.classed('selected',true);
						ele.attr('r',20.0)
					}
					else{
						var ele = d3.select(this);
						ele.classed('selected',false);
						ele.attr('r',8.0)
					}
				})    
			};
			
			$('#show_names').multiselect({
				buttonWidth: '265px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: true,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Find element',
				onChange: on_ele_selec_changed,
				onSelectAll: on_ele_selec_changed,
				onDeselectAll: on_ele_selec_changed
			});
						
			$('#show_names').multiselect('dataprovider', netgroup);

			var SecMetastatus = 1;
															
			var cdata = {}, cdata_temp = {}, cdata_final = {};
			var data_group = [];
			var time_data = [];
			var ab_data = [];
			var Gval,Abval,tval,timedata;
			var base_val = 10.0;
			var scaling_val = 1.0;
			
			var on_gpdata_changed = function(){
				if(dataset==true){
					let ele_values = [];
					let ref = d3.select('#data_group').node().selectedOptions;
					for (let i = 0; i < ref.length; i++) {
						ele_values.push(ref[i].value)
					}
					Gval = ele_values[0]
					//console.log('gpdata_changed',Gval,Abval,tval)
					updateNet(cdata_final,Gval,Abval,tval);
				}
			};
			
			$('#data_group').multiselect({
				buttonWidth: '87px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: true,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Data group1',
				onChange: on_gpdata_changed,
				onSelectAll: on_gpdata_changed,
				onDeselectAll: on_gpdata_changed
			}); 
			
			var on_abdata_changed = function(){
				if(dataset==true){
					let ele_values = [];
					let ref = d3.select('#ab_data').node().selectedOptions;
					for (let i = 0; i < ref.length; i++) {
						ele_values.push(ref[i].value)
					}
					Abval = ele_values[0]
					//console.log('abdata_changed',Gval,Abval,tval)
					updateNet(cdata_final,Gval,Abval,tval);
				}
			};
			
			$('#ab_data').multiselect({
				buttonWidth: '87px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: true,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Data group2',
				onChange: on_abdata_changed,
				onSelectAll: on_abdata_changed,
				onDeselectAll: on_abdata_changed
			});
			
			var on_timedata_changed = function(){
				if(dataset==true){
					let ele_values = [];
					let ref = d3.select('#time_data').node().selectedOptions;
					for (let i = 0; i < ref.length; i++) {
						ele_values.push(ref[i].value)
					}
					tval = ele_values[0];
					updateNet(cdata_final,Gval,Abval,tval);
				}
				else{
					let ele_values = [];
					let ref = d3.select('#time_data').node().selectedOptions;
					for (let i = 0; i < ref.length; i++) {
						ele_values.push(ref[i].value)
					}
					tval = ele_values[0];
					let ab_ref = d3.select('#ab_data').node().selectedOptions;
					let data_ref = d3.select('#data_group').node().selectedOptions;
					Multi_updateNet(cdata_final,ab_ref,data_ref,tval);
				}
			};
			
			$('#time_data').multiselect({
				buttonWidth: '87px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: true,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Data group3',
				onChange: on_timedata_changed,
				onSelectAll: on_timedata_changed,
				onDeselectAll: on_timedata_changed
			});
			
			$('#data_group').multiselect('dataprovider', data_group);
			
			$('#ab_data').multiselect('dataprovider', ab_data);

			$('#time_data').multiselect('dataprovider', time_data);
			
			var on_var_para_changed = function(){
				let ele_values = [];
				let ref = d3.select('#var_para').node().selectedOptions;
				for (let i = 0; i < ref.length; i++) {
					ele_values.push(ref[i].value)
				}
				if(ele_values[0]=='base-val'){
					// Do nothing
				}
				
				else{
					// Do nothing
				}
				//updateNet(cdata,Gval,Abval,tval);
			};
			
			$('#var_para').multiselect({
				buttonWidth: '130px',
				maxHeight: 200,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: true,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Parameters',
				onChange: on_var_para_changed,
				onSelectAll: on_var_para_changed,
				onDeselectAll: on_var_para_changed
			});
			
			//$('#var_para').multiselect('dataprovider', variable_para);
			
			var on_assign_gp_changed = function(){
				let ele_values = [];
				let ref = d3.select('#assign_gp').node().selectedOptions;
				for (let i = 0; i < ref.length; i++) {
					ele_values.push(ref[i].value)
				}
				//console.log('group is assigned')
				//tval = ele_values[0];
				gp.selectAll(".selected").each(function(d){
					var ele = d3.select(this)
					ele.attr('type', ele_values[0]);
					d.type = ele_values[0]
				})
				
			};
			
			$('#assign_gp').multiselect({
				buttonWidth: '130px',
				maxHeight: 400,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: true,
				enableCaseInsensitiveFiltering: true,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: true,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Assign group',
				onChange: on_assign_gp_changed,
				onSelectAll: on_assign_gp_changed,
				onDeselectAll: on_assign_gp_changed
			});
			
			$('#assign_gp').multiselect('dataprovider', no_of_grps);
			
			var basic_Methods = [
				{'label': 'None', value: 'None'},
				{'label': 'Control Normalization', value: 'Control Normalization'},
				{'label': 'Control mean Normalization', value: 'Control mean Normalization'},
				{'label': 'log2 fold change', value: 'log2_fold_change'},
				{'label': 'fold change', value: 'fold_change'}
			]
			
			var Methods=[];
			
			var on_analysis_changed = function(){
				
				
				//cdata_temp = jQuery.extend(true, {}, cdata);
				
				Gval = d3.select('#data_group').node().selectedOptions[0].value;
				
				if(d3.select('#var_para').node().selectedOptions[0].value=="base-val"){
					base_val = this.value;
				}
				
				else if(d3.select('#var_para').node().selectedOptions[0].value=="variation"){
					scaling_val = this.value;
				}
				
			};
			
			$('#data_analysis').multiselect({
				buttonWidth: '265px',
				maxHeight: 200,
				enableClickableOptGroups: true,
				enableCollapsibleOptGroups: true,
				collapseOptGroupsByDefault: true,
				enableFiltering: false,
				enableCaseInsensitiveFiltering: false,
				filterPlaceholder: 'Cerca',
				includeSelectAllOption: false,
				selectAllJustVisible: false,
				selectAllText: 'Select All',
				nSelectedText: ' selected',
				allSelectedText: 'All selected',
				nonSelectedText: 'Methods',
				onChange: on_analysis_changed,
				onSelectAll: on_analysis_changed,
				onDeselectAll: on_analysis_changed
			});
			
			$('#data_analysis').multiselect('dataprovider', Methods);
			
			function updateNet(cdata,Gval,Abval,t){
			//	console.log("Gval",Gval)
				//console.log("Abval",Abval)
				//console.log("cdata_updated",cdata)
				settings = false;
				
				if(Gval!="None" && Abval!="None"){
					var arr_n = cdata[Gval][Abval]["nodes"]
					var arr_l = cdata[Gval][Abval]["links"]
				}
				else{
					var arr_n = cdata[data_group[0].value][ab_data[0].value]["nodes"]
					var arr_l = cdata[data_group[0].value][ab_data[0].value]["links"]
				}
				
				//console.log('arr_n',arr_n)
				//console.log('arr_l',arr_l)
				
				acc_max = 0.0
				acc_min = 1000000000.0
				
				for(let i=0; i<data_group.length; i++){
					for(let j=0; j<ab_data.length; j++){
						if(ab_data[j].value!="C"){
							cdata[data_group[i].value][ab_data[j].value]["nodes"].forEach(function(val){
								time_data.forEach(function(t){
									if(val[t.value]>acc_max)
										acc_max = val[t.value]
									if(val[t.value]<acc_min)
										acc_min = val[t.value]
								})
							});
						}
					}
				}
				
				if(Math.abs(acc_max-base_val)>Math.abs(acc_min-base_val))
					acc_min = acc_max-2.0*base_val
				
				if(Math.abs(acc_max-base_val)<Math.abs(acc_min-base_val))
					acc_max = -acc_min + 2.0*base_val
				
				//console.log('actual_data_nodes',actualdata.nodes)
				
				actualdata.nodes.forEach(function(d){
					no_of_grps.forEach(function(gp){
						if(d.type==gp.value){
							var found = 0
							arr_n.filter(function(n){
								if (n.name.toUpperCase()==d.name.toUpperCase() && n.gp==d.type){
									//console.log(n.gp)
									if (n[t]==undefined){
										d.r = 8.0
										if(d.type=='R')
											d.fill = '#d3d3d3'
										else
											d.fill = 'white'
									}
									else{
										d.r = n[t]
										if(Gval=="None" || Abval=="None"){
											d.r = 8.0
											if(d.type=='R')
												d.fill = '#d3d3d3'
											else
												d.fill = 'white'
										}
										else{
											if(!d3.select("#invert").property("checked")){
												d.fill = colorScale(200.0- (1.0 - (n[t] - acc_min)/(acc_max-acc_min))*200.0)
											}
											else if(d.type=="R"){
												return '#d3d3d3'
											}
											else{
												d.fill = colorScale((1.0 - (n[t] - acc_min)/(acc_max-acc_min))*200.0)
											}
										}
									}
									found = 1
								}
							});
						}
						if (found==0) {
							d.r = 8.0
							if(d.type=='R')
								d.fill = '#d3d3d3'
							else
								d.fill = 'white'
						}									
					})
				});	
			
				actualdata.links.forEach(function(d){
					actualdata.nodes.forEach(function(n){
						if(n.id==d.id){
							arr_n.filter(function(l){
								if (n.name.toUpperCase()==l.name.toUpperCase()){
									var val = 2.0
									if (l[t]==undefined){
										val = 2.0
									}
									else{
										val =  l[t]
										//console.log('val',val)
									}
									d.strength = val
									if(Gval=="None" || Abval=="None"){
										d.strength = 2.0
									}
									//console.log('l[t]',l[t])
								}
							});
						}
					})
					
				});	
				//console.log(actualdata.links)
				
				if(dataset==true){
					Mainfunction(actualdata);
				}
				else{
					Mainfunction(actualdata);
				}
			};
			
			function Multi_updateNet(cdata,Abval,Gval,t){
				settings = false;
				for(let i=0; i<Gval.length;i++){
					for(let j=0; j<Abval.length; j++){
						
						if(Gval[i].value!="None" && Abval[j].value!="None"){
							var arr_n = cdata[Gval[i].value][Abval[j].value]["nodes"]
							var arr_l = cdata[Gval[i].value][Abval[j].value]["links"]
						}
						else{
							var arr_n = cdata[data_group[0].value][ab_data[0].value]["nodes"]
							var arr_l = cdata[data_group[0].value][ab_data[0].value]["links"]
						}
						
						//var arr_n = cdata[Gval[i].value][Abval[j].value]["nodes"]
						//var arr_l = cdata[Gval[i].value][Abval[j].value]["links"]		
						
						actualdata.nodes.forEach(function(d){
							let group = d.id.split("_")
							let lastele = group.pop();
							let secondlastele = group.pop();
							if(lastele==j && secondlastele==i){
								no_of_grps.forEach(function(gp){
									if(d.type==gp.value){
										var found = 0
										arr_n.filter(function(n){
											if (n.name.toUpperCase()==d.name.toUpperCase() && n.gp==d.type){
												//console.log(n.gp)
												if (n[t]==undefined){
													d.r = 8.0
													if(d.type=='R')
														d.fill = '#d3d3d3'
													else
														d.fill = 'white'
												}
												else{
													d.r = n[t]
													if(Gval=="None" || Abval=="None"){
														d.r = 8.0
														if(d.type=='R')
															d.fill = '#d3d3d3'
														else
															d.fill = 'white'
													}
													else{
														if(!d3.select("#invert").property("checked")){
															d.fill = colorScale(200.0- (1.0 - (n[t] - acc_min)/(acc_max-acc_min))*200.0)
														}
														else if(d.type=="R"){
															return '#d3d3d3'
														}
														else{
															d.fill = colorScale((1.0 - (n[t] - acc_min)/(acc_max-acc_min))*200.0)
														}
													}
												}
												found = 1
											}
										});
									}
									if (found==0) {
										d.r = 8.0
										if(d.type=='R')
											d.fill = '#d3d3d3'
										else
											d.fill = 'white'
									}									
								})
							}
						});	
					
						actualdata.links.forEach(function(d){
							actualdata.nodes.forEach(function(n){
								if(n.id==d.id){
									let group = d.id.split("_")
									let lastele = group.pop();
									let secondlastele = group.pop();
									if(lastele==j && secondlastele==i){
										arr_n.filter(function(l){
											if (n.name.toUpperCase()==l.name.toUpperCase()){
												var val = 2.0
												if (l[t]==undefined){
													val = 2.0
												}
												else{
													val =  l[t]
												}
												d.strength = val
												if(Gval=="None" || Abval=="None"){
													d.strength = 2.0
												}
												//console.log('l[t]',l[t])
											}
										});
									}
								}
							})
						});		
					}
				}
				Mainfunction(actualdata);
			};

			var undo_stack = [];
			var redo_stack = [];
			
			function xml2obj(xmlDoc) {
				var JSONobj = {};
				
				let pathway = xmlDoc.getElementsByTagName("pathway")[0];
				
				var json_pathway = {"name":pathway.getAttribute('name'),
									"org":pathway.getAttribute('org'),
									"number":pathway.getAttribute('number'),
									"title":pathway.getAttribute('title'),
									"image":pathway.getAttribute('image'),
									"link":pathway.getAttribute('link')
									}
				
				let entry = xmlDoc.getElementsByTagName("entry");
				let relation = xmlDoc.getElementsByTagName("relation");
				let reaction = xmlDoc.getElementsByTagName("reaction");
				
				var entry_arr = [];
				for(let i=0; i<entry.length; i++){
					let grp = entry[i].getElementsByTagName('graphics')[0];
					let grp_arr = {"name":grp.getAttribute('name'),
									"bgcolor":grp.getAttribute('bgcolor'),
									"fgcolor":grp.getAttribute('fgcolor'),
									"type":grp.getAttribute('type'),
									"x":grp.getAttribute('x'),
									"y":grp.getAttribute('y'),
									"width":grp.getAttribute('width'),
									"height":grp.getAttribute('height')
								}
					if(entry[i].getAttribute('type')=='compound'||entry[i].getAttribute('type')=='map'){
						entry_arr.push({"id":entry[i].getAttribute('id'),
										"name":entry[i].getAttribute('name'),
										"type":entry[i].getAttribute('type'),
										"link":entry[i].getAttribute('link'),
										"graphics":grp_arr
										});
					}
					else{
						entry_arr.push({"id":entry[i].getAttribute('id'),
										"name":entry[i].getAttribute('name'),
										"type":entry[i].getAttribute('type'),
										"link":entry[i].getAttribute('link'),
										"reaction":entry[i].getAttribute('reaction'),
										"graphics":grp_arr
										});
					}
				}	
				
				var relation_arr = [];
				for(let i=0; i<relation.length; i++){
					let subty = relation[i].getElementsByTagName('subtype')[0]
					let subtype_obj = {"name": subty.getAttribute('name'),
										"value":subty.getAttribute('value')
										}
					
					relation_arr.push({"entry1":relation[i].getAttribute('entry1'),
										"entry2":relation[i].getAttribute('entry2'),
										"type":relation[i].getAttribute('type'),
										"subtype":subtype_obj
									})
				}
				
				var reaction_arr = []
				for(let i=0; i<reaction.length; i++){
					let reac = reaction[i];
					let subs = reaction[i].getElementsByTagName('substrate');
					let prod = reaction[i].getElementsByTagName('product');
					
					var substrate_arr = [];
					for(let j=0; j<subs.length;j++){
						substrate_arr.push({"id":subs[j].getAttribute('id'),
											"name":subs[j].getAttribute('name')
										});
					}
					
					var product_arr = [];
					for(let j=0; j<prod.length;j++){
						product_arr.push({"id":prod[j].getAttribute('id'),
											"name":prod[j].getAttribute('name')
										});
					}
					
					reaction_arr.push({"id":reaction[i].getAttribute('id'),
										"name":reaction[i].getAttribute('name'),
										"type":reaction[i].getAttribute('type'),
										"substrate":substrate_arr,
										"product":product_arr
									})
				}
					
				JSONobj = {"pathway":json_pathway,
							"entry":entry_arr,
							"relation":relation_arr,
							"reaction":reaction_arr}
								
				//console.log(JSONobj)
				return JSONobj;
			};
			
			function obj2xml(JSONobj) {
				
				let nids = [];
				
				d3.select("#network").select(".nodes_g").selectAll(".nodes").each(function(d){
					let x = d3.select(this);
					//console.log(x)
					if(x.opacity==1){
						//console.log(x)
					}
					//x.attr('opacity', 1.0);
					//x.classed('selected',false);
				});
				
				JSONobj["nodes"].forEach(function(n){
					//console.log(n)
					if(n.opacity==1){
						nids.push(n.id);
						JSONobj.entry.forEach(function(x){
							if(x.id==n.id && x.type=="ortholog"){
								x.type = "gene";
								x.name = n.gene;
								x.link = n.gene_link;
							}
						})
					}
				})
				
				var xmlDoc = document.implementation.createDocument(null, "",null);
				
				var pathway = xmlDoc.createElement("pathway");
				
				pathwayattr = ["name","org","number","title","image","link"]
				
				pathwayattr.forEach(function(atr){
					pathway.setAttribute(atr, JSONobj.pathway[atr]);
				})
				
				JSONobj.entry.forEach(function(x){
					//if(nids.includes(x.id)){
					var entryattr = ["id","name","type","link"]
					var entry = xmlDoc.createElement("entry");
					entryattr.forEach(function(atr){
						entry.setAttribute(atr,x[atr])
						if(atr=="type" && (x[atr]!="compound" && x[atr]!="map"))
							entry.setAttribute("reaction",x["reaction"])	
					});
					
					var graphattr = ["name","fgcolor","bgcolor","type","x","y","width","height"]
					var graphics = xmlDoc.createElement("graphics");
					graphattr.forEach(function(atr){
						graphics.setAttribute(atr,x["graphics"][atr])
					});
					
					entry.appendChild(graphics)
					pathway.appendChild(entry)
					//}
				})
				
				JSONobj.relation.forEach(function(x){
					var relationattr = ["entry1","entry2","type"]
					var relation = xmlDoc.createElement("relation");
					relationattr.forEach(function(atr){
						relation.setAttribute(atr,x[atr])
					});
					
					var subtypeattr = ["name","value"];
					var subtype = xmlDoc.createElement("subtype");
					subtypeattr.forEach(function(atr){
						subtype.setAttribute(atr,x["subtype"][atr])
					});
					
					relation.appendChild(subtype)
					pathway.appendChild(relation)
				})
				
				JSONobj.reaction.forEach(function(x){
					if(nids.includes(x.id)){
						var reactionattr = ["id","name","type"]
						var reaction = xmlDoc.createElement("reaction");
						reactionattr.forEach(function(atr){
							reaction.setAttribute(atr,x[atr])
						});
						
						var substrateattr = ["id","name"];
						
						x["substrate"].forEach(function(sub){
							var substrate = xmlDoc.createElement("substrate");
							substrateattr.forEach(function(atr){
								substrate.setAttribute(atr,sub[atr])
							})
							reaction.appendChild(substrate)
						});
						
						var productattr = ["id","name"];
						x["product"].forEach(function(pro){
							var product = xmlDoc.createElement("product");
							productattr.forEach(function(atr){
								product.setAttribute(atr,pro[atr])
							})
							reaction.appendChild(product)
						});
						
						pathway.appendChild(reaction)
					}
				})
				
				xmlDoc.appendChild(pathway)
				
				// 1.) use XMLSerializer
				let xml = new XMLSerializer().serializeToString(xmlDoc);

				// 2.) remove xml namespace
				let xmlWithoutNamespace = xml.replace(' xmlns="http://www.w3.org/1999/xhtml"', '');

				// 3.) use vkbeautify or your other favorite library to pretty print
				//console.log(xml);
				//console.log(vkbeautify.xml(xmlWithoutNamespace));
				
				var filename = "";
				if(JSONobj.pathway['org']!='ko')
					filename+='KEGG'
				else
					filename+='Ortholog'
				filenameattr = ["org","title"]
				filenameattr.forEach(function(atr){
					filename+= "_" + JSONobj.pathway[atr]
				});
				
				filename = filename + ".xml"
				
				var pom = document.createElement('a');
				var bb = new Blob([vkbeautify.xml(xmlWithoutNamespace)], {type: 'text/plain'});

				pom.setAttribute('href', window.URL.createObjectURL(bb));
				pom.setAttribute('download', filename);

				pom.dataset.downloadurl = ['text/plain', pom.download, pom.href].join(':');
				pom.draggable = true; 
				pom.classList.add('dragout');
				pom.click();
				
			};
			
			d3.select("#download-kgml").on("click", function(){
				jsonObj.nodes = actualdata.nodes
				jsonObj.links = actualdata.links
				//console.log(jsonObj)
				//console.log(actualdata)
				obj2xml(jsonObj);
				//obj2xml(actualdata);
			})
			
			//console.log(document.querySelectorAll('*[id]')) 
			
			//////////////////////////   TO DRAW AND UPDATE NETWORK     ///////////////////////////////////. 
			function Mainfunction(data) {	
				
				var linkForce = d3
				  .forceLink()
				  .id(function (link) { return link.id });
				
				if (gravity>0){
					linkForce.strength(function (link) { return link.strength/2.0 });
				}
				
				else
					linkForce.strength(function (link) { return 0*link.strength });

				// sets the force in the x and y direction with center at specified locations
				const forceX = d3.forceX(width/2).strength(gravity)//0.015
				const forceY = d3.forceY(height/2).strength(gravity)	
				
				d3.select("#selectALL").on("change", function(d){
					if(d3.select(this).property("checked")){
						attributes_obj[1]["children"][1]["disabled"] = true;											
						attributes_obj[1]["children"][2]["disabled"] = true;											
						attributes_obj[2]["children"][0]["disabled"] = true;											
						attributes_obj[2]["children"][1]["disabled"] = true;											
						attributes_obj[3]["children"][0]["disabled"] = true;											
						attributes_obj[3]["children"][1]["disabled"] = true;											
						attributes_obj[3]["children"][2]["disabled"] = true;											
						$('#attributes').multiselect('dataprovider', attributes_obj);
					}
					else{
						var attributes_obj_up = attributes_obj;
						
						attributes_obj[1]["children"][1]["disabled"] = false;											
						attributes_obj[1]["children"][2]["disabled"] = false;
						attributes_obj[2]["children"][0]["disabled"] = false;											
						attributes_obj[2]["children"][1]["disabled"] = false;											
						attributes_obj[3]["children"][0]["disabled"] = false;											
						attributes_obj[3]["children"][1]["disabled"] = false;											
						attributes_obj[3]["children"][2]["disabled"] = false;											
						
						$('#attributes').multiselect('dataprovider', attributes_obj);
					}
				});
				
				d3.select("#freezekey").on("change", function(d) {
					if(d3.select(this).property("checked")){
						simulation.alphaMin(alphaMIN);
						simulation.stop();
					}
					else{
						simulation.alphaMin(0.01);
					}
				});			
				
				d3.select('#menu_options').select('.menu').select('#submenu1').select('#menu1').select("#image_file_upload").on("click", function(){
					var uploadfile = document.getElementById("image_file").click();
				})
				
				var image_files = [];
				var images = [];
				
				document.getElementById("image_file").addEventListener("change", function(event){
					var files = event.target.files; //FileList object
					
					for(let i =0;i<files.length; i++){							
						var filereader = new window.FileReader(); // makes the new file reader variable 
						//console.log(files[i])
						filereader.onload =  function(e){
							try{
								//image_files.push('x')
								/*
								jsonObj.images.forEach(function(m){
									if(m.name==files[i].name){
										images.push(m);
										load_image(e);
									}
								})
								*/
								
								var image = new Image();
								var imheight, imwidth;
								image.src = e.target.result;
								image.onload = function () {
									imheight = this.height;
									imwidth = this.width;
									
									try{
										if(jsonObj.images.length!=0){
											let found = 0
											jsonObj.images.forEach(function(m){
												if(m.name==files[i].name){
													//console.log("found",files[i].name)
													images.push(m)
													load_image(e);
													found = 1
												}
											})
											if(found==0){
												//console.log("Not found",files[i].name)
												images.push({name:files[i].name, x:200.0, y:200.0, width:imwidth, height:imheight})
												load_image(e);
											}
										}
										else{
											images.push({name:files[i].name, x:200.0, y:200.0, width:imwidth, height:imheight})
											load_image(e);
										}
									}
									catch(err){
										window.alert("Error parsing uploaded file\nerror message: " + err.message); 
										//console.log('error')
									}
								}
								//images.push({name:files[i].name,x:Math.random()*500.0,y:Math.random()*500.0})
								
								function load_image(e){								
									var img = gp.select(".images_g")
												.selectAll("image").data(images);
										
										img.enter()
										.append("image")
										.attr("xlink:href", e.target.result)
										.attr('width', function(d){
											if(d.width==undefined)
												return 200.0
											else
												return d.width
										})
										.attr('height', function(d){
											if(d.height==undefined)
												return 200.0
											else
												return d.height
										})
										.attr('name', function(d){
											return d.name
										})
										.attr('x', function(d){
											if(d.x==undefined)
												return 200.0
											else
												return d.x
										})
										.attr('y', function(d){
											if(d.y==undefined)
												return 200.0
											else
												return d.y
										})
										.on('click', change_shape)
										.call(dragHandler);
										
										img.exit().remove();
								}
							}
							catch(err){ 
								window.alert("Error parsing uploaded file\nerror message: " + err.message); 
								// display error message
							return;
							}
						};
						filereader.readAsDataURL(files[i]);
					}   
				});
				
				d3.select('#menu_options').select('.menu').select('#submenu4').select('#menu4').select('#insert_text').on('click', Insert_text)
				
				d3.select('#menu_options').select('.menu').select('#submenu4').select('#menu4').select('#insert_rectangle').on('click', Insert_rectangle)
				
				d3.select("#svg_main").on('contextmenu',function(){			
					mouse_cor.x = d3.mouse(this)[0];
					mouse_cor.y = d3.mouse(this)[1];
				})
				
				function Insert_text(){
					let newPoint = {'x':0.0,'y':0.0}								
					newPoint.x = (mouse_cor.x - zoomTrans.x)/zoomTrans.scale;
					newPoint.y = (mouse_cor.y - zoomTrans.y)/zoomTrans.scale;
					
					let newText1 = window.prompt("Enter the text", "");
					
					data.labels.push({text:newText1, x: newPoint.x, y: newPoint.y, font_size:12.0, fill: '#000000'})
					
					Add_label(data);
					
					//Mainfunction(data);
				}
				
				Add_label(data);
				
				function Add_label(data){
					var labelselement = d3.select("#network").select(".labels_g")
									.selectAll('.label')
									.data(data.labels);

					labelselement.enter().append('text')
							//.merge(labelselement)
							.text(function(d){
								return d.text
							})
							.attr('class','label')
							.attr('fill', function(d){
								return d.fill
							})
							.style('font-size', function(d){
								if(d.font_size==undefined){
									return 12.0
								}
								else{
									return d.font_size 
								}
							})
							.attr("font-family", "Arial")
							.attr('x',function(d){
								return d.x
							})
							.attr('y',function(d){
								return d.y
							})
							.on('click', function(){
									var ele = d3.select(this)
									ele.classed('selected', true)
							})
							.call(d3.drag()
							.on("drag", function () {
								var ele = d3.select(this)
								var new_x = parseFloat(ele.attr('x'))
								var new_y = parseFloat(ele.attr('y'))
								new_x += d3.event.dx
								new_y += d3.event.dy
									
								ele.attr("x", new_x)
								.attr("y", new_y);
							}))
							.call(make_editable_text);
				
					labelselement.exit().remove();	
					
				}
				
				var dragHandler = d3.drag()
					.on("drag", function () {
					
					if(gp.selectAll(".selected").size()==0){
						var ele = d3.select(this)
							var new_x = parseFloat(ele.attr('x'))
							var new_y = parseFloat(ele.attr('y'))
							new_x += d3.event.dx
							new_y += d3.event.dy
								
							ele.attr("x", new_x)
							.attr("y", new_y);
							//.moveToBack();	
					}	
					gp.selectAll(".selected").each(function(d){
						var ele = d3.select(this)
						var new_x = parseFloat(ele.attr('x'))
						var new_y = parseFloat(ele.attr('y'))
						new_x += d3.event.dx
						new_y += d3.event.dy
							
						ele.attr("x", new_x)
						.attr("y", new_y)
						.moveToBack();
					});
					
					gp.selectAll(".point").each(function(d){
						var ep = d3.select(this);
						var newp_x = parseFloat(ep.attr('cx'))
						var newp_y = parseFloat(ep.attr('cy'))
						newp_x += d3.event.dx
						newp_y += d3.event.dy
						ep.attr('cx',newp_x)
						ep.attr('cy',newp_y);
					});
				});
				
				function Insert_rectangle(){
					let newPoint = {'x':0.0,'y':0.0}								
					newPoint.x = (mouse_cor.x - zoomTrans.x)/zoomTrans.scale;
					newPoint.y = (mouse_cor.y - zoomTrans.y)/zoomTrans.scale;
					
					data.boxes.push({cor:[{x:newPoint.x, y: newPoint.y},{x:newPoint.x+100.0, y: newPoint.y+100.0}],stroke_width: '2px', fill:'orange'})
					
					draw_rectangle(data);
					//Mainfunction(data);
				}
				
				function draw_rectangle(data){
					var rec_box = d3.select("#network")
							.select(".bdry_g")
							//.selectAll("line")
							.selectAll('.bdry')
							.data(data.boxes)
							.enter()
							.append('rect')
							//.merge(rec_box)
							.attr('class', 'bdry')
							.attr('stroke-width', function(d){
								return d.stroke_width
							})
							.attr('stroke','black')
							.attr('fill', function(d){
								return d.fill
							})
							.attr('rx',function(d){
								if(d.rx==undefined)
									return 0.0
								else
									return d.rx
							})
							.attr('ry',function(d){
								if(d.ry==undefined)
									return 0.0
								else
									return d.ry
							})
							.attr('opacity',1.0)
							.on('click', change_shape);
			
					rec_box.exit().remove();
					updateRect();
					
					dragHandler(rec_box);
					
					function updateRect() {  
						rec_box
							.attr("x", function(d){ 
									return d.cor['1'].x - d.cor['0'].x > 0 ? d.cor['0'].x : d.cor['1'].x
								})
							.attr("y", function(d){
									return d.cor['1'].y - d.cor['0'].y > 0 ? d.cor['0'].y :  d.cor['1'].y
								})
							.attr("width", function(d){
									return Math.abs(d.cor['1'].x - d.cor['0'].x)
								})
							.attr("height", function(d){
									return Math.abs(d.cor['1'].y - d.cor['0'].y)
								});  		
					}
					
				}
				
				draw_rectangle(data);
				
				d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#movetofront').on('click', Move_to_front)
				
				d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#movetoback').on('click', Move_to_back)
				
				function Move_to_back(){
					d3.select('.bdry_g').moveToBack();
				}
				
				function Move_to_front(){
					d3.select('.bdry_g').moveToFront();
				}
				
				
				// remove selected nodes on clicking on the svg.
				rect.on('click', () => {
					
					d3.selectAll(".tooltip").remove();
					
					gp.selectAll('.nodes').each(function(d) {
						d.selected = false;
						d.previouslySelected = false;
					});
					
					gp.selectAll('.nodes').classed("selected", false);
					
					gp.selectAll('image').classed("selected", false);
					
					gp.selectAll('.point').remove();
					
					gp.selectAll('.bdry').classed("selected", false);
					
					//gp.selectAll('.bdry').style("fill", 'orange');
					
					gp.selectAll('.label').classed("selected", false);
					
					gp.selectAll('path').classed("selected", false);
					
					gp.selectAll(".edit").each(function(d){
						if(d.type!="R"){
							//console.log('d',d3.selectAll(".form"))
							d.name = d3.selectAll(".form")["_groups"]["0"]["0"].childNodes["2"].value.replace(/_/g," ");
							//d.kegg_id = d3.selectAll(".form")["_groups"]["0"]["0"].childNodes["8"].value;
							d3.select(this).text(d3.selectAll(".form")["_groups"]["0"]["0"].childNodes["2"].value.replace(/_/g," "));
							d3.select(this).classed("edit",false);
						}
						else{
							let inikegg_id = d.kegg_id;
							gp.select('.links_g').selectAll('path').each(function(l){
								var ele = d3.select(this);
								if(l.kegg_id==d.kegg_id){    
									l.kegg_id = d3.selectAll(".form")["_groups"]["0"]["0"].childNodes["14"].value;;
								}
							});
							//console.log('d',d3.selectAll(".form"))
							d.name = d3.selectAll(".form")["_groups"]["0"]["0"].childNodes["2"].value.replace(/_/g," ");
							d.subsystem = d3.selectAll(".form")["_groups"]["0"]["0"].childNodes["8"].value.replace(/_/g," ");
							d.gene = d3.selectAll(".form")["_groups"]["0"]["0"].childNodes["14"].value;
							d3.select(this).text(d3.selectAll(".form")["_groups"]["0"]["0"].childNodes["2"].value.replace(/_/g," "));
							d3.select(this).classed("edit",false);
						}
					})
					
					//console.log("form2",d3.selectAll(".form")["_groups"]["0"]["0"].childNodes["2"].value)
					//console.log("form2",d3.selectAll(".form")["_groups"]["0"]["0"].innerHTML)
					//console.log("form",form["_groups"]["0"]["0"].innerHTML)
					
					d3.selectAll(".form").remove();
					
				});
				
				
				function make_editable_text(){
					d3.select("#network").select(".labels_g")
						.selectAll(".label")
						.on('dblclick', function(d) {
							var newText = window.prompt("Enter the new node text", "");
							d3.select(this).text(newText);
						});
				};
				
				// handle downloading process of the data
					
				var downloadinput = d3.select("#download-input").on("click", function(){

					var nodeids = []; 
					var linkids = [];
					
					if(Object.keys(jsonObj).length==4){
						
						var saveimages = []
						gp.selectAll("image").each(function(d){
							//console.log(d)
							let ele = d3.select(this)
							saveimages.push({'name':ele.attr('name'),'x':ele.attr('x'),'y':ele.attr('y'),'width':ele.attr('width'),'height':ele.attr('height')})
						});
						 
						gp.selectAll('.nodes').each(function(d,i){
							var ele = d3.select(this)
							nodeids.push(ele.attr('id'))
						});
						
						gp.selectAll('path').each(function(d,i){
							var ele = d3.select(this)
							linkids.push(ele.attr('id'))
						});
						
						var rec_data = [];
						
						gp.selectAll('.bdry').each(function(d,i){
							var ele = d3.select(this)
							var dummy1 = {x: parseFloat(ele.attr('x')), y: parseFloat(ele.attr('y'))}
							var dummy2 = {x: parseFloat(ele.attr('x')) + parseFloat(ele.attr('width')), y: parseFloat(ele.attr('y')) + parseFloat(ele.attr('height'))}
							var dummyarr = []
							dummyarr.push(dummy1)
							dummyarr.push(dummy2)
							rec_data.push({cor:dummyarr, stroke_width: ele.style('stroke-width'), fill: ele.style('fill'), rx: ele.style('rx'), ry: ele.style('ry')})
						});
						
						var saveEdges = [];
						
						gp.select('.links_g').selectAll('path').each(function(d){
							var ele = d3.select(this);
							//console.log(ele.attr("class"))
							if(nodeids.includes(d.source.id) && nodeids.includes(d.target.id)){    
								saveEdges.push({source: d.source.id, target: d.target.id, strength: ele.style('stroke-width').split("p")[0], id: ele.attr('id'), d:ele.attr('d'), kegg_id: d.kegg_id, opacity:ele.attr('opacity'), stroke:ele.style('stroke'), subsystem: d.subsystem});
							}
						});
						
						var savenodes = [];
						var savetexts = [];
						
						//var positions = data.nodes.map(function(d) { return [d.x, d.y]; }); 
						
						gp.selectAll('.nodes').each(function(val){							
							var dummyval = {dx:0.0,dy:0.0,font_size:0.0}
							gp.selectAll('.texts').each(function(d,i){
								var ele1 = d3.select(this)
								if(ele1.attr('id').split('_curved_')[0]==val.id.split('_curved_')[0]){
									dummyval.dx = parseFloat(ele1.attr('dx'))
									dummyval.dy = parseFloat(ele1.attr('dy'))
									dummyval.font_size = parseFloat(ele1.attr('font-size'))
								}
							});
							var ele = d3.select(this)
							if(val.type=="R"){
								//savenodes.push({id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: val.x, y: val.y, r: val.r, dx: dummyval.dx, dy: dummyval.dy, font_size: dummyval.font_size, opacity: val.opacity, fill:ele.style('fill')})
								savenodes.push({id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: val.x, y: val.y, r: val.r, dx: dummyval.dx, dy: dummyval.dy, font_size: dummyval.font_size, opacity: ele.attr('opacity'), fill:ele.attr('fill'),rxn:val.rxn, gene:val.gene, rxn_link:val.rxn_link, gene_link:val.gene_link})
							}
							else{							
								//savenodes.push({id: val.id, kegg_id: val.kegg_id, name: val.name, subsystem: val.subsystem, type: val.type, x: val.x, y: val.y, r: val.r, dx: dummyval.dx, dy: dummyval.dy, font_size: dummyval.font_size, opacity: val.opacity, fill:ele.style('fill')})	
								savenodes.push({id: val.id, kegg_id: val.kegg_id, name: val.name, subsystem: val.subsystem, type: val.type, x: val.x, y: val.y, r: val.r, dx: dummyval.dx, dy: dummyval.dy, font_size: dummyval.font_size, opacity: ele.attr('opacity'), fill:ele.attr('fill'),cpd_link: val.cpd_link})	
							}
						})
						
						var savelabels = [];
						gp.selectAll('.label').each(function(d,i){
							var ele = d3.select(this)
							savelabels.push({text: ele.text(), x: parseFloat(ele.attr('x')) , y:parseFloat(ele.attr('y')), font_size: parseFloat(ele.style('font-size')) , fill: ele.style('fill')})
						});
						
						var blob = new Blob([window.JSON.stringify({"nodes": savenodes, "links": saveEdges, "boxes":rec_data, "labels": savelabels, "images":saveimages})], {type: "text/plain;charset=utf-8"});

						// saveas is a function from - cdn.jsdelivr.net/filesaver.js/0.1/FileSaver.min.js
						saveAs(blob, "X_Netfile.json");
					}
					else{
						
						var saveimages = []
						gp.select(".images_g").selectAll("image").each(function(d){
							let ele = d3.select(this)
							//console.log("file found",ele.attr('name'))
							saveimages.push({'name':ele.attr('name'),'x':ele.attr('x'),'y':ele.attr('y'),'width':ele.attr('width'),'height':ele.attr('height')})
						});
						
						//console.log("images found",saveimages.length)

						gp.selectAll('.nodes').each(function(d,i){
							var ele = d3.select(this)
							nodeids.push(ele.attr('id'))
						});
						
						gp.select('.links_g').selectAll('path').each(function(d,i){
							var ele = d3.select(this)
							linkids.push(ele.attr('id'))
						});
						
						//console.log('path',linkids)
						//console.log('nodes',nodeids)
						
						var rec_data = [];
						gp.selectAll('.bdry').each(function(d,i){
							var ele = d3.select(this)
							var dummy1 = {x: parseFloat(ele.attr('x')), y: parseFloat(ele.attr('y'))}
							var dummy2 = {x: parseFloat(ele.attr('x')) + parseFloat(ele.attr('width')), y: parseFloat(ele.attr('y')) + parseFloat(ele.attr('height'))}
							var dummyarr = []
							dummyarr.push(dummy1)
							dummyarr.push(dummy2)
							rec_data.push({cor:dummyarr, stroke_width: ele.style('stroke-width'), fill: ele.style('fill'), rx: ele.style('rx'), ry: ele.style('ry')})
						});
						
						var saveEdges = [];
						
						gp.select('.links_g').selectAll('path').each(function(d){
							var ele = d3.select(this);
							//console.log(ele.attr("class"))
							if(nodeids.includes(d.source.id) && nodeids.includes(d.target.id)){    
								saveEdges.push({source: d.source.id, target: d.target.id, strength: ele.style('stroke-width').split("p")[0], id: ele.attr('id'), d:ele.attr('d'), kegg_id: d.kegg_id, opacity:ele.attr('opacity'), stroke:ele.style('stroke'), subsystem: d.subsystem});
							}
						});
						
						//console.log('saveEdges',saveEdges)
						
						var savenodes = [];
						var savetexts = [];
						
						//var positions = data.nodes.map(function(d) { return [d.x, d.y]; }); 
						
						gp.selectAll('.nodes').each(function(val){
							var dummyval = {dx:0.0,dy:0.0,font_size:0.0}
							gp.selectAll('.texts').each(function(d,i){
								var ele1 = d3.select(this)
								//console.log(ele1.attr('id').split('_curved_')[0],val.id)
								if(ele1.attr('id').split('_curved_')[0]==val.id.split('_curved_')[0]){
									dummyval.dx = parseFloat(ele1.attr('dx'))
									dummyval.dy = parseFloat(ele1.attr('dy'))
									dummyval.font_size = parseFloat(ele1.attr('font-size'))
								}
							});
							var ele = d3.select(this);
							if(val.type=="R"){
								savenodes.push({id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: val.x, y: val.y, r: val.r, dx: dummyval.dx, dy: dummyval.dy, font_size: dummyval.font_size, opacity: ele.attr('opacity'), fill:ele.attr('fill'),rxn:val.rxn, gene:val.gene, rxn_link:val.rxn_link, gene_link:val.gene_link})
							}
							else{
								savenodes.push({id: val.id, kegg_id: val.kegg_id, name: val.name, subsystem: val.subsystem, type: val.type, x: val.x, y: val.y, r: val.r, dx: dummyval.dx, dy: dummyval.dy, font_size: dummyval.font_size, opacity: ele.attr('opacity'), fill:ele.attr('fill'),cpd_link: val.cpd_link})	
							}
						})
						
						//console.log(savenodes)
						
						var savelabels = [];
						gp.selectAll('.label').each(function(d,i){
							var ele = d3.select(this)
							savelabels.push({text: ele.text(), x: parseFloat(ele.attr('x')) , y:parseFloat(ele.attr('y')), font_size: parseFloat(ele.style('font-size')) , fill: ele.attr('fill')})
						});
						
						var filename = "";
						if(jsonObj.pathway!=undefined){
							if(jsonObj.pathway['org']!='ko')
								filename+='KEGG'
							else
								filename+='Ortholog'
							filenameattr = ["org","title"]
							filenameattr.forEach(function(atr){
								filename+= "_" + jsonObj.pathway[atr]
							});
						}
						else{
							filename = "X_netfile"
						}
						
						filename = filename + ".json"
						
						var blob = new Blob([window.JSON.stringify({"nodes": savenodes, "links": saveEdges, "boxes":rec_data, "labels": savelabels, "images":saveimages, "pathway": jsonObj.pathway, "entry":jsonObj.entry, "reaction":jsonObj.reaction, "relation": jsonObj.relation})], {type: "text/plain;charset=utf-8"});

						// saveas is a function from - cdn.jsdelivr.net/filesaver.js/0.1/FileSaver.min.js
						saveAs(blob, filename);
					}
					
					//download_datafile(cdata_final);
				});
				
				d3.select('#savesvg_datafile_json').on('click', function(){
					download_datafile(cdata_final);
				})

				function download_datafile(arr){
					//dosavedatafile = window.confirm("Press OK to save the datafile"); // return true value if press OK					
					//if(dosavedatafile){
					var blob = new Blob([window.JSON.stringify(arr)], {type: "text/plain;charset=utf-8"});
					saveAs(blob, "X_datafile.json");
					//}
				}
				
				// Handle deletion of network
				var delegraph = d3.select("#delete-graph").on("click", function(){
					var skipPrompt = false  // to show the prompt
					var doDelete = false;   
					if (!skipPrompt){
					  doDelete = window.confirm("Press OK to delete this graph"); // return true value if press OK
					}
				
					if(doDelete){   // for delete we need to delete svg object that we created earlier. Empty the data and the update the graph by calling drawnetwork()
						gp.selectAll('.nodes').remove();
						gp.selectAll('.texts').remove();
						gp.selectAll('path').remove();
						gp.selectAll('.label').remove();
						gp.selectAll('.bdry').remove();
						d3.select("#svg_main").selectAll('defs').remove();
						data.nodes = [];
						data.links = [];
						}
				});
				
				d3.select("#remove-selected").on("click", function(){				
					if(gp.selectAll('.selected').size()>0){
						
						gp.select(".labels_g").selectAll('.label').filter(function(d){
							let ele = d3.select(this)
							if(ele.classed('selected')){
								return d;
							}
						}).each(function(d1){
							data.labels = data.labels.filter(function(l){
								if(l.text!=d1.text && d1.x!=l.x && d1.y!=l.y)
									return l
							})
							actualdata.labels = actualdata.labels.filter(function(l){
								if(l.text!=d1.text && d1.x!=l.x && d1.y!=l.y)
									return l
							})
						});
						
						gp.select(".bdry_g").selectAll('.bdry').filter(function(d){
							let ele = d3.select(this)
							if(ele.classed('selected')){
								return d;
							}
						}).each(function(d1){
							data.boxes = data.boxes.filter(function(l){
								if(d1.cor[0].x!=l.cor[0].x && d1.cor[0].y!=l.cor[0].y && d1.cor[1].x!=l.cor[1].x && d1.cor[1].y!=l.cor[1].y)
									return l
							})
							actualdata.boxes = actualdata.boxes.filter(function(l){
								if(d1.cor[0].x!=l.cor[0].x && d1.cor[0].y!=l.cor[0].y && d1.cor[1].x!=l.cor[1].x && d1.cor[1].y!=l.cor[1].y)
									return l
							})
						});
						
						var remnids = [];
						var allnids = [];
						gp.selectAll('.nodes').filter(function(d) { return d.selected; })
						.each(function(d) {
							remnids.push(d.id)
						});
						gp.selectAll('.nodes').each(function(d) {
							allnids.push(d.id)
						});
						
						var filnids = [];
						filnids = allnids.filter(function(x){
							if(remnids.includes(x)==false)
								return x;
						})
						
						//console.log('remnids',remnids)
						//console.log('allnids',allnids)
						//console.log('filnids',filnids)
						//console.log('actualdata.nodes',actualdata.nodes)
						
						actualdata.nodes = actualdata.nodes.filter(function(val,i){
							if(remnids.includes(val.id)==false)
								return val;
						});
						
						data.nodes = data.nodes.filter(function(val,i){
							if(remnids.includes(val.id)==false)
								return val;
						});
						
						//console.log('data.boxes',data.boxes)
						
						var remlids = [];
						
						gp.selectAll('path').filter(function(d){ 
									let ele = d3.select(this);
										if(ele.classed('selected'))
											return d
									})
									.each(function(d) {
										remlids.push(d.id)
									});	
						
						var remlids2 = [];
						
						gp.selectAll('path')
								.filter(function(d) { 
									if(d.target.selected)
										return d
									if(d.source.selected)
										return d
									})
									.each(function(d) {
										remlids2.push(d.id)
									});	
									
						gp.selectAll('path').each(function(d){ 
							let ele = d3.select(this);
								if(ele.classed('selected')==false && remlids.includes(d.id)){
									ele.classed('selected',true)
								}
							});
																		
						//console.log('remlids',remlids)
						//console.log('remlids2',remlids2)
						
						actualdata.links = actualdata.links.filter(function(val,i){
							if(filnids.includes(val.target.id)==true && filnids.includes(val.source.id)==true){
								//console.log('1',remnids.includes(val.target))
								return val;
							}
							//if(filnids.includes(val.source.id)==true){
								//console.log('2',remnids.includes(val.source))
							//	return val;	
							//}
							//if(remnids.includes(val.id)==false)
							//	return val;
						});
						
						data.links = data.links.filter(function(val,i){
							if(filnids.includes(val.target.id)==true && filnids.includes(val.source.id)==true){
								//console.log('1',remnids.includes(val.target))
								return val;
							}
							//if(remlids.includes(val.id)==false)
							//	return val;
						});
						
						//console.log('after removal',data.links)
									
						gp.selectAll('path')
								.filter(function(d) { 
									if(d.target.selected)
										return d
									if(d.source.selected)
										return d
									}).remove();	
						
						gp.selectAll('.nodes').filter(function(d) { return d.selected; }).remove();
						gp.selectAll('.texts').filter(function(d) { return d.selected; }).remove();
						gp.selectAll('.selected').remove();
						gp.selectAll('.point').remove();
					}
				});
							
				function drawnetwork(data){
					//console.log('data',data)
					var simulation = d3
						.forceSimulation(data.nodes)
						.force('link', linkForce)
						.force("x",forceX)
						.force("y",forceY)
						//.alphaMin(0.98)
						//.alphaTarget(0.99)
						.force('charge', d3.forceManyBody().strength(elecrep));
						//.force('collision', d3.forceCollide().radius(function(d) {
							//console.log(d.radius)
						//    return 10.0
						//  }))
					
					simulation.force("link").links(data.links); // displays force links
					simulation.on("tick", tick);//-180.0 
					//simulation.restart();
					/*
					if(d3.select("#freezekey").property("checked")){
						simulation.alphaMin(alphaMIN);
						simulation.stop();
					}
					
					
					d3.select("#freezekey").on("change", function(d) {
						if(d3.select(this).property("checked")){
							simulation.alphaMin(alphaMIN);
							simulation.stop();
						}
						else{
							simulation.alphaMin(0.01);
						}
					});
					*/
					///*
					var markerHead = d3.select("#svg_main").select('defs').select("#arrowHead").selectAll("marker")
						.data(data.links);
						
						markerHead
						.enter().append('marker')
						.merge(markerHead)
						.attr("id",function(d){
							return d.id + "_arrow"
						})
						.attr("viewBox","0 0 10 10")
						.attr("refX",5)
						.attr("refY",5)
						.attr("markerWidth",10)
						.attr("markerHeight",5)
						.attr("orient","auto")
						.append("path")
						.attr("d", "M 0 0 L 5 5 L 0 10 z")
						.attr("fill",function(d){
							if (settings){
								return "black"
							}
							else{
								return d.stroke
							}
						})
						.attr("class","arrowHead");
							
					//marker.exit().remove();
					//*/
					var markerend = d3.select("#svg_main").select('defs').select("#arrowEnd").selectAll("marker")
						.data(data.links);

						markerend
						.enter().append('marker')
						.merge(markerend)
						.attr("id",function(d){
							return d.id + "_arrowEnd"
						})
						.attr("viewBox","0 0 10 10")
						.attr("refX",5)
						.attr("refY",5)
						.attr("markerWidth",10)
						.attr("markerHeight",5)
						.attr("orient","auto")
						.append("path")
						.attr("d", "M 0 5 L 5 0 L 5 10 z")
						//.attr("d", "M -2 5 L 8 0 L 8 10 z")
						.attr("fill",function(d){
							if (settings){
								return "black"
							}
							else{
								return d.stroke
							}
						})
						.attr("class","arrowEnd");
						//marker.exit().remove();
						
					var linkele = d3.select("#network").select(".links_g")
							.selectAll("path")
							.data(data.links);
					
					linkele.enter().append("path")
							.merge(linkele)
							//.attr("class",'path')
							.attr("d", function(d){
								if (d.d==undefined){
									return 'M' + d.source.x + "," + d.source.y + 'L' + d.target.x + "," + d.target.y
								}
								else
									return d.d
							})
							.attr("id", function(d){
								return d.id
							})
							.attr("x1", function (d) {
							  return d.source.x;
							})
							.attr("y1", function (d) {
								return d.source.y;
							})
							.attr("x2", lineX2)
							.attr("y2", lineY2)
							.attr('fill', 'none')
							/*
							.attr("marker-start", function(d){
								if(d.rev==1){
									if(d.source.type=="R"){
										return "url(#arrowGray)"
									}  
									else{
										return "url(#" + d.id + "_arrowEnd)"
									}
								}
								else{
									return "url(#Noarrow)"
								}
							})
							*/
							.attr("marker-end", function(d){
								if(d.target.type=="R"){
									return "url(#Noarrow)"
								}  
								else{
									return "url(#" + d.id + "_arrow)"
								}
							})
							.attr("stroke", function(d){ 
								if(settings)
									return "black"
								else
									return d.stroke
							})
							.attr("stroke-width", function(d){
								if (settings){
									return 2.0
								}
								else{
									return d.strength
								}
							})
							.attr("opacity", function(d){
								if(d.opacity==undefined || settings)
									return 1.0
								else
									return d.opacity
							})
							.on('click', function(){
								var ele = d3.select(this)
								ele.classed('selected', true)
							})
							.attr("pointer-events", "visibleStroke");

					linkele.exit().remove();
					
					gp.selectAll('path').each(function(d){
						var ele = d3.select(this)
						if(d.id.includes('_curved_')){
							ele.classed("curved", true);
						}
						else{
							ele.classed("curved", false);
						}
					});
					
					// makes a group for nodes
					var nodeele = d3.select("#network").select(".nodes_g")
							.selectAll(".nodes")
							.data(data.nodes);
					
					let hide_rxn_node = false;
					let hideMenu_values = [];
					let hideMenu_ref = d3.select('#hide').node().selectedOptions;
					
					for (let i = 0; i < hideMenu_ref.length; i++) {
						hideMenu_values.push(hideMenu_ref[i].value)
					}
					//console.log('cx',ele.attr('cx'))
					if(hideMenu_values.includes('l_node')==true){
						hide_rxn_node = true;
					}
							
					nodeele.enter().append("circle")
							.merge(nodeele)
							.attr("class",'nodes')
							.attr("id",function(d){
								return d.id
							})
							.attr("stroke", "#000000")
							.attr("stroke-width", '2px')
							.attr("r", function(d){
								if (settings||d.r==undefined||isNaN(d.r)){
									return 8.0
								}
								else{									
									if(d.type=="R" && hide_rxn_node==true){
										d.r = 0.0
										return 0.0
									}
									else
										return d.r
								}
							})
							.attr("cx",function(d){
								if (d.x==undefined||isNaN(d.r)){
									return 0
								}
								else
									return d.x
							})
							.attr("cy",function(d){
								if (d.y==undefined||isNaN(d.r)){
									return 0
								}
								else
									return d.y
							})
							.attr("fill", function(d,i){
								var nval = 8.0
								if(settings){
									if(d.type=="M" || d.type!="R")
										return "white"
									else if(d.type=="R")
										return '#d3d3d3'
								}
								else{
									return d.fill
								}
							})
							.attr("opacity", function(d){
								if(d.opacity==undefined || settings)
									return 1.0
								else
									return d.opacity
							})
							.on('click', selectNode)
							.on('mouseover', function(d) {
								let ele = d3.select(this)
								let ele_values = [];
								let ref = d3.select('#hide').node().selectedOptions;
								//console.log('ref',ref)
								for (let i = 0; i < ref.length; i++) {
									ele_values.push(ref[i].value)
								}
								//console.log('cx',ele.attr('cx'))
								if(ele_values.includes('Tooltip')==false){
									d3.selectAll(".tooltip").remove();
									
									// create a tooltip
									var Tooltip = d3.select("body")
										.append("div")
										.attr("id","div_tooltip")
										.style("position","absolute")
										.style("left",d3.event.clientX+"px")
										.style("top",d3.event.clientY+"px")
										.style("opacity", 1)
										.style("border", "solid")
										.style("border-width", "2px")
										.style("border-radius", "5px")
										.style("padding", "5px")
										.style("text-align","left")
										.style("font", "12px Arial")
										.style("background","lightsteelblue")
										.attr("class", "tooltip");
										
									if(d.type!="R"){
										Tooltip
										.html("<strong>Kegg-id: </strong>" + d.kegg_id + "<br>" + "<strong>Name: </strong>" + d.name + "<br>" + "<strong>Formula: </strong>" + d.formula + "<br>" + "<button type='button' id='meta_link'>More detail on metabolite</button>")
									}
									else{
										Tooltip
										.html("<strong>Kegg-id: </strong>" + d.kegg_id + "<br>" + "<strong>Name: </strong>" + d.name + "<br>" + "<strong>Subsystem: </strong>" + d.subsystem + "<br>" + "<strong>gene/ortholog: </strong>" + d.gene + "<br>" + "<strong>Rxn: </strong>" + d.rxn + "<br>" + "<button type='button' id='gene_link'>More details on gene/ortholog</button>"+ "<button type='button' id='rxn_link'>More details on reaction</button>")
									}
									
									d3.selectAll('.tooltip').select('#gene_link').on('click', function(){
										let url = d.gene_link
										window.open(url, '_blank').focus();
									})
									
									d3.selectAll('.tooltip').select('#rxn_link').on('click', function(){
										let url = d.rxn_link
										window.open(url, '_blank').focus();
									})
									
									d3.selectAll('.tooltip').select('#meta_link').on('click', function(){
										let url = d.cpd_link
										window.open(url, '_blank').focus();
									})
									
								}
							})
							.on('mouseleave', function(d) {
								//d3.selectAll(".tooltip").remove();
									//.style("opacity", 1);
							})
							.on('mousedown', function(d){
								mousedown_node = d;
							})
							.on('mouseup', function(d){
								mouseup_node = d;
								if(mouseup_node!=mousedown_node){
									
									var lpair = [];
									data.links.forEach(function(l){
										lpair.push([l.source.id,l.target.id])
									});
									
									//console.log(lpair)
									
									if(find_pair_exist(lpair,[mousedown_node.id,mouseup_node.id])==0){									
										if(mouseup_node.type=='R'){
											var nlink = {source:mousedown_node.id, target:mouseup_node.id, strength:2.0, id:mouseup_node.id,kegg_id: mouseup_node.kegg_id, stroke: "rgb(0, 0, 0)", subsystem:mouseup_node.subsystem, opacity: 1.0}
											data.links.push(nlink)
											//actualdata.links.push(nlink)
										}
										else{
											var nlink = {source:mousedown_node.id, target:mouseup_node.id, strength:2.0, id:mousedown_node.id ,kegg_id: mousedown_node.kegg_id, stroke: "rgb(0, 0, 0)", subsystem:mouseup_node.subsystem, opacity: 1.0}
											data.links.push(nlink)
											//actualdata.links.push(nlink)
										}
										drawnetwork(data);
									}
									else{
										
										let dummyarr =  data.links.filter(function(d1,i){
											if((d1.target.id==mouseup_node.id && d1.source.id==mousedown_node.id) || (d1.source.id==mouseup_node.id && d1.target.id==mousedown_node.id))
												return d1;
										});
										
										dummyarr.forEach(function(d2){
											if(d2.source.type!="R"){
												let tid = d2.source;
												let sid = d2.target;
												d2.source = sid;
												d2.target = tid;
											}
										});
										drawnetwork(data);
									}
								}
								mousedown_node = null
								mouseup_node = null
							})
							.on("dblclick", dblclick)
							.call(d3.drag()
							.on("start", dragstarted)
							.on("drag", dragmove)
							.on("end", dragended));
					
					nodeele.exit().remove();
					
					gp.selectAll('.nodes').each(function(d){
						let ele = d3.select(this)
						ele.classed("selected", false);
						
						if(d.id.includes('_curved_')){
							ele.classed("curved", true);
						}
						else{
							ele.classed("curved", false);
						}
						
					});
					
					var textele = d3.select("#network").select(".texts_g")
								.selectAll(".texts")
								.data(data.nodes);
								
						textele.enter().append("text")
								.merge(textele)
								.text(function (d) {
									if (d.type!="R"){
										return d.name
									}
									else{
										let ele_values = [];
										let ref = d3.select('#hide').node().selectedOptions;
										//console.log('ref',ref)
										for (let i = 0; i < ref.length; i++) {
											ele_values.push(ref[i].value)
										}
										//console.log('cx',ele.attr('cx'))
										if(ele_values.includes('rxn_name')==false){
											return d.name
										}
										else{
											return ""
										}
									}
								})
								//.call(wrap_2,40)
								.attr("font-size", function(d){
									if (d.font_size==undefined){
										return 12.0
									}
									else
										return d.font_size
								})
								.attr("font-family", "Arial")
								.attr("id",function(d){
									return d.id
								})
								.attr('class','texts')
								.attr('opacity', function(d){
									var val = 1.0
									if(d.opacity==undefined)
										val = 1.0
									else
										val = d.opacity
									return val
								})
								.attr("dx", function(d){
									if (settings){
										if(d.dx==undefined)
											return 10.0
										else
											return d.dx
									}
									else
										return d.dx
								})
								.attr("dy", function(d){
									if (settings){
										if(d.dy==undefined)
											return 10.0
										else
											return d.dy
									}
									else
										return d.dy
								})
								.call(make_editable);
								
					textele.exit().remove();
					
					function make_editable(){
						d3.select("#network").select(".texts_g")
							.selectAll("text")
							.on('dblclick', function(d) {
								
								d3.select(this).classed("edit",true);
								
								//console.log('ele',d.name.replace("/ /g","_"))
								
								var form = d3.select("body")
										.append("div")
										.style("position","absolute")
										.style("left",d3.event.clientX+"px")
										.style("top",d3.event.clientY+"px")
										.style("opacity", 1)
										.style("border", "solid")
										.style("border-width", "2px")
										.style("border-radius", "5px")
										.style("padding", "15px 20px 15px 0px")
										.style("text-align","left")
										.style("font", "12px Arial")
										.style("background","lightsteelblue")
										.attr("class", "form");
								
								if(d.type=="R"){
									form.html("<strong>Name:</strong> <input type = 'text' value = " + d.name.replace(/ /g,"_") + "> <br> <strong>Subsystem:</strong> <input type ='text' value = " + d.subsystem.replace(/ /g,"_") + "> <br> <strong>Gene :</strong> <input type= 'text' value = " + d.gene + ">")
								}
								else{
									form.html("<strong>Name:</strong> <input type = 'text' value = " + d.name.replace(/ /g,"_") + ">")
								}
								
								//console.log("form",form["_groups"]["0"]["0"])
								//console.log("form",form["_groups"]["0"]["0"].innerHTML)
								
								//var newText = window.prompt("Enter the new node text", "");
								////console.log(d3.select(this.parentNode))
								//if(newText==null || newText=="")
								//	newText = makeid(20)
								//var nid = d3.select(this).attr('id')
								//data.nodes.forEach(function(d){
								//	if(d.id==nid)
								//	d.name = newText;
								//})
								//d3.select(this).text(newText);
							})
					};
					
					if(undo_stack.length==0){
						var nodes_data = [], links_data =[]; 
						
						var positions = data.nodes.map(function(d) { return [d.x, d.y]; });
						
						data.nodes.forEach(function(n,i){
							gp.selectAll(".nodes").each(function(val){
								let ele = d3.select(this)
								if(val.id==n.id && n.type!="R"){
									nodes_data.push({id: n.id, kegg_id: n.kegg_id, name: n.name, type: n.type, x:positions[i][0], y:positions[i][1], r: ele.attr('r'), dx: val.dx, dy: val.dy, font_size: val.font_size})
								}
								else if(val.id==n.id && n.type=="R"){
									nodes_data.push({id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: positions[i][0], y: positions[i][1], r: val.r, dx: val.dx, dy: val.dy, font_size: val.font_size})
								}
							})							
						})
						
						gp.select('.links_g').selectAll('path').each(function(val){
							var ele = d3.select(this);
							links_data.push({source: val.source.id, target: val.target.id, strength: val.strength, id: val.id, d:ele.attr('d'), kegg_id: val.kegg_id, opacity:ele.attr('opacity')});
						});
						
						var modi_data = {"nodes": nodes_data,"links": links_data,"boxes":data.boxes,"labels":data.labels}
						undo_stack.push(modi_data)
					}
					
					function dragstarted(d) {
						if (!d3.event.active) 
							simulation.alphaTarget(1.0).restart(); //when alphatarget =0 then simulation stops.

						if (!d.selected && !shiftKey) {
							// if this node isn't selected, then we have to unselect every other node
							d3.select('body').select('#svg_main').selectAll('.nodes').classed("selected", function(p) { return p.selected =  p.previouslySelected = false; });
							//d3.select('body').select('svg').selectAll('link').classed("selected", function(p) { return p.selected =  p.previouslySelected = false; });
						}
						d3.select(this).classed("selected", function(p) { d.previouslySelected = d.selected; return d.selected = true; });
						d3.select('body').select('#svg_main').selectAll('.nodes').filter(function(d) { return d.selected; })
						.each(function(d) {
						  d.fx = d.x;
						  d.fy = d.y;
						})
						
						if(undo_stack.length==0){
							var nodes_data = [], links_data =[]; 
							
							var positions = data.nodes.map(function(d) { return [d.x, d.y]; });
							
							data.nodes.forEach(function(n,i){
								gp.selectAll(".nodes").each(function(val){
									let ele = d3.select(this)
									if(val.id==n.id && n.type!="R"){
										nodes_data.push({id: n.id, kegg_id: n.kegg_id, name: n.name, type: n.type, x:positions[i][0], y:positions[i][1], r: ele.attr('r'), dx: val.dx, dy: val.dy, font_size: val.font_size})
									}
									else if(val.id==n.id && n.type=="R"){
										nodes_data.push({id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: positions[i][0], y: positions[i][1], r: val.r, dx: val.dx, dy: val.dy, font_size: val.font_size})
									}
								})							
							})
							
							gp.select('.links_g').selectAll('path').each(function(val){
								var ele = d3.select(this);
								links_data.push({source: val.source.id, target: val.target.id, strength: val.strength, id: val.id, d:ele.attr('d'), kegg_id: val.kegg_id, opacity:ele.attr('opacity')});
							});
							
							var modi_data = {"nodes": nodes_data,"links": links_data,"boxes":data.boxes,"labels":data.labels}
							undo_stack.push(modi_data)
						}
						
					};

					function dragmove(d) {
						d3.select('body').select("#svg_main").selectAll('.nodes').filter(function(d) { return d.selected; })
						.each(function(d) { 
							d.fx += d3.event.dx;
							d.fy += d3.event.dy;
						})
					};

					function dragended(d) {
						if (!d3.event.active)
						simulation.alphaTarget(0.0);
						
						var nodes_data = [], links_data =[]; 
						
						var positions = actualdata.nodes.map(function(d) { return [d.x, d.y]; });
						//console.log(positions)
						gp.selectAll(".nodes").each(function(val,i){
							let ele = d3.select(this)
							if(val.type!="R"){
								nodes_data.push({id: val.id, kegg_id: val.kegg_id, name: val.name, type: val.type, x:positions[i][0], y:positions[i][1], r: ele.attr('r'), dx: val.dx, dy: val.dy, font_size: val.font_size})
							}
							else if(val.type=="R"){
								nodes_data.push({id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: positions[i][0], y: positions[i][1], r: val.r, dx: val.dx, dy: val.dy, font_size: val.font_size})
							}
						})							
						
						gp.select('.links_g').selectAll('path').each(function(val){
							var ele = d3.select(this);
							links_data.push({source: val.source.id, target: val.target.id, strength: val.strength, id: val.id, d:ele.attr('d'), kegg_id: val.kegg_id, opacity:ele.attr('opacity')});
						});
						
						var modi_data = {"nodes": nodes_data,"links": links_data,"boxes": actualdata.boxes,"labels":actualdata.labels}
						undo_stack.push(modi_data)
						//console.log('undo_arr',undo_stack)
					}; 
					
					//console.log(document.getElementById('menu_options')) 
					
					d3.select('#menu_options').select('.menu').select('#undo').on('click', Undo);
					
					d3.select('#menu_options').select('.menu').select('#redo').on('click', Redo);
					
					d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#alignhorizontal').on('click',horizontal_alignment)
					
					d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#alignvertical').on('click',vertical_alignment)
					
					d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#aligncircular').on('click',circular_alignment)
					
					d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#rotate').on('click', Rotation);
					
					d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#make_arc').on('click', Make_arc);
					
					d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#remove_arc').on('click', Remove_arc);
					
					d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#highlight').on('click', Highlight);
					
					d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#unhighlight').on('click', Unhighlight);
					
					function Undo(){
						//console.log('Undo is executed')
						//console.log('undo_stack',undo_stack)
						if(undo_stack.length-2>=0){
							undo_stack[undo_stack.length-2].nodes.forEach(function(n){
								d3.select('body').select("#svg_main").selectAll('.nodes').filter(function(d) { if(d.id==n.id) return d })
								.each(function(d) { 
									d.fx = n.x;
									d.fy = n.y;
								})							
							})
							
							//redo_stack.push(undo_stack[undo_stack.length-1]);
							redo_stack.push(undo_stack.pop())
							//undo_stack.pop();
							simulation.alphaTarget(1.0).restart();
							//simulation.alphaTarget(0.0);
						}
						//console.log('undo_stack.length',undo_stack.length)
						if(undo_stack.length>25){
							undo_stack.shift();
						}
					}
					
					function Redo(){
						//console.log('redo is executed')
						//console.log('redo_stack',redo_stack)
						if (redo_stack.length-1>=0){
							redo_stack[redo_stack.length-1].nodes.forEach(function(n){
								d3.select('body').select("#svg_main").selectAll('.nodes').filter(function(d) { if(d.id==n.id) return d })
								.each(function(d) { 
									d.fx = n.x;
									d.fy = n.y;
								})							
							})
							
							undo_stack.push(redo_stack.pop());
							//redo_stack.pop();
							simulation.alphaTarget(1.0).restart();
							simulation.alphaTarget(0.0);
						}
						//console.log('redo_stack_length',redo_stack.length)
						if(redo_stack.length>25){
							redo_stack.shift();
						}
					}
					
					function horizontal_alignment(){
						var ytotal = 0.0, ytotal_img = 0.0, ytotal_box = 0.0, ytotal_lbs = 0.0;
						var count = 0, count_img = 0, count_box = 0, count_lbs = 0; 
						gp.selectAll('.nodes').filter(function(d) { return d.selected; })
						.each(function(d) {
							ytotal+=d.y
							count++
						});
						var yavg = ytotal/count;

						gp.selectAll('.nodes').filter(function(d) { return d.selected; }).each(function(d) {
							d.fy = yavg;
						});
						
						gp.select(".images_g").selectAll('.selected')
						.each(function(d) {
							ytotal_img+=parseFloat(d3.select(this).attr('y'))
							count_img++
						});
						var yavg_img = ytotal_img/count_img;
						gp.select(".images_g").selectAll('.selected').each(function(d) {
							d3.select(this).attr('y',yavg_img)
						});
						
						gp.select(".bdry_g").selectAll('.selected')
						.each(function(d) {
							ytotal_box+=parseFloat(d3.select(this).attr('y'))
							count_box++
						});
						var yavg_box = ytotal_box/count_box;
						gp.select(".bdry_g").selectAll('.selected').each(function(d) {
							d3.select(this).attr('y',yavg_box)
						});
						
						gp.select(".labels_g").selectAll('.selected')
						.each(function(d) {
							//console.log(d3.select(this).attr('y'))
							ytotal_lbs+=parseFloat(d3.select(this).attr('y'))
							count_lbs++
						});
						var yavg_lbs = ytotal_lbs/count_lbs;
						gp.select(".labels_g").selectAll('.selected').each(function(d) {
							d3.select(this).attr('y',yavg_lbs)
						});
						
						simulation.alphaTarget(1.0).restart();
						simulation.tick();
						simulation.alphaTarget(0.0);
						
						var nodes_data = [], links_data =[]; 
						
						var ids = actualdata.nodes.map(function(d) { return d.id; });
						var positions = actualdata.nodes.map(function(d) { return [d.x, d.y]; });
						
						gp.selectAll(".nodes").each(function(val,i){
							let ele = d3.select(this)
							if(val.type!="R"){
								let idx = ids.findIndex(d => d === val.id)
								//console.log('idx',idx)
								nodes_data.push({id: val.id, kegg_id: val.kegg_id, name: val.name, type: val.type, x:positions[idx][0], y:positions[idx][1], r: ele.attr('r'), dx: val.dx, dy: val.dy, font_size: val.font_size})
							}
							else if(val.type=="R"){
								let idx = ids.findIndex(d => d === val.id)
								//console.log('idxR',idx)
								nodes_data.push({id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: positions[idx][0], y: positions[idx][1], r: val.r, dx: val.dx, dy: val.dy, font_size: val.font_size})
							}
						})							
						
						gp.select('.links_g').selectAll('path').each(function(val){
							var ele = d3.select(this);
							links_data.push({source: val.source.id, target: val.target.id, strength: val.strength, id: val.id, d:ele.attr('d'), kegg_id: val.kegg_id, opacity:ele.attr('opacity')});
						});
						
						var modi_data = {"nodes": nodes_data,"links": links_data,"boxes":actualdata.boxes,"labels":actualdata.labels}
						undo_stack.push(modi_data)
						//console.log('undo_stack.length',undo_stack.length)
					}
					
					function vertical_alignment(){
						var xtotal = 0, xtotal_img = 0, xtotal_box = 0.0, xtotal_lbs = 0.0;
						var count = 0, count_img = 0, count_box = 0, count_lbs = 0;
						gp.selectAll('.nodes').filter(function(d) { return d.selected; })
						.each(function(d) {
							xtotal+=d.x
							count++
						});
						
						var xavg = xtotal/count;
						
						gp.selectAll('.nodes').filter(function(d) { return d.selected; }).each(function(d) {
								d.fx = xavg
						});
						
						gp.select(".images_g").selectAll('.selected').each(function(d) {
							xtotal_img+=parseFloat(d3.select(this).attr('x'))
							count_img++
						});
						
						var xavg_img = xtotal_img/count_img;
						
						gp.select(".images_g").selectAll('.selected').each(function(d) {
							d3.select(this).attr('x',xavg_img)
						});
						
						gp.select(".bdry_g").selectAll('.selected').each(function(d) {
							xtotal_box+=parseFloat(d3.select(this).attr('x'))
							count_box++
						});
						var xavg_box = xtotal_box/count_box;
						gp.select(".bdry_g").selectAll('.selected').each(function(d) {
							d3.select(this).attr('x',xavg_box)
						});
						
						gp.select(".labels_g").selectAll('.selected')
						.each(function(d) {
							xtotal_lbs+=parseFloat(d3.select(this).attr('x'))
							count_lbs++
						});
						var xavg_lbs = xtotal_lbs/count_lbs;
						gp.select(".labels_g").selectAll('.selected').each(function(d) {
							d3.select(this).attr('x',xavg_lbs)
						});
						
						simulation.alphaTarget(1.0).restart();
						simulation.tick();
						simulation.alphaTarget(0.0);
						
						var nodes_data = [], links_data =[]; 
						
						var ids = actualdata.nodes.map(function(d) { return d.id; });
						var positions = actualdata.nodes.map(function(d) { return [d.x, d.y]; });
						
						gp.selectAll(".nodes").each(function(val,i){
							let ele = d3.select(this)
							if(val.type!="R"){
								let idx = ids.findIndex(d => d === val.id)
								//console.log('idx',idx)
								nodes_data.push({id: val.id, kegg_id: val.kegg_id, name: val.name, type: val.type, x:positions[idx][0], y:positions[idx][1], r: ele.attr('r'), dx: val.dx, dy: val.dy, font_size: val.font_size})
							}
							else if(val.type=="R"){
								let idx = ids.findIndex(d => d === val.id)
								//console.log('idxR',idx)
								nodes_data.push({id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: positions[idx][0], y: positions[idx][1], r: val.r, dx: val.dx, dy: val.dy, font_size: val.font_size})
							}
						})							
						
						gp.select('.links_g').selectAll('path').each(function(val){
							var ele = d3.select(this);
							links_data.push({source: val.source.id, target: val.target.id, strength: val.strength, id: val.id, d:ele.attr('d'), kegg_id: val.kegg_id, opacity:ele.attr('opacity')});
						});
						
						var modi_data = {"nodes": nodes_data,"links": links_data,"boxes":actualdata.boxes,"labels":actualdata.labels}
						undo_stack.push(modi_data)
						//console.log('undo_stack.length',undo_stack.length)
					}
					
					function circular_alignment(){
						var center = compute_center();
						var sortarr = gp.select('.nodes_g').selectAll('.selected').sort(function(d,d1){
							var xpos = d.x
							var ypos = d.y
							var x1pos = d1.x
							var y1pos = d1.y
							var angle = Math.atan2(ypos-center[1],xpos-center[0])
							var angle1 = Math.atan2(y1pos-center[1],x1pos-center[0])
							return angle - angle1
						});
						
						var totalnodes = gp.select('.nodes_g').selectAll('.selected').size();
						var dtheta = 2.0*Math.PI/totalnodes;
						var refangle = Math.atan2(center[1],center[0])
						var angle = []
						sortarr.each(function(d,i){
							var xpos = d.x
							var ypos = d.y
							//var angle = Math.atan2(ypos-center[1],xpos-center[0])
							angle.push(Math.atan2(ypos-center[1],xpos-center[0])-refangle)
							//d.fx = center[0] + 100.0*Math.cos(i*dtheta) - 100.0*Math.sin(i*dtheta)
							//d.fy = center[1] + 100.0*Math.sin(i*dtheta) + 100.0*Math.cos(i*dtheta)
						});
						
						sortarr.each(function(d,i){
							d.fx = center[0] + 100.0*Math.cos(i*dtheta+angle[0]) - 100.0*Math.sin(i*dtheta+angle[0])
							d.fy = center[1] + 100.0*Math.sin(i*dtheta+angle[0]) + 100.0*Math.cos(i*dtheta+angle[0])
						});
						
						simulation.alphaTarget(1.0).restart();
						simulation.tick();
						simulation.alphaTarget(0.0);
						
						var nodes_data = [], links_data = []; 
						
						var ids = actualdata.nodes.map(function(d) { return d.id; });
						var positions = actualdata.nodes.map(function(d) { return [d.x, d.y]; });
						
						gp.selectAll(".nodes").each(function(val,i){
							let ele = d3.select(this)
							if(val.type!="R"){
								let idx = ids.findIndex(d => d === val.id)
								//console.log('idx',idx)
								nodes_data.push({id: val.id, kegg_id: val.kegg_id, name: val.name, type: val.type, x:positions[idx][0], y:positions[idx][1], r: ele.attr('r'), dx: val.dx, dy: val.dy, font_size: val.font_size})
							}
							else if(val.type=="R"){
								let idx = ids.findIndex(d => d === val.id)
								//console.log('idxR',idx)
								nodes_data.push({id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: positions[idx][0], y: positions[idx][1], r: val.r, dx: val.dx, dy: val.dy, font_size: val.font_size})
							}
						})							
						
						gp.select('.links_g').selectAll('path').each(function(val){
							var ele = d3.select(this);
							links_data.push({source: val.source.id, target: val.target.id, strength: val.strength, id: val.id, d:ele.attr('d'), kegg_id: val.kegg_id, opacity:ele.attr('opacity')});
						});
						
						var modi_data = {"nodes": nodes_data,"links": links_data,"boxes":actualdata.boxes,"labels":actualdata.labels}
						undo_stack.push(modi_data)
						//console.log('undo_stack.length',undo_stack.length)
						
					}
					
					function Rotation(){
						var center = compute_center();
						
						gp.append('circle')
							.attr('class','point')
							.attr('cx',center[0])
							.attr('cy',center[1]);
						
						var iniangle = 0.0
						gp.append('circle')
							.attr('class','point')
							.attr('cx',center[0] + 100.0)
							.attr('cy',center[1])
							.call(d3.drag()
							.on("drag",function(){
								var m1 = d3.mouse(this)
								var newPoint = {'x':m1[0],'y':m1[1]}								
								var angle = Math.atan2(newPoint.y-center[1],newPoint.x-center[0])
								var dtheta = (angle - iniangle)*2.0
								var ele = d3.select(this)
								var new_x = center[0] + 100.0*Math.cos(angle)
								var new_y = center[1] + 100.0*Math.sin(angle)
								ele.attr("cx", new_x)
									.attr("cy", new_y);
								
								gp.selectAll('.nodes').filter(function(d) { return d.selected; })
								.each(function(d) {
									d.fx = center[0] + (d.x-center[0])*Math.cos(dtheta) - (d.y-center[1])*Math.sin(dtheta)
									d.fy = center[1] + (d.x-center[0])*Math.sin(dtheta) + (d.y-center[1])*Math.cos(dtheta)
								});
								iniangle = angle
							}));
							
						simulation.alphaTarget(1.0).restart();
						simulation.tick();
						simulation.alphaMin(0.01);
					}
								
					function Remove_arc(){
						if(gp.select('.nodes_g').selectAll(".selected").size()>0){
							
							gp.select('.nodes_g').selectAll('.selected').each(function(d){
								var ele = d3.select(this);
								if(ele.classed('curved')==true){
									ele.classed("curved", false);
									let id = ele.attr('id')
									ele.attr('id', ele.attr('id').split('_curved_')[0]);
									actualdata['nodes'].forEach(function(n){
										if(n.id==id)
											n.id = n.id.split('_curved_')[0]
									});
								}
							})
							
							gp.select('.links_g').selectAll("path").each(function(d,i){
								var ele = d3.select(this);
								if(ele.classed('curved')==true){
									if(d.source.selected==1 && d.target.selected==1){
										ele.classed("curved", false)
										let id = ele.attr('id')
										ele.attr('id', ele.attr('id').split("_curved_")[0])
										actualdata['links'].forEach(function(l){
											if(l.id==id){
												l.id = l.id.split("_curved_")[0];
												//l.source.id = l.source.id + "_curved_" + randid;
												//l.target.id = l.target.id + "_curved_" + randid;
											}
										})
									}
								}
							});
							
							simulation.alphaTarget(1.0).restart();
							simulation.tick();
							simulation.alphaTarget(0.0);
							
						}
					}
					
					function Make_arc(){
						if(gp.select('.nodes_g').selectAll(".selected").size()>0){
							
							let randid = makeid(10);
							
							gp.select('.nodes_g').selectAll('.selected').each(function(d){
								var ele = d3.select(this);
								if(ele.classed('curved')==false){
									ele.classed("curved", true);
									let id = ele.attr('id')
									ele.attr('id', ele.attr('id') + "_curved_" + randid);
									actualdata['nodes'].forEach(function(n){
										if(n.id==id)
											n.id = n.id + "_curved_" + randid
									});
								}
							})
							
							gp.select('.links_g').selectAll("path").each(function(d,i){
								var ele = d3.select(this);
								if(ele.classed('curved')==false){
									if(d.source.selected==1 && d.target.selected==1){
										let sid = d.source.id
										let pid = d.target.id
										ele.classed("curved", true)
										let id = ele.attr('id')
										ele.attr('id', ele.attr('id') + "_curved_" + randid);
										if(d.source.id.includes('_curved')==false)
											d.source.id = d.source.id + "_curved_" + randid;
										if(d.source.id.includes('_curved')==false)
											d.target.id = d.target.id + "_curved_" + randid;
										
										//console.log("sid",sid)
										//console.log("pid",pid)
										
										actualdata['links'].forEach(function(l){
											//console.log("l.source",l.source.id)
											//console.log("l.target",l.target.id)
											if(l.id==id && l.source.id==sid && l.target.id==pid){
												l.id = l.id + "_curved_" + randid;
												//l.source.id = l.source.id + "_curved_" + randid;
												//l.target.id = l.target.id + "_curved_" + randid;
											}
										})
									}
								}
							});
							
							simulation.alphaTarget(1.0).restart();
							simulation.tick();
							simulation.alphaTarget(0.0);
							
							//countloops++;
						}
					}
					
					function Highlight(){
						d3.select("#network").select(".links_g").selectAll("path").each(function(d){
							if(d.source.selected==1 && d.target.selected==1){
								let x = d3.select(this)
								x.classed('selected',true);
							}
						});
						
						d3.select("#network").select(".nodes_g").selectAll(".selected").each(function(d){
							let x = d3.select(this);
							x.attr('opacity', 1.0);
							x.classed('selected',false);
						});
						
						d3.select("#network").select(".links_g").selectAll(".selected").each(function(d){
							let x = d3.select(this)
							x.attr('opacity',1.0)
							x.classed('selected',false);
						})
						
						d3.select("#network").select(".texts_g").selectAll(".texts").each(function(d){
							let x = d3.select(this)
							if(d.selected==1){
								x.attr('opacity',1.0)
								x.classed('selected',false);
							}
						})
						
						gp.selectAll(".nodes").each(function(d){
							let x = d3.select(this);
							if(x.attr("opacity")==1){
								//console.log('d.id',d.id)
								$.each(actualdata.nodes, function() {
									if (this.id == d.id) {
										this.opacity = 1.0;
									}
								});
							}
						});
						
						//console.log(actualdata)
						
						//actualdata.nodes.forEach(function(n){
						//	if(n.opacity==1){
						//		console.log("jsonobj[i]",n)
						//	}
						//})
					}
					
					function Unhighlight(){
						d3.select("#network").select(".links_g").selectAll("path").each(function(d){
							if(d.source.selected==1 && d.target.selected==1){
								let x = d3.select(this)
								x.classed('selected',true);
							}
						});
						
						d3.select("#network").select(".nodes_g").selectAll(".selected").each(function(d){
							let x = d3.select(this);
							x.attr('opacity', 0.5);
							x.classed('selected',false);
						});
						
						d3.select("#network").select(".links_g").selectAll(".selected").each(function(d){
							let x = d3.select(this)
							x.attr('opacity',0.5)
							x.classed('selected',false);
						});
						
						d3.select("#network").select(".texts_g").selectAll(".texts").each(function(d){
							let x = d3.select(this)
							if(d.selected==1){
								x.attr('opacity',0.5)
								x.classed('selected',false);
							}
							
						});
					}
					
					d3.select('#menu_options').select('.menu').select('#submenu6').select('#menu6').select('#select_node').on('click', Select_node);
					
					d3.select('#menu_options').select('.menu').select('#submenu6').select('#menu6').select('#select_l_node').on('click', Select_l_node);
					
					d3.select('#menu_options').select('.menu').select('#submenu6').select('#menu6').select('#select_l').on('click', Select_l);
					
					d3.select('#menu_options').select('.menu').select('#submenu6').select('#menu6').select('#select_l_node_both').on('click', Select_l_node_both);
					
					function Select_node(){
						d3.select("#network").select(".nodes_g").selectAll(".selected").each(function(d){
							if(d.type=="R"){
								let x = d3.select(this)
								x.classed('selected',false);
							}
						})
					}
					
					function Select_l_node(){
						d3.select("#network").select(".nodes_g").selectAll(".selected").each(function(d){
							if(d.type!="R"){
								let x = d3.select(this)
								x.classed('selected',false);
							}
						})
					}
					
					function Select_l(){
						d3.select("#network").select(".links_g").selectAll("path").each(function(d){
							if(d.source.selected==1 && d.target.selected==1){
								let x = d3.select(this)
								x.classed('selected',true);
							}
						})
						d3.select("#network").select(".nodes_g").selectAll(".selected").each(function(d){
							let x = d3.select(this)
							x.classed('selected',false);
						})
					}
					
					function Select_l_node_both(){
						d3.select("#network").select(".links_g").selectAll("path").each(function(d){
							if(d.source.selected==1 && d.target.selected==1){
								let x = d3.select(this)
								x.classed('selected',true);
							}
						})
					}
					
					d3.select('#menu_options').select('.menu').select('#submenu7').select('#menu7').select('#duplicate').on('click', Duplicate);
					
					d3.select('#menu_options').select('.menu').select('#submenu4').select('#menu4').select('#insert_reaction').on('click', Insert_reaction)
				
					d3.select('#menu_options').select('.menu').select('#submenu4').select('#menu4').select('#insert_node').on('click', Insert_node)
					
					d3.select('#menu_options').select('.menu').select('#submenu4').select('#menu4').select('#insert_link-node').on('click', Insert_link_node)
					
					function Duplicate(){
						var randid = makeid(1);
						d3.select("#network").select(".nodes_g").selectAll(".selected").each(function(d){
							let ele = d3.select(this)
							if(d.type=="R"){
								//let randid1 = makeid(20)
								let newnode = {id:ele.attr('id')+"_dup_"+randid, subsystem: d.subsystem,rev: d.rev, kegg_id: d.kegg_id, name: d.name, type:d.type, x :d.x, y:d.y, r:d.r, dx:d.dx, dy:d.dy, font_size:d.font_size, fill:d.fill, opacity: d.opacity, rxn:d.rxn, gene:d.gene, rxn_link:d.rxn_link, gene_link:d.gene_link};
								
								//{id: val.id, kegg_id: val.kegg_id, rev: val.rev, name: val.name, subsystem: val.subsystem, type: val.type, x: val.x, y: val.y, r: val.r, dx: dummyval.dx, dy: dummyval.dy, font_size: dummyval.font_size, opacity: val.opacity, fill:ele.attr('fill'),rxn:val.rxn, gene:val.gene, rxn_link:val.rxn_link, gene_link:val.gene_link}
								
								data.nodes.push(newnode);
								//actualdata.nodes.push(newnode);
							}
							else{
								//let randid1 = makeid(20)
								
								let newnode1 = {id:ele.attr('id')+"_dup_"+randid, name:d.name, type:d.type, kegg_id: d.kegg_id, x :d.x, y:d.y, r:d.r, dx:d.dx, dy:d.dy, font_size:d.font_size, fill:d.fill, opacity: d.opacity, cpd_link: d.cpd_link,subsystem: d.subsystem};
								
								//{id: val.id, kegg_id: val.kegg_id, name: val.name, subsystem: val.subsystem, type: val.type, x: val.x, y: val.y, r: val.r, dx: dummyval.dx, dy: dummyval.dy, font_size: dummyval.font_size, opacity: val.opacity, fill:ele.attr('fill'),cpd_link: val.cpd_link}
								
								data.nodes.push(newnode1);
								//actualdata.nodes.push(newnode1);
							}
						})
						d3.select("#network").select(".links_g").selectAll("path").each(function(d){
							if(d.source.selected==1 && d.target.selected==1){
								let ele = d3.select(this)
								let newlink = {source: d.source.id+"_dup_"+randid, target: d.target.id+"_dup_"+randid, id: ele.attr('id')+"_dup_"+randid, strength:d.strength, kegg_id: d.kegg_id, d:d.d, stroke: d.stroke, opacity: d.opacity, subsystem: d.subsystem}
								data.links.push(newlink);
								//actualdata.links.push(newlink);
								
								//{source: d.source.id, target: d.target.id, strength: ele.style('stroke-width').split("p")[0], id: ele.attr('id'), d:ele.attr('d'), kegg_id: d.kegg_id, opacity:ele.attr('opacity'), stroke:ele.style('stroke'), subsystem: d.subsystem}
							}
						})
						//duplicates++;
						drawnetwork(data);								
					}
					
					function Insert_link_node(){
						let randid = makeid(20)
						let newPoint = {'x':0.0,'y':0.0}								
						newPoint.x = (mouse_cor.x - zoomTrans.x)/zoomTrans.scale;
						newPoint.y = (mouse_cor.y - zoomTrans.y)/zoomTrans.scale;
						
						let newnode = {id:randid, subsystem: "Subsystem name",rev: 0, kegg_id: randid, name: "Insert Rxn/link node name", type:'R', x :newPoint.x, y:newPoint.y, r:8.0, dx:10.0, dy:2.0, font_size:12.0, gene_link:'undefined', rxn_link:'undefined', gene:'undefined', fill:"#d3d3d3", rxn:'undefined'};
						data.nodes.push(newnode);
						//actualdata.nodes.push(newnode);
						drawnetwork(data);
					}
					
					//console.log('actualdata',actualdata)
					
					function Insert_node(){
						let randid = makeid(20)
						let newPoint = {'x':0.0,'y':0.0}								
						newPoint.x = (mouse_cor.x - zoomTrans.x)/zoomTrans.scale;
						newPoint.y = (mouse_cor.y - zoomTrans.y)/zoomTrans.scale;
						
						let newnode = {id:randid, name:"Insert node name", subsystem: "Subsystem name", type:'M', kegg_id: randid, x :newPoint.x, y:newPoint.y+40, r:8.0, dx:10.0, dy:2.0, font_size:12.0, fill:'white', cpd_link:'undefined'};
						data.nodes.push(newnode);
						//actualdata.nodes.push(newnode);
						drawnetwork(data);
					}
					
					function Insert_reaction(){
						let newPoint = {'x':0.0,'y':0.0}								
						newPoint.x = (mouse_cor.x - zoomTrans.x)/zoomTrans.scale;
						newPoint.y = (mouse_cor.y - zoomTrans.y)/zoomTrans.scale;
						
						//console.log('data.nodes before',data.nodes)
						//console.log('actualdata.nodes before',actualdata.nodes)
						
						let randid = makeid(20)
						let newnode = {id:randid, subsystem: "Subsystem name",rev: 0, kegg_id: randid, name: "Insert Rxn/link node name", type:'R', x :newPoint.x, y:newPoint.y, r:8.0, dx:10.0, dy:2.0, font_size:12.0, gene_link:'undefined', rxn_link:'undefined', gene:'undefined', fill:"#d3d3d3", rxn:'undefined'};
						data.nodes.push(newnode);
						//actualdata.nodes.push(newnode);
						
						let randid1 = makeid(20)
						let newnode1 = {id:randid1, name:"Insert node name", subsystem: "Subsystem name", type:'M', kegg_id: randid1, x :newPoint.x, y:newPoint.y+40, r:8.0, dx:10.0, dy:2.0, font_size:12.0, fill:'white',cpd_link:'undefined'};
						data.nodes.push(newnode1);
						//actualdata.nodes.push(newnode1);
						
						//console.log('actualdata.nodes after',actualdata.nodes)
						
						let newlink = {source: randid, target: randid1, id: randid, strength:2.0, kegg_id: randid, stroke: "rgb(0, 0, 0)", opacity: 1.0, subsystem: "Subsystem name"}
						data.links.push(newlink);
						
						//console.log(data)
						
						//actualdata.links.push(newlink);
						drawnetwork(data);
						//console.log('actualdata1',actualdata)
					}
					
					function match_data(){
						
						if(data.nodes.length!=actualdata.nodes.length){
							let nids = [];//, nids1 = [];
							
							actualdata.nodes.forEach(function(n){
								nids.push(n.id)
							});
							//jsonObj.nodes.forEach(function(n){
							//	nids1.push(n.id)
							//});
													
							data.nodes.forEach(function(n){
								if(nids.includes(n.id)==false)
								actualdata.nodes.push(n)
							});
							//data.nodes.forEach(function(n){
							//	if(nids1.includes(n.id)==false)
							//		jsonObj.nodes.push(n)
							//});
						}
						
						if(data.links.length!=actualdata.links.length){
							let nids = [];//, nids1 = [];
							
							actualdata.links.forEach(function(n){
								nids.push(n.id)
							});
							
							//jsonObj.links.forEach(function(n){
							//	nids.push(n.id)
							//});
													
							data.links.forEach(function(n){
								if(nids.includes(n.id)==false)
								actualdata.links.push(n)
							});
							//data.links.forEach(function(n){
							//	if(nids1.includes(n.id)==false)
							//		jsonObj.links.push(n)
							//});
						}
						
						if(data.labels.length!=actualdata.labels.length){
							let nx = [], ny = [], ntexts = [];//, n1x = [], n1y = [], n1texts = [];
							actualdata.labels.forEach(function(n){
								nx.push(n.x)
								ny.push(n.y)
								ntexts.push(n.text)
							});
							//jsonObj.labels.forEach(function(n){
							//	n1x.push(n.x)
							//	n1y.push(n.y)
							//	n1texts.push(n.text)
							//});
													
							data.labels.forEach(function(n){
								if(nx.includes(n.x)==false && ny.includes(n.y)==false && ntexts.includes(n.text)==false)
									actualdata.labels.push(n)
							});
							//data.labels.forEach(function(n){
							//	if(n1x.includes(n.x)==false && n1y.includes(n.y)==false && n1texts.includes(n.text)==false)
							//		jsonObj.texts.push(n)
							//});
						}
						
						if(data.boxes.length!=actualdata.boxes.length){
							let nx = [], ny = [], nx1 = [], ny1 = [];
							//let n1x = [], n1y = [], n1x1 = [], n1y1 = [];
							actualdata.boxes.forEach(function(n){
								nx.push(n.cor[0].x)
								ny.push(n.cor[0].y)
								nx1.push(n.cor[1].x)
								ny1.push(n.cor[1].y)
							});
							//jsonObj.boxes.forEach(function(n){
							//	n1x.push(n.cor[0].x)
							//	n1y.push(n.cor[0].y)
							//	n1x1.push(n.cor[1].x)
							//	n1y1.push(n.cor[1].y)
							//});
													
							data.boxes.forEach(function(n){
								if(nx.includes(n.cor[0].x)==false && ny.includes(n.cor[0].y)==false && nx1.includes(n.cor[1].x)==false && ny1.includes(n.cor[1].y)==false)
									actualdata.boxes.push(n)
							});
							//data.boxes.forEach(function(n){
							//	if(n1x.includes(n.cor[0].x)==false && n1y.includes(n.cor[0].y)==false && n1x1.includes(n.cor[1].x)==false && n1y1.includes(n.cor[1].y)==false)
							//		jsonObj.boxes.push(n)
							//});
						}
						
						//Main_visualization_code(jsonObj);
					}
					
					match_data();
					
					var attributes_obj = [
						{'label':'','value': 'Choose one'},
						{'label':'Text', 'children':[
							{'label': 'font', 'value': 'font'},
							{'label': 'x-pos', 'value': 'x-pos'},
							{'label': 'y-pos', 'value': 'y-pos'}
						]},
						{'label':'Rectangles' , 'children':[
							{'label': 'Border', 'value': 'Border'},
							{'label': 'Roundness', 'value': 'Roundness'},
							{'label': 'Width', 'value': 'width_rec'},
							{'label': 'Height', 'value': 'height_rec'}
						]},
						{'label':'Spacing' , 'children':[
							{'label': 'Linear', 'value': 'Linear'},
							{'label': 'Circular', 'value': 'Circular'}
						]},
						{'label':'Node' , 'children':[
							{'label': 'Size', 'value': 'size'}
						]},
						{'label':'Link' , 'children':[
							{'label': 'Stroke-width', 'value': 'l-stroke-width'}
						]},
						{'label':'Image resolution' , 'children':[
							{'label': 'Img-Resolution', 'value': 'Img-Resolution'},
							{'label': 'Dimension ratio', 'value': 'dim_ratio'}
						]},
						{'label':'Freeze degree' , 'children':[
							{'label': 'Magnitude', 'value': 'Magnitude'}
						]}
					]
					
					var on_attribute_changed = function(){
						var ref = d3.select("#attributes").node().selectedOptions;
						
						//console.log(ref[0].value)
						//console.log('data',data)
						//console.log('data',actualdata)
						
						if(ref[0].value=="font"){
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change',function() {
								var val = this.value
								if(val<0.0)
									val = 0.0
								//if(d3.select("#selectALL").property("checked")){
								//	gp.select(".texts_g").selectAll('.texts').attr('font-size',val);
								//}
								//else{
								var ids = []
								gp.select('.nodes_g').selectAll('.selected').each(function(d){
									let ele = d3.select(this);
									ids.push(ele.attr('id').split("_curved_")[0])						
									//ids.push(ele.attr('id'))						
									ele.attr('font-size',val)						
								});
								//console.log("ids",ids)
								gp.select(".texts_g").selectAll('.texts').each(function(d){
									let ele = d3.select(this)
									if(ids.includes(ele.attr('id').split("_curved_")[0])){
										ele.attr('font-size',val)
									}
								});
								
								actualdata['nodes'].forEach(function(n){
									if(ids.includes(n.id))
										n.font_size = val;
								});
								data['nodes'] = actualdata['nodes']
								gp.select(".labels_g").selectAll('.selected').style('font-size',val);
								
							});
						}
						else if(ref[0].value=="x-pos"){
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change',function() {
								var val = this.value
								var ids = []
								gp.select('.nodes_g').selectAll('.selected').each(function(d){
									let ele = d3.select(this);
									ids.push(ele.attr('id'))						
								});
								
								actualdata['nodes'].forEach(function(n){
									if(ids.includes(n.id))
										n.dx = val;
								});
								data['nodes'] = actualdata['nodes']
								
								gp.select(".texts_g").selectAll('.texts').each(function(d){
									var ele1 = d3.select(this)
									if(ids.includes(ele1.attr('id')))
										ele1.attr('dx',val)	
								});
							});	
						}
						else if(ref[0].value=="y-pos"){
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change',function() {
								var val = this.value
								var ids = []
								gp.select('.nodes_g').selectAll('.selected').each(function(d){
									let ele = d3.select(this);
									ids.push(ele.attr('id'));						
								});
								
								actualdata['nodes'].forEach(function(n){
									if(ids.includes(n.id))
										n.dy = val;
								});
								data['nodes'] = actualdata['nodes']
								
								gp.select(".texts_g").selectAll('.texts').each(function(d){
									var ele1 = d3.select(this)
										if(ids.includes(ele1.attr('id')))
											ele1.attr('dy',val)	
								});
							});
						}
						else if(ref[0].value=="Border"){
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change',function() {
								var val = this.value
								if(val<0.0)
									val = 0.0
								d3.select("#network").selectAll('.selected').style('stroke-width',val);
							});
						}
						else if(ref[0].value=="Roundness"){
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',1.0);
							d3.select("#random_slider").on('change',function() {
								var val = this.value
								if(val<0.0)
									val = 0.0
								d3.select("#network").selectAll('.selected').style('rx',val);
								d3.select("#network").selectAll('.selected').style('ry',val);
							});
						}
						else if(ref[0].value=="width_rec"){
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change',function(){
								var val =  this.value;
								if(val<0.0)
									val = 0.0
								gp.select(".bdry_g").selectAll('.selected').attr('width',val);
							});
						}
						else if(ref[0].value=="height_rec"){
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change',function(){
								var val =  this.value;
								if(val<0.0)
									val = 0.0
								
								gp.select(".bdry_g").selectAll('.selected').attr('height',val);
										
							});
						}
						else if(ref[0].value=="dim_ratio"){
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change',function(){
								var val =  this.value;
								if(val<0.0)
									val = 0.0
									
								let height, width;
								
								gp.select(".images_g").selectAll("image").each(function(d){
									let ele = d3.select(this)//saveimages.push({'name':ele.attr('name'),'x':ele.attr('x'),'y':ele.attr('y'),'width':ele.attr('width'),'height':ele.attr('height')})
									height = ele.attr('height');
									width = ele.attr('width')
								});
								
								gp.select(".images_g").selectAll('.selected').attr('width',val*width);
								gp.select(".images_g").selectAll('.selected').attr('height',val*height);
							});
						}
						else if(ref[0].value=="Linear"){
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',1.0);
							d3.select("#random_slider").on('change', function(){
								var spacing = this.value
								var initval = 0.0
								if(spacing<1.0)
									spacing = 1.0
								var sortarr = gp.select('.nodes_g').selectAll('.selected').sort(function(d,d1){
									return d.y - d1.y
								});
								
								sortarr.each(function(d){
									var ele = d3.select(this)
									initval = ele.attr('cy')
								})
								
								var count = gp.select('.nodes_g').selectAll('.selected').size();
								
								sortarr.each(function(d,i) {
									d.fy = initval - (count - i - 1)*spacing;
								});
								simulation.alphaTarget(0.5).restart();
								simulation.tick();
								simulation.alphaTarget(0.0);
								
							});
						}
						else if(ref[0].value=="Circular"){
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',1.0);
							d3.select("#random_slider").on('change', function(){
								var spacing = this.value
								if(spacing<1.0)
									spacing = 1.0
								var center = compute_center();
								gp.select('.nodes_g').selectAll('.selected').each(function(d,i){
									var angle = Math.atan2(d.y-center[1],d.x-center[0])
									d.fx = center[0] + spacing*Math.cos(angle)
									d.fy = center[1] + spacing*Math.sin(angle)
								});
								simulation.alphaTarget(0.5).restart();
								simulation.tick();
								simulation.alphaTarget(0.0);
							});
						}
						else if(ref[0].value=="stroke-width"){
							settings = false;
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change', function(){
								var value = this.value
								if(value<0.0)
									value = 0.0
								var nids = []
								//gp.select('.nodes_g').selectAll('.selected').attr('stroke-width', value);
								///*
								gp.select('.nodes_g').selectAll('.selected').each(function(d){
									nids.push(d.id);
								});
								data.nodes.forEach(function(val,i){
									if(nids.includes(val.id))
										val.r = value;
								});
								drawnetwork(data);
								//*/
							});
						}
						else if(ref[0].value=="size"){
							settings = false;
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change', function(){
								var value = this.value
								if(value<0.0)
									value = 0.0
								var nids = [];
								
								gp.select('.nodes_g').selectAll('.selected').each(function(d){
									let ele = d3.select(this);
									ele.attr('r',value)
									nids.push(d.id);
								});
								
								//actualdata.nodes.forEach(function(val,i){
								//	if(nids.includes(val.id))
								//		val.r = value;
								//	val.fill = gp.select('.nodes_g').selectAll('.nodes').filter(function(n){
								//		let x = d3.select(this)
								//		if(n.id==val.id)
								//			return n
								//	}).attr('fill');
								//});
								//Mainfunction(actualdata);
								
								
								//gp.select('.nodes_g').selectAll('.selected').each(function(d){
								//	let ele = d3.select(this);
								//	ids.push(ele.attr('id'));						
								//});
								
								actualdata['nodes'].forEach(function(n){
									if(nids.includes(n.id))
										n.r = value;
								});
								data['nodes'] = actualdata['nodes']
								
								//gp.select(".texts_g").selectAll('.texts').each(function(d){
								//	var ele1 = d3.select(this)
								//		if(ids.includes(ele1.attr('id')))
								//			ele1.attr('dy',val)	
								//});
								
								
								
							});
						}
						else if(ref[0].value=="l-stroke-width"){
							settings = false;
							if(parseFloat(document.getElementById("input3").value)<0.0)
								document.getElementById("input3").value = 0.0
							if(parseFloat(document.getElementById("input4").value)<0.0)
								document.getElementById("input4").value = 10.0
							d3.select("#random_slider").attr('min', parseFloat(document.getElementById("input3").value));
							d3.select("#random_slider").attr('max',parseFloat(document.getElementById("input4").value));
							d3.select("#random_slider").attr('value',parseFloat(document.getElementById("input3").value)*0.5+parseFloat(document.getElementById("input4").value)*0.5);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change', function(){
								var value = this.value
								if(value<0.0)
									value = 0.0
								var lids = []
								//gp.select('.links_g').selectAll('.selected').attr('stroke-width', value);
								///*
								gp.select('.links_g').selectAll('.selected').each(function(d){
									let ele = d3.select(this);
									ele.attr('stroke-width',value)
									lids.push(d.id);
								});
								
								actualdata['links'].forEach(function(n){
									if(lids.includes(n.id))
										n.strength = value;
								});
								data['links'] = actualdata['links']
								
								//actualdata.links.forEach(function(val,i){
								//	if(lids.includes(val.id))
								//		val.strength = value;
								//	val.stroke = gp.select('.links_g').selectAll('path').filter(function(l){
								//		if(l.id==val.id)
								//			return l
								//	}).attr('stroke');
									//console.log(val.stroke)
								//});
							});
						}
						else if(ref[0].value=="Img-Resolution"){
							d3.select("#random_slider").attr('min',1.0);
							d3.select("#random_slider").attr('max',10.0);
							d3.select("#random_slider").attr('value',6.0);
							d3.select("#random_slider").attr('step',0.1);
							d3.select("#random_slider").on('change', function(){
								Zoomscale = this.value;
							})
						}
						else if(ref[0].value=="Magnitude"){
							d3.select("#random_slider").attr('min',0.0);
							d3.select("#random_slider").attr('max',1.0);
							d3.select("#random_slider").attr('value',0.98);
							d3.select("#random_slider").attr('step',0.01);
							d3.select("#random_slider").on('change', function(){
								alphaMIN = this.value;
								if(d3.select("#freezekey").property("checked")){
									simulation.stop();
									simulation.alphaMin(this.value);
								}
							})
						}
						else if(ref[0].value=="Choose one"){	
						}
					};
					
					$('#attributes').multiselect({
						buttonWidth: '255px',
						maxHeight: 200,
						enableClickableOptGroups: true,
						enableCollapsibleOptGroups: true,
						collapseOptGroupsByDefault: true,
						enableFiltering: true,
						enableCaseInsensitiveFiltering: false,
						filterPlaceholder: 'Cerca',
						includeSelectAllOption: false,
						selectAllJustVisible: false,
						selectAllText: 'Select All',
						nSelectedText: ' selected',
						allSelectedText: 'All selected',
						nonSelectedText: 'Attributes',
						onChange: on_attribute_changed,
						onSelectAll: on_attribute_changed,
						onDeselectAll: on_attribute_changed
					});
					
					$('#attributes').multiselect('dataprovider', attributes_obj);
					
					netgroup = find_node(data)
					
					$('#show_names').multiselect('dataprovider', netgroup);
					
				}
				//console.log(data)
				drawnetwork(data);
				
			};
			
			d3.select('#menu_options').select('.menu').select('#submenu1').select('#menu1').select("#meta_file_upload").on("click", function(){
				var uploadfile = document.getElementById("meta_file").click();
			});
			
			d3.select("#meta_file").on("change", function(){
				if (window.File && window.FileReader && window.FileList && window.Blob){
					var uploadFile = this.files[0];
					
					var data_by_gp = [], cidx;
					
					d3.select("#para_slider").on("change", function(){						
						
						if(d3.select('#var_para').node().selectedOptions[0].value=="variation"){
							d3.select(this).attr('min',0.1); 
							d3.select(this).attr('value',1.0);
							d3.select(this).attr('max',5.0);
							d3.select(this).attr('step',0.1);
							scaling_val = this.value;
						}
						
						Gval = d3.select('#data_group').node().selectedOptions[0].value;
						
						cdata_temp = jQuery.extend(true, {}, cdata);
						//console.log('cdata_temp',cdata_temp)
						//console.log('cdata_final',cdata_final)
						
						//console.log('method',d3.select('#data_analysis').node().selectedOptions[0].value)
						
						if(d3.select('#data_analysis').node().selectedOptions[0].value=="Control Normalization"){
							
							let gp_names = [], gp_name;
							
							/*
							let ab_data_lst = [],cidx;
							ab_data.forEach(function(ab){
								ab_data_lst.push(ab.value)
							})
							
							cidx = ab_data_lst.findIndex(x => x === "C"); 
							*/
							
							no_of_grps.forEach(function(gp){
								gp_names.push(" " + gp.value)
							})
							
							$(".multiselect-container").find("li.active:not(.multiselect-group)").each(function(index, item) {
								let gpname = $(this).prevAll(".multiselect-group:first");
								if(gp_names.includes($(this).prevAll(".multiselect-group:first").text())){
									gp_name = $(this).prevAll(".multiselect-group:first").text()
								}
							})
							
							
							for(let i=0; i< ab_data.length; i++){
								
								if(i!=cidx){
									let arr_n1 = copy_by_value(cdata_temp[Gval][ab_data[i].value]["nodes"])
									//console.log('cdata_temp',cdata_temp)
									arr_n1.forEach(function(n,k){
										if((" " + n.gp)==gp_name){
											let arr_n = copy_by_value(cdata_temp[Gval][ab_data[cidx].value]["nodes"])
											let n2 = arr_n.filter(function(n1){
												if(n1.name==n.name && (" " + n1.gp)==gp_name){
													return n1
												}
											});
											
											let std_dev = 0.0;
											
											data_by_gp[0][n.gp].forEach(function(n3){
												if(n3.name==n.name){
													std_dev = dev(n3["data-values"])
												}
											})
							
											//console.log("std",std_dev)
											
											for(let j=0; j<time_data.length; j++){
												n[time_data[j].value] = (n[time_data[j].value]-n2[0][time_data[j].value])*scaling_val*1.0/std_dev + base_val*1.0
												if((n[time_data[j].value])>20.0){
													n[time_data[j].value] = 20.0
												}
												else if((n[time_data[j].value])<0.0){
													n[time_data[j].value] = 0.0 
												}
											}
										}
									});	
									cdata_temp[Gval][ab_data[i].value]["nodes"] = arr_n1.slice(); 									
								}
							}
							
							if(Object.keys(cdata_final).length==0){
								cdata_final = jQuery.extend(true, {}, cdata_temp);
							}
							
							for(let i=0; i< ab_data.length; i++){
								for(let j=0; j<cdata_final[Gval][ab_data[i].value]["nodes"].length; j++ ){
									let n = cdata_final[Gval][ab_data[i].value]["nodes"][j]
									if((" " + n.gp)==gp_name){
										var arr_n = cdata_temp[Gval][ab_data[i].value]["nodes"].slice();
										var n2 = arr_n.filter(function(n1){
											if(n1.name==n.name && (" " + n1.gp)==gp_name){
												return n1
											}
										});
										cdata_final[Gval][ab_data[i].value]["nodes"][j] = n2[0];
									}
								}
							}	
						}	
						
						else if(d3.select('#data_analysis').node().selectedOptions[0].value=="Control mean Normalization"){
							
							let gp_names = [], gp_name, std_dev = [];
							
							no_of_grps.forEach(function(gp){
								gp_names.push(" " + gp.value)
							})
							
							$(".multiselect-container").find("li.active:not(.multiselect-group)").each(function(index, item) {
								let gpname = $(this).prevAll(".multiselect-group:first");
								if(gp_names.includes($(this).prevAll(".multiselect-group:first").text())){
									gp_name = $(this).prevAll(".multiselect-group:first").text()
								}
							});
							
							function process_data(){
									
								for(let i=0; i< ab_data.length; i++){								
									if(i!=cidx){
										let arr_n1 = copy_by_value(cdata_temp[Gval][ab_data[i].value]["nodes"])
										
										//console.log('arr_n1',arr_n1)
										
										arr_n1.forEach(function(n,k){
											
											let arr_n = copy_by_value(cdata_temp[Gval][ab_data[cidx].value]["nodes"])
											if((" " + n.gp)==gp_name){
												let n2 = arr_n.filter(function(n1){
													if(n1.name==n.name && (" " + n1.gp)==gp_name){
														return n1
													}
												});
												
												let cmean = 0.0
												for(let j=0; j<time_data.length; j++){
													cmean += n2[0][time_data[j].value]
												}
												
												cmean = cmean/time_data.length
												//console.log('cmean',cmean)
												
												let std_dev = 0.0;
											
												data_by_gp[0][n.gp].forEach(function(n3){
													if(n3.name==n.name){
														std_dev = dev(n3["data-values"])
													}
												})
												
												for(let j=0; j<time_data.length; j++){
													n[time_data[j].value] = (n[time_data[j].value]-cmean)*scaling_val*1.0/std_dev + base_val*1.0
													if(n[time_data[j].value]>20.0){
														n[time_data[j].value] = 20.0
													}
													else if(n[time_data[j].value]<0.0){
														n[time_data[j].value] = 0.0 
													}
													//console.log('n[time_data[j].value]',n[time_data[j].value])
												}
											}
										});	
										cdata_temp[Gval][ab_data[i].value]["nodes"] = arr_n1.slice();					
									}
								}
								
								if(Object.keys(cdata_final).length==0){
									cdata_final = jQuery.extend(true, {}, cdata_temp);
								}
								
								for(let i=0; i< ab_data.length; i++){
									for(let j=0; j<cdata_final[Gval][ab_data[i].value]["nodes"].length; j++ ){
										let n = cdata_final[Gval][ab_data[i].value]["nodes"][j]
										if((" " + n.gp)==gp_name){
											var arr_n = cdata_temp[Gval][ab_data[i].value]["nodes"].slice();
											var n2 = arr_n.filter(function(n1){
												if(n1.name==n.name && (" " + n1.gp)==gp_name){
													return n1
												}
											});
											cdata_final[Gval][ab_data[i].value]["nodes"][j] = n2[0];
										}
									}
								}
							}
							
							process_data();	
						}	
						
						else if(d3.select('#data_analysis').node().selectedOptions[0].value=="log2_fold_change"){
							
							let gp_names = [], gp_name;
							
							/*
							let ab_data_lst = [], cidx;
							ab_data.forEach(function(ab){
								ab_data_lst.push(ab.value)
							})
							
							cidx = ab_data_lst.findIndex(x => x === "C"); 
							*/
							
							no_of_grps.forEach(function(gp){
								gp_names.push(" " + gp.value)
							})
							
							$(".multiselect-container").find("li.active:not(.multiselect-group)").each(function(index, item) {
								let gpname = $(this).prevAll(".multiselect-group:first");
								if(gp_names.includes($(this).prevAll(".multiselect-group:first").text())){
									gp_name = $(this).prevAll(".multiselect-group:first").text()
								}
							})
							
							for(let i=0; i< ab_data.length; i++){
								
								if(i!=cidx && ab_data[i].value!='None'){
									let arr_n1 = copy_by_value(cdata_temp[Gval][ab_data[i].value]["nodes"])
									let arr_n = copy_by_value(cdata_temp[Gval][ab_data[cidx].value]["nodes"])
										
									arr_n1.forEach(function(n,k){
										
										if((" " + n.gp)==gp_name){
											var n2 = arr_n.filter(function(n1){
												if(n1.name==n.name && (" " + n1.gp)==gp_name){
													return n1
												}
											});
											for(let j=0; j<time_data.length; j++){
												n[time_data[j].value] = Math.log2(n[time_data[j].value]/n2[0][time_data[j].value])*scaling_val*1.0 + 2.0//base_val*1.0
												if((n[time_data[j].value])>20.0){
													n[time_data[j].value] = 20.0
												}
												else if((n[time_data[j].value])<0.0){
													n[time_data[j].value] = 0.0 
												}
											}
										}
									});	
									cdata_temp[Gval][ab_data[i].value]["nodes"] = arr_n1.slice(); 									
								}
							}
							
							if(Object.keys(cdata_final).length==0){
								cdata_final = jQuery.extend(true, {}, cdata_temp);
							}
							
							for(let i=0; i< ab_data.length; i++){
								for(let j=0; j<cdata_final[Gval][ab_data[i].value]["nodes"].length; j++ ){
									let n = cdata_final[Gval][ab_data[i].value]["nodes"][j]
									if((" " + n.gp)==gp_name){
										var arr_n = cdata_temp[Gval][ab_data[i].value]["nodes"].slice();
										var n2 = arr_n.filter(function(n1){
											if(n1.name==n.name && (" " + n1.gp)==gp_name){
												return n1
											}
										});
										cdata_final[Gval][ab_data[i].value]["nodes"][j] = n2[0];
									}
								}
							}
						}
						
						else if(d3.select('#data_analysis').node().selectedOptions[0].value=="fold_change"){
							
							let gp_names = [], gp_name;
							
							/*
							let ab_data_lst = [], cidx;
							ab_data.forEach(function(ab){
								ab_data_lst.push(ab.value)
							})
							
							cidx = ab_data_lst.findIndex(x => x === "C"); 
							*/
							
							no_of_grps.forEach(function(gp){
								gp_names.push(" " + gp.value)
							})
							
							$(".multiselect-container").find("li.active:not(.multiselect-group)").each(function(index, item) {
								let gpname = $(this).prevAll(".multiselect-group:first");
								if(gp_names.includes($(this).prevAll(".multiselect-group:first").text())){
									gp_name = $(this).prevAll(".multiselect-group:first").text()
								}
							})
							
							for(let i=0; i< ab_data.length; i++){
								
								if(i!=cidx && ab_data[i].value!='None'){
									let arr_n1 = copy_by_value(cdata_temp[Gval][ab_data[i].value]["nodes"])
									let arr_n = copy_by_value(cdata_temp[Gval][ab_data[cidx].value]["nodes"])
										
									arr_n1.forEach(function(n,k){
										
										if((" " + n.gp)==gp_name){
											var n2 = arr_n.filter(function(n1){
												if(n1.name==n.name && (" " + n1.gp)==gp_name){
													return n1
												}
											});
											for(let j=0; j<time_data.length; j++){
												if(n[time_data[j].value]/n2[0][time_data[j].value]>1.0){
													n[time_data[j].value] = (n[time_data[j].value]/n2[0][time_data[j].value])*scaling_val*1.0 + 2.0 //base_val*1.0
												}
												else{
													n[time_data[j].value] = (n2[0][time_data[j].value]/n[time_data[j].value])*scaling_val*1.0 + 2.0 //base_val*1.0
												}
												if((n[time_data[j].value])>20.0){
													n[time_data[j].value] = 20.0
												}
												else if((n[time_data[j].value])<0.0){
													n[time_data[j].value] = 0.0 
												}
											}
										}
									});	
									cdata_temp[Gval][ab_data[i].value]["nodes"] = arr_n1.slice(); 									
								}
							}
							
							if(Object.keys(cdata_final).length==0){
								cdata_final = jQuery.extend(true, {}, cdata_temp);
							}
							
							for(let i=0; i< ab_data.length; i++){
								for(let j=0; j<cdata_final[Gval][ab_data[i].value]["nodes"].length; j++ ){
									let n = cdata_final[Gval][ab_data[i].value]["nodes"][j]
									if((" " + n.gp)==gp_name){
										var arr_n = cdata_temp[Gval][ab_data[i].value]["nodes"].slice();
										var n2 = arr_n.filter(function(n1){
											if(n1.name==n.name && (" " + n1.gp)==gp_name){
												return n1
											}
										});
										cdata_final[Gval][ab_data[i].value]["nodes"][j] = n2[0];
									}
								}
							}
						}
						
						else if(d3.select('#data_analysis').node().selectedOptions[0].value=="None"){
							
							let gp_names = [], gp_name;
							
							/*
							let ab_data_lst = [], cidx;
							
							//console.log('ab_data',ab_data)
							
							ab_data.forEach(function(ab){
								ab_data_lst.push(ab.value)
							})
							
							cidx = ab_data_lst.findIndex(x => x === "C"); 
							*/
							
							no_of_grps.forEach(function(gp){
								gp_names.push(" " + gp.value)
							})
							
							$(".multiselect-container").find("li.active:not(.multiselect-group)").each(function(index, item){
								let gpname = $(this).prevAll(".multiselect-group:first");
								if(gp_names.includes($(this).prevAll(".multiselect-group:first").text())){
									gp_name = $(this).prevAll(".multiselect-group:first").text()
								}
							})
							
							//console.log('gpname',gp_name)
							
							let neg_values = 0
							
							for(let i=0; i< ab_data.length; i++){
								if(i!=cidx && ab_data[i].value!='None'){
									let arr_n1 = copy_by_value(cdata_temp[Gval][ab_data[i].value]["nodes"])
									arr_n1.forEach(function(n,k){
										if((" " + n.gp)==gp_name){
											for(let j=0; j<time_data.length; j++){
												if (n[time_data[j].value]<0.0)
													neg_values++;
											}
										}
									});	
								}
							}
							//console.log("neg_values",neg_values)
							//console.log('scaling_val',scaling_val)
							//console.log('cdata_temp',cdata_temp[Gval][ab_data[0].value]["nodes"])
							//console.log('ab_data[i].value',ab_data[0].value)
							
							for(let i=0; i< ab_data.length; i++){
								
								if(i!=cidx && ab_data[i].value!='None'){
									let arr_n1 = copy_by_value(cdata_temp[Gval][ab_data[i].value]["nodes"])
									//console.log('arr_n1',arr_n1)
									//console.log('Gval',Gval)
									//console.log('ab_data[i]',ab_data[i].value)
									arr_n1.forEach(function(n,k){
										if((" " + n.gp)==gp_name){
											//if((n.gp)==gp_name){
											for(let j=0; j<time_data.length; j++){
												if(neg_values>0.0){
													n[time_data[j].value] = n[time_data[j].value]*scaling_val*1.0 + 10.0
													if((n[time_data[j].value])>20.0){
														n[time_data[j].value] = 20.0
													}
													else if((n[time_data[j].value])<0.0){
														n[time_data[j].value] = 0.0 
													}
												}
												else{
													n[time_data[j].value] = n[time_data[j].value]*scaling_val*1.0
													if((n[time_data[j].value])>20.0){
														n[time_data[j].value] = 20.0
													}
													else if((n[time_data[j].value])<0.0){
														n[time_data[j].value] = 0.0 
													}
												}
											}
										}
									});	
									cdata_temp[Gval][ab_data[i].value]["nodes"] = arr_n1.slice();					
								}
							}
							
							if(Object.keys(cdata_final).length==0){
								cdata_final = jQuery.extend(true, {}, cdata_temp);
							}
							
							for(let i=0; i< ab_data.length; i++){
								if(ab_data[i].value!='None'){ 
									for(let j=0; j<cdata_final[Gval][ab_data[i].value]["nodes"].length; j++ ){
										let n = cdata_final[Gval][ab_data[i].value]["nodes"][j]
										if((" " + n.gp)==gp_name){
											//if((n.gp)==gp_name){
											var arr_n = cdata_temp[Gval][ab_data[i].value]["nodes"].slice();
											var n2 = arr_n.filter(function(n1){
												if(n1.name==n.name && (" " + n1.gp)==gp_name){
													return n1
												}
											});
											cdata_final[Gval][ab_data[i].value]["nodes"][j] = n2[0];
										}
									}
								}
							}
							//console.log('cdata_final',cdata_final)
						}
					
					});
					
					$('#assign_gp').multiselect('dataprovider', no_of_grps);
					
					//$('#data_analysis').multiselect('dataprovider', Methods);
					
					var variable_para = [
						{'label': 'None', value: 'None'},
						{'label': 'scaling', value: 'variation'}
					]
					
					$('#var_para').multiselect('dataprovider', variable_para);
					
					function get_data_std(cdata,cidx){
						let data_by_gp = [];
							 
						let arr_n = copy_by_value(cdata[Gval][ab_data[cidx].value]["nodes"])
						
						let gp_dic = {};
						no_of_grps.forEach(function(gp){
							if((" " + gp.value)!=" M" && (" " + gp.value)!=" R"){
								let gp_cat = [];
								arr_n.forEach(function(n1,k){
									let dic = {};
									let dummyarr = [];
									ab_data.forEach(function(ab){
										let arr_n1 = copy_by_value(cdata[Gval][ab.value]["nodes"])
										
										arr_n1.forEach(function(n,k){
											if((" " + n.gp)==(" " + gp.value) && (n1.name==n.name)){
												time_data.forEach(function(t){
													dummyarr.push(n[t.value])
												});	
											}
										});
									});
									if((" " + n1.gp)==(" " + gp.value)){
										dic["name"] = n1.name;									
										dic["data-values"] = dummyarr;
										gp_cat.push(dic)
									}
								});
								gp_dic[gp.value] = gp_cat;
							}
						});
						data_by_gp.push(gp_dic);
						//console.log("data_by_gp",data_by_gp)
						return data_by_gp;
						
					};
					
					if(uploadFile.type.includes("json")){
						var filereader = new window.FileReader(); 
						filereader.onload = function(){ 
							var metaRes = filereader.result; 
													
							try{
								cdata = JSON.parse(metaRes);
								var gpdata = Object.keys(cdata).sort();
								
								gpdata.forEach(function(d,i){
									data_group.push({'label':d,'value':d})
								});
								
								gpdata.push({'label':'None','value':'None'})
								
								var abdata = Object.keys(cdata[gpdata[0]]).sort();
								
								abdata.forEach(function(d,i){
									ab_data.push({'label':d,'value':d})
								});
								
								abdata.push({'label':'None','value':'None'})
								
								timedata = Object.keys(cdata[gpdata[0]][abdata[0]]['nodes']["0"]).sort();
								
								timedata.forEach(function(d,i){
									if(d!='gp' && d!='name')
										time_data.push({'label':d,'value':d})
								});
								
								//console.log('timedata',timedata)
								
								let gp_names = []
								
								for(let i=0; i<gpdata.length; i++){
									for(let j=0; j<abdata.length; j++){
										cdata[gpdata[i]][abdata[j]]['nodes'].forEach(function(n){
											if(gp_names.includes(n['gp'])==false)
												gp_names.push(n['gp'])
										})
									}
								}
								
								gp_names.forEach(function(gp){
									no_of_grps.push({'label':gp,'value':gp})
								})
								
								Gval = gpdata[0]
								Abval = abdata[0]
								tval = time_data[0].value
								
								cdata_final = cdata
								
								for(let i=0; i<ab_data.length; i++){
									if(ab_data[i].value=="C"){
										ab_data[i]["disabled"] = true;
										//attributes_obj[3]["children"][1]["disabled"] = true;		
									}
								}
								
								let ab_data_lst = [];
								ab_data.forEach(function(ab){
									ab_data_lst.push(ab.value)
								})
								
								cidx = ab_data_lst.findIndex(x => x === "C"); 
								
								var data_by_gp = get_data_std(cdata,cidx);

								$('#data_group').multiselect('dataprovider', data_group);
								
								$('#ab_data').multiselect('dataprovider', ab_data);

								$('#time_data').multiselect('dataprovider', time_data);
								
								$('#assign_gp').multiselect('dataprovider', no_of_grps);
								
								no_of_grps.forEach(function(gp){
									Methods.push({'label':gp.value, 'children': basic_Methods})
								})
								
								$('#data_analysis').multiselect('dataprovider', Methods);
								
								}catch(err){ 
									window.alert("Error parsing uploaded file\nerror message: " + err.message); 
									// display error message
							return;
							}
						};
						filereader.readAsText(uploadFile); 
					}
					
					else if(uploadFile.type.includes("excel") || uploadFile.type.includes("text")){
						var reader = new FileReader();
						reader.readAsText(uploadFile);
						reader.onload = function(event){
							var csv = event.target.result,
								data = $.csv.toArrays(csv),
								keys = data[0];
							//console.log('keys',keys)
							var G1 = [],G2 = [],G3 = [], Gp = [];

							keys.forEach(function(d,i){
								if(i>1){
									var group = d.split("_")
									G1.push({'label':group[0],'value':group[0]})
									G2.push({'label':group[1],'value':group[1]})
									G3.push({'label':group[2],'value':group[2]})
								}
							});
							
							data.forEach(function(d,i){
								if(i>0)
									Gp.push({'label':d[1],'value':d[1]})
							})
							
							Gp.push({'label':"M",'value':"M"})
							Gp.push({'label':"R",'value':"R"})
							
							G1.push({'label':"None",'value':"None"})
							//G2.push({'label':"None",'value':"None"})
							
							data_group = removeDuplicates(G1, "value");
							ab_data = removeDuplicates(G2, "value");
							time_data = removeDuplicates(G3, "value");
							no_of_grps = removeDuplicates(Gp, "value");
							
							data_group.sort(compare);
							ab_data.sort(compare);
							time_data.sort(compare);
							
							Gval = data_group[0].value
							//Abval = ab_data[0].value
							tval = time_data[0].value
							
							for(let i=0; i<ab_data.length; i++){
								if(ab_data[i].value=="C"){
									ab_data[i]["disabled"] = true;
									//attributes_obj[3]["children"][1]["disabled"] = true;		
								}
								else{
									Abval = ab_data[i].value
								}
							}
							
							var container1 = {}; // main object
							
							for(let e1 = 0; e1<data_group.length; e1++){
								var container2 = { }; // main object
								for(let e2 = 0; e2<ab_data.length; e2++){
									var nodesele = [];
									
									for(var row in data) {
										if(row>0){
											var container3 = { }; // main object
											for(let e3 = 0; e3<time_data.length; e3++){
												let column = data_group[e1].value + "_" + ab_data[e2].value + "_" + time_data[e3].value
												let idx = keys.findIndex(x => x === column); 
												container3[time_data[e3].value] = parseFloat(data[row][idx])
												container3["name"] = data[row][0];	
												container3["gp"] = data[row][1];	
											}
											nodesele.push(container3);
										}
									}
									let obj = {};
									obj["nodes"] = nodesele;
									obj["links"] = [];
									container2[ab_data[e2].value] = obj;
								}
								container1[data_group[e1].value] = container2;
							}
							//console.log('container1',container1)
							cdata = jQuery.extend(true, {}, container1);
							
							let ab_data_lst = [];
							ab_data.forEach(function(ab){
								ab_data_lst.push(ab.value)
							})
							
							cidx = ab_data_lst.findIndex(x => x === "C"); 
							
							data_by_gp = get_data_std(cdata,cidx);
							
							$('#data_group').multiselect('dataprovider', data_group);
								
							$('#ab_data').multiselect('dataprovider', ab_data);

							$('#time_data').multiselect('dataprovider', time_data);
							
							$('#assign_gp').multiselect('dataprovider', no_of_grps);
															
							no_of_grps.forEach(function(gp){
								Methods.push({'label':gp.value, 'children': basic_Methods})
							})
							
							$('#data_analysis').multiselect('dataprovider', Methods);

						};
						reader.onerror = function(){ alert('Unable to read ' + uploadFile.fileName); };
					}
					
					else{
						alert("Your datafile is not in correct format! \n\n Only CSV or JSON formats!")
					}
					/*
					d3.select("#dataset").on("change", function() {
						if(d3.select(this).property("checked")==true){
							$('#ab_data').removeAttr('multiple');
							$('#ab_data').removeAttr('selected').prop('selected', false);
							$('#ab_data').multiselect('rebuild');
							
							$('#data_group').removeAttr('multiple');
							$('#data_group').removeAttr('selected').prop('selected', false);
							$('#data_group').multiselect('rebuild');
							
							let list_menu_lst = []
							let ref = d3.select('#list_menu').node().selectedOptions;
							for (var i = 0; i<ref.length; i++) {
								list_menu_lst.push(ref[i].value)
							};
							$('#list_menu').multiselect('deselect', list_menu_lst);
						}
						else{
							$('#ab_data').attr('multiple','multiple')
							$('#ab_data').multiselect('rebuild');
							
							$('#data_group').attr('multiple','multiple')
							$('#data_group').multiselect('rebuild');
							
							let list_menu_lst = []
							let ref = d3.select('#list_menu').node().selectedOptions;
							for (var i = 0; i<ref.length; i++) {
								list_menu_lst.push(ref[i].value)
							};
							$('#list_menu').multiselect('deselect', list_menu_lst);
							//$('#list_menu').multiselect('rebuild');
						}
					});
					*/
					
				}
				else{
					alert("Your browser won't let you save this graph -- try upgrading your browser to IE 10+ or Chrome or Firefox.")
				};
			});
   			
            function Main_visualization_code(jsonObj){
				/////////////      SUBSYSTEM SELECTION     //////////////////////
				subsysgp = update_rxnlist(jsonObj);
				//console.log("jsonObj",jsonObj)
				//console.log(subsysgp)
				actualdata = jsonObj;
				finalupjsonobj_temp;
				nodedegobj = degfinder(actualdata);
				remelegp = RemNodeObj(nodedegobj);
				repelegp = RepNodeObj(nodedegobj);
				
				$('#list_menu').multiselect('dataprovider', subsysgp);
				$('#remove_nodes').multiselect('dataprovider', remelegp);
				$('#repeat_nodes').multiselect('dataprovider', repelegp);
			}
			
			function xmlobj2viz(xmlobj){
				
				let nodes = [], links = [];
				
				xmlobj["entry"].forEach(function(ele,i){
					//console.log(i,ele)
					if(ele['type']=='ortholog' || ele['type']=='gene'){
						try{
							let dic = {}
							kegg_rec.forEach(function(rec){
								if(rec.id==ele['reaction']){
									//console.log(rec)
									dic['name'] = rec.name;
									dic['type'] = 'R';
									dic['id'] = ele.id
									dic['kegg_id'] = rec.id;
									dic['rxn'] = rec.rxn;
									dic['gene'] = ele['name']
									dic['gene_link'] = ele['link'];
									dic['rxn_link'] = ele['link'].split('?')[0] + '?' + rec.id.split(':')[1];
									dic['subsystem'] = xmlobj["pathway"].title;
									dic['x'] = parseFloat(ele['graphics'].x);
									dic['y'] = parseFloat(ele['graphics'].y);
									dic['fill'] = '#d3d3d3';
									dic['r'] = 8.0;
									dic['dx'] = 10.0;
									dic['dy'] = 2.0;
									dic['font_size'] = 12.0;
									
									xmlobj['reaction'].forEach(function(rx){
										if(rx.name==rec.id){
											if(rx.type=='reversible')
												dic['rev'] = 1
											else
												dic['rev'] = 0
										}
									})
								}
								else if(ele['reaction'].includes(' ')){
									let firstrxn = ele['reaction'].split(' ')[0]
									//console.log(firstrxn)
									if(rec.id==firstrxn){
										//console.log(rec)
										dic['name'] = rec.name;
										dic['type'] = 'R';
										dic['id'] = ele.id
										dic['kegg_id'] = rec.id;
										dic['rxn'] = rec.rxn;
										dic['gene'] = ele['name']
										dic['gene_link'] = ele['link'];
										dic['rxn_link'] = ele['link'].split('?')[0] + '?' + rec.id.split(':')[1];
										dic['subsystem'] = xmlobj["pathway"].title;
										dic['x'] = parseFloat(ele['graphics'].x);
										dic['y'] = parseFloat(ele['graphics'].y);
										dic['fill'] = '#d3d3d3';
										dic['r'] = 8.0;
										dic['dx'] = 10.0;
										dic['dy'] = 2.0;
										dic['font_size'] = 12.0;
										
										xmlobj['reaction'].forEach(function(rx){
											if(rx.name==rec.id){
												if(rx.type=='reversible')
													dic['rev'] = 1
												else
													dic['rev'] = 0
											}
										})
									}
								}
							})
							nodes.push(dic)
						}
						catch(err){
							// Do nothing
						}
					}
					else if(ele['type']=='compound'){
						let dic = {}
						kegg_cpd.forEach(function(cpd){
							if(cpd.id==ele['name']){
								dic['name'] = cpd.name;
								dic['type'] = 'M';
								dic['id'] = ele['id'];
								dic['kegg_id'] = cpd.id;
								dic['cpd_link'] = ele['link'];
								dic['subsystem'] = xmlobj["pathway"].title;
								dic['x'] = parseFloat(ele['graphics'].x);
								dic['y'] = parseFloat(ele['graphics'].y);
								dic['fill'] = 'white'
								dic['r'] = 8.0;
								dic['dx'] = 10.0;
								dic['dy'] = 2.0;
								dic['font_size'] = 12.0;
							}
							else if(ele['name'].includes(' ')){
								let firstcpd = ele['name'].split(' ')[0]
								if(cpd.id==firstcpd){
									dic['name'] = cpd.name;
									dic['type'] = 'M';
									dic['id'] = ele['id'];
									dic['kegg_id'] = cpd.id;
									dic['cpd_link'] = ele['link'];
									dic['subsystem'] = xmlobj["pathway"].title;
									dic['x'] = parseFloat(ele['graphics'].x);
									dic['y'] = parseFloat(ele['graphics'].y);
									dic['fill'] = 'white'
									dic['r'] = 8.0;
									dic['dx'] = 10.0;
									dic['dy'] = 2.0;
									dic['font_size'] = 12.0;
								}
							}
						})
						nodes.push(dic)
					}
				});
				///*
				xmlobj["reaction"].forEach(function(ele,i){
					if(ele['type']=='reversible'){
						ele['substrate'].forEach(function(s){
							let dic = {};
							dic['id'] = ele['id']
							if(ele['name'].includes(" ")==false)
								dic['kegg_id'] = ele['name']
							else
								dic['kegg_id'] = ele['name'].split(" ")[0]
							dic['strength'] = 2.0;
							dic['subsystem'] = xmlobj["pathway"].title;
							dic['stroke'] = 'black'
							dic['opacity'] = 1.0
							dic['source'] = s['id']
							dic['target'] = ele['id']
							links.push(dic)
							
							dic = {};
							dic['id'] = ele['id']
							if(ele['name'].includes(" ")==false)
								dic['kegg_id'] = ele['name']
							else
								dic['kegg_id'] = ele['name'].split(" ")[0]
							dic['strength'] = 2.0;
							dic['subsystem'] = xmlobj["pathway"].title;
							dic['stroke'] = 'black'
							dic['opacity'] = 1.0
							dic['source'] = ele['id']
							dic['target'] = s['id']
							links.push(dic)
						});
						ele['product'].forEach(function(p){
							let dic = {};
							dic['id'] = ele['id']
							if(ele['name'].includes(" ")==false)
								dic['kegg_id'] = ele['name']
							else
								dic['kegg_id'] = ele['name'].split(" ")[0]
							dic['strength'] = 2.0;
							dic['subsystem'] = xmlobj["pathway"].title;
							dic['stroke'] = 'black'
							dic['opacity'] = 1.0
							dic['source'] = ele['id']
							dic['target'] = p['id']
							links.push(dic)
							
							dic = {};
							dic['id'] = ele['id']
							if(ele['name'].includes(" ")==false)
								dic['kegg_id'] = ele['name']
							else
								dic['kegg_id'] = ele['name'].split(" ")[0]
							dic['strength'] = 2.0;
							dic['subsystem'] = xmlobj["pathway"].title;
							dic['stroke'] = 'black'
							dic['opacity'] = 1.0
							dic['source'] = p['id']
							dic['target'] = ele['id']
							links.push(dic);
						});
					}
					else{
						ele['substrate'].forEach(function(s){
							var dic = {};
							dic['id'] = ele['id']
							if(ele['name'].includes(" ")==false)
								dic['kegg_id'] = ele['name']
							else
								dic['kegg_id'] = ele['name'].split(" ")[0]
							dic['strength'] = 2.0;
							dic['subsystem'] = xmlobj["pathway"].title;
							dic['stroke'] = 'black'
							dic['opacity'] = 1.0
							dic['source'] = s['id']
							dic['target'] = ele['id']
							links.push(dic)
						});
						ele['product'].forEach(function(p){
							var dic = {};
							dic['id'] = ele['id']
							if(ele['name'].includes(" ")==false)
								dic['kegg_id'] = ele['name']
							else
								dic['kegg_id'] = ele['name'].split(" ")[0]
							dic['strength'] = 2.0;
							dic['subsystem'] = xmlobj["pathway"].title;
							dic['stroke'] = 'black'
							dic['opacity'] = 1.0
							dic['source'] = ele['id']
							dic['target'] = p['id']
							links.push(dic)
						});
					}
					
				})
				//*/
				//console.log([nodes, links])
				return [nodes, links]
			}
			
			function find_pair_exist(arr, pair){
				let found = 0;
				pair.sort();
				arr.forEach(function(l){
					l.sort();
					if(JSON.stringify(l)==JSON.stringify(pair)){
						found = 1;
						return found;
					}
				})
				return found;
			}
			
			function filtering_edges(net){
				var lnodes = [], lnodesids = [], nodesids = [];
				net.nodes.forEach(function(n){
					if(n.type=="R"){
						var dic = {}
						dic["id"] = n.id;
						dic["rev"] = n.rev;
						lnodes.push(dic)
						lnodesids.push(n.id)
					}
					else{
						nodesids.push(n.id)
					}
				});
				//console.log(net.links)
				var links = [], linknids = [];
				net.links.forEach(function(l){
					if(find_pair_exist(linknids,[l.source,l.target])==0){
						
						let spe_l = lnodes.filter(function(l1){
										if(l1.id==l.id)
											return l1
									});
						//console.log(spe_l)
						//l["rev"] = spe_l[0]["rev"]
						if(spe_l.length>0){
							if(spe_l[0]["rev"]==1){
								if(lnodesids.includes(l.source) && nodesids.includes(l.target)){
									links.push(l)
								}
								else{
									let sid = l.source; 
									let tid = l.target;
									l.source = tid;
									l.target = sid;
									links.push(l) 
								}
							}
							else{
								links.push(l)
							}
						}
						
						linknids.push([l.source,l.target])
					}
				})
				//console.log("lnodes",lnodes)
				//console.log("links",links)
				return links
			}

			function custom_err(err_message){
				var alrtdiv = document.createElement('div');
				document.getElementById('div_main').appendChild(alrtdiv);
				alrtdiv.id = 'alrt';
				alrtdiv.style.zIndex = "1000";
				alrtdiv.style.position = "absolute";
				alrtdiv.style.left = "40%";
				alrtdiv.style.width = "600px";
				alrtdiv.style.height = "100px";
				alrtdiv.style.top = "40%";
				alrtdiv.style.color = "black";
				alrtdiv.style.fontSize = "16";
				alrtdiv.style.backgroundColor = "lightyellow";
				alrtdiv.style.borderColor = "black";
				alrtdiv.style.borderStyle = "solid";
				alrtdiv.style.borderWidth = "thick";
				alrtdiv.style.borderRadius = "30px";
				alrtdiv.style.textAlign = "center";
				alrtdiv.style.padding = "2%";
				
				//document.getElementById('alrt').innerHTML='<b>Please wait, Your file is being uploaded!!!</b>'; 
				document.getElementById('alrt').innerHTML='<b>'+ err_message +'</b>'; 
				setTimeout(function() {document.getElementById('alrt').remove();},2000);
			}
			
			function upload_files(filelist, total_generic_files, filenames){
				settings = false;
				//console.log('filelist',filelist)
				//filenames.sort();
				var generic_file_counted = 0,
					jsonObj_generic,
					keggObj,
					get_ids = [];
				
				for(let fileidx = 0; fileidx<filenames.length; fileidx++){
					
					for(let filen = 0; filen< filelist.length; filen++)
					{	
						if(filelist[filen].name==filenames[fileidx]){
							//console.log(filelist[filen].name.split("."))

							try{
								if(filelist[filen].name.split(".")[1]=="json" || filelist[filen].name.split(".")[1]=="xml"){
									
									custom_err('Please wait, Your file is being uploaded!!!')
									
								}
								else{
									window.alert("Error while uploading file! \n\n \u2022Only JSON and XML file formats are allowed! \n \u2022Also make sure that filename is appropriate. Filename.json or Filename.xml. \n \u2022There should not be more than one '.' in the full filename!");
								}
							}
							catch(err){
								window.alert(err.message);
								return; 
							}
							
							
							if(filelist[filen].name.includes('Ortholog') && filelist[filen].name.split(".")[1]=="json"){
								
								var filereader = new window.FileReader(); // makes the new file reader variable 
								generic_file_counted+=1
								filereader.onload =  function(e){
									try{
										if(jsonObj_generic==undefined){
											jsonObj_generic = JSON.parse(e.target.result);
											//let gen_keys = Object.keys(jsonObj_generic);
											
											jsonObj_generic["nodes"].forEach(function(d){
												if(d.name==null)
													d.name = makeid(20);	
											})
										}
										else{
											var jsonObj_temp_generic = JSON.parse(e.target.result); // parse data into JSON format.
											if(Object.keys(jsonObj_temp_generic).includes("images"))
												var  keys = ["nodes","links","labels","boxes","images"]//Object.keys(jsonObj_temp_generic);
											else
												var  keys = ["nodes","links","labels","boxes"]//Object.keys(jsonObj_temp_generic);
											for(let i=0; i<keys.length;i++){
												jsonObj_temp_generic[keys[i]].forEach(function(d){
													if(keys[i]=="nodes"){
														d.id = d.id + "_" + filen.toString();
														if(d.name==null)
															d.name = makeid(20);	
													}
													else if(keys[i]=="links"){
														d.id = d.id + "_" +filen.toString();
														d.source = d.source + "_" + filen.toString();
														d.target = d.target + "_" + filen.toString();
													}
													jsonObj_generic[keys[i]].push(d)
												})
											}
										}
										
										//console.log(get_ids)
										
										if(fileidx==filenames.length-1){
											jsonObj_generic["nodes"].forEach(function(d){
												if(!settings){
													if(get_ids.length==0)
														d.opacity = 1.0
													else{
														let found = 0;
														get_ids.forEach(function(idx){
															if(idx.id==d.id.split('_')[0] && d.subsystem==idx.subsystem){
																d.opacity = 1.0;
																//console.log(d,idx)
																if(d.type=="R"){
																	d.gene = idx.gene;
																	d.gene_link = d.gene_link.split('?')[0] + "?" + idx.gene.replaceAll(" ","+")
																}
																found = 1.0;
															}
														})	
														if(found==0)
															d.opacity = 0.5;
													}
												}
												else{
													d.opacity = 1.0;
												}
											})
											
											jsonObj_generic["links"].forEach(function(d){
												if(!settings){
													if(get_ids.length==0)
														d.opacity = 1.0
													else{
														let found = 0;
														get_ids.forEach(function(idx){
															if(idx.id==d.id.split('_')[0] && d.subsystem==idx.subsystem){
																d.opacity = 1.0;
																found = 1.0;
															}
														})	
														if(found==0)
															d.opacity = 0.5;
													}
												}
												else{
													d.opacity = 1.0;
												}
											})
											
											/*
											if(keggObj!=undefined){
												var newrxnslst = [];
												console.log(get_ids)
												get_ids.forEach(function(d){
													var found = 0
													jsonObj_generic["nodes"].forEach(function(d1){
														if(d1.id.split('_')[0]==d.id && d.subsystem==d1.subsystem)
															found = 1
													})
													if(found==0){
														let newnode = keggObj["nodes"].filter(function(d2){
																		if(d2.id.split('_')[0]==d.id && d.subsystem==d2.subsystem)
																			return d2
																		})
														//console.log(newnode)
														//console.log(newnode["0"].type)
														if(newnode.length>0){
															if(newnode["0"].type=="R")
																newrxnslst.push(d)
															//console.log('new node added', newnode)
															newnode.forEach(function(n){
																jsonObj_generic["nodes"].push(n)
															})
														}
													}
												})
												
												keggObj["links"].forEach(function(d){
													newrxnslst.forEach(function(idx){
														//console.log(idx)
														if(idx.id==d.id.split('_')[0] && d.subsystem==idx.subsystem)
															jsonObj_generic["links"].push(d)
													});	
													//if(newrxnslst.includes(d.kegg_id)){
													//	jsonObj_generic["links"].push(d)
													//}
												})
											}
											//*/
											
											function Load_final_file(){
												//console.log('jsonObj_generic',jsonObj_generic)
												jsonObj = jsonObj_generic;
												if(keggObj!=undefined){
													jsonObj.relation = keggObj.relation;
													jsonObj.pathway = keggObj.pathway;
												}
												//jsonObj.links = filtering_edges(jsonObj);
												image_files = jsonObj.images;
												Main_visualization_code(jsonObj);
											}
											
											setTimeout(Load_final_file,2000);
											
										}
									}
									catch(err){ 
										window.alert("Error parsing uploaded file\nerror message: " + err.message); 
										// display error message
									return;
									}
								};
								filereader.readAsText(filelist[filen], 'UTF-8');
							}
							
							else if(filelist[filen].name.split(".")[1]=="xml"){
								var filereader = new window.FileReader(); // makes the new file reader variable 
								var uploadFile = filelist[filen]; 
								
								filereader.onload =  function(e){
									try{
										if(filen==0){
											var data, parser, xmlDoc;

											parser = new DOMParser();
											
											xmlDoc = parser.parseFromString(e.target.result,"text/xml");
											
											//console.log("This is working", xmlDoc)
											
											let xmlobj = xml2obj(xmlDoc);
											
											let vizdata = xmlobj2viz(xmlobj);
											
											xmlobj['nodes'] = vizdata[0]
											xmlobj['links'] = vizdata[1]
											xmlobj['labels'] = []
											xmlobj['boxes'] = []
											
											//console.log(xmlobj)
											jsonObj = xmlobj;
											Main_visualization_code(jsonObj);
											//console.log(kegg_cpd)
											//console.log(kegg_rec)
											//obj2xml(xmlobj);
												
										}
										
									}
									catch(err){ 
										window.alert("Error parsing uploaded file\nerror message: " + err.message); 
										// display error message
									return;
									}
								};
								filereader.readAsText(filelist[filen], 'UTF-8'); 

							}
							
							else if(filelist[filen].name.split(".")[1]=="json"){
								var get_ids_temp = [];
								//console.log("filelist[filen].name",filelist[filen].name)
								// Get the ids of rxns from the kegg files. 
								var filereader = new window.FileReader(); // makes the new file reader variable 
								filereader.onload =  function(e){
									try{
										
										function jsonfiles(e,_callback){
											if(filenames.length>1){
												var keggObj_temp = JSON.parse(e.target.result); // parse data into JSON format.
												keggObj_temp["nodes"].forEach(function(d){
													d.id = d.id + "_" + filen.toString(); 
													//if(d.type=="R"){
													//	d.subsystem = d.subsystem;
													//}
												})
												keggObj_temp["links"].forEach(function(d){
													d.id = d.id + "_" +filen.toString();
													d.source = d.source + "_" + filen.toString();
													d.target = d.target + "_" + filen.toString();
												})
											}	
											else{
												var keggObj_temp = JSON.parse(e.target.result); // parse data into JSON format.
												//console.log('keggObj_temp',keggObj_temp)
											}
											//console.log('keggObj_temp',keggObj_temp)
											
											if(keggObj==undefined){
												keggObj = {"nodes":[],"links":[],"labels":[],"boxes":[],"entry":[],"pathway":{},"reaction":[],"relation":[],"images":[]}
												
												const keys = Object.keys(keggObj_temp);
												//console.log(keys)
												for(let i=0; i<keys.length;i++){
													if(keys[i]!="pathway"){
														keggObj_temp[keys[i]].forEach(function(d){
															keggObj[keys[i]].push(d)
														})
													}
													else{
														keggObj[keys[i]] = keggObj_temp[keys[i]];
													}
												}
												
												keggObj_temp["nodes"].forEach(function(d){
													get_ids.push({'id':d.id.split('_')[0], 'kegg_id': d.kegg_id, 'subsystem':d.subsystem, 'gene':d.gene})
												})
												//console.log('keggObj1',keggObj)
											}
											///*
											else{
												keggObj_temp["nodes"].forEach(function(d){
													get_ids.push({'id':d.id.split('_')[0], 'kegg_id': d.kegg_id, 'subsystem':d.subsystem, 'gene':d.gene})
												});
												
												var keys = [];
												if(Object.keys(keggObj_temp).includes("images"))
													keys = ["nodes","links","labels","boxes","images"]//Object.keys(keggObj_temp);
												else
													keys = ["nodes","links","labels","boxes"]//Object.keys(keggObj_temp);
											
												for(let i=0; i<keys.length;i++){
													//console.log(keys[i])
													keggObj_temp[keys[i]].forEach(function(d){
														keggObj[keys[i]].push(d)
													})
												}
												//console.log('keggObj2',keggObj)											
											}
											_callback();
										};
										
										jsonfiles(e,function(){
											
											setTimeout(function(){
												if(fileidx==filenames.length-1 && total_generic_files==0){
													jsonObj = keggObj;
													//console.log('keggObj',keggObj)
													jsonObj.links = filtering_edges(jsonObj);
													image_files = jsonObj.images;
													Main_visualization_code(keggObj);
												}												
											}, 2000);
											
																						
										})
										
										
										//*/
									}
									catch(err){ 
										window.alert("Error parsing uploaded file\nerror message1: " + err.message); 
										// display error message
									return;
									}
								};
								filereader.readAsText(filelist[filen], 'UTF-8');
							}
						}
					}
				}
			}
            
            /////////////////////////////////    UPLOAD NETWORK FILE    ///////////////////////////////////////////
            var uploadfileclick = d3.select('#menu_options').select('.menu').select('#submenu1').select('#menu1').select('#upload-input').on("click", function(){ 
                var uploadfile = document.getElementById("hidden-file-upload").click();
            });
            
            // select hidden-file-upload and if its property "changes" then reads the file content.  
            var uploadfilechange = d3.select("#hidden-file-upload").on("change", function(){
            // HTML5 finally provides a standard way to interact with local files, via the File API specification. first line checks if the browser fully supports the File API or not.  

                if (window.File && window.FileReader && window.FileList && window.Blob) {
					
					var filelist = this.files,
						generic_file_exist = false,
						total_generic_files = 0,
						filenames = [];
					
					for(let filen = 0; filen< filelist.length; filen++)
					{	
						filenames.push(filelist[filen].name)
						if(filelist[filen].name.includes('Ortholog')){
							generic_file_exist = true;
							total_generic_files+=1
						}
					}
					//console.log('filenames before ', filenames)
					filenames = filenames.sort(function(a, b) {
												const valA = a.toUpperCase();
												const valB = b.toUpperCase();
												let comparison = 0;
												if (valA > valB) {
												comparison = 1;
												} else if (valA < valB) {
												comparison = -1;
												}
												return comparison;
											});
					//console.log('filenames after ', filenames)
					upload_files(filelist,total_generic_files, filenames);
                }
                else {
					alert("Your browser won't let you save this graph -- try upgrading your browser to IE 10+ or Chrome or Firefox.")
                };
            });
            
			function saveSvg() {
				var svgEl = document.getElementById("svg_main")
				
				const xmlns = "http://www.w3.org/2000/xmlns/";
				const xlinkns = "http://www.w3.org/1999/xlink";
				
				//console.log(xlinkns)
				
				const svgns = "http://www.w3.org/2000/svg";
				svgEl = svgEl.cloneNode(true);
				const fragment = window.location.href + "#";
				const walker = document.createTreeWalker(svgEl, NodeFilter.SHOW_ELEMENT);
				while (walker.nextNode()) {
					for (const attr of walker.currentNode.attributes) {
						if (attr.value.includes(fragment)) {
							attr.value = attr.value.replace(fragment, "#");
						}
					}
				}
				svgEl.setAttributeNS(xmlns, "xmlns", svgns);
				svgEl.setAttributeNS(xmlns, "xmlns:xlink", xlinkns);
				const serializer = new window.XMLSerializer;
				const string = serializer.serializeToString(svgEl);
				var svgBlob = new Blob([string], {type: "image/svg+xml"});
				
				var name = "image.svg"
				var svgUrl = URL.createObjectURL(svgBlob);
                var downloadLink = document.createElement("a");
                downloadLink.href = svgUrl;
                downloadLink.download = name;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
			}
            
			var imagesave = document.getElementById("savesvg").addEventListener("click",saveSvg)
            
            // Set-up the export button
			d3.select('#savepng').on('click', function(){
                var svgString = getSVGString(svg.node());
                svgString2Image( svgString, Zoomscale*width, Zoomscale*height, 'png', save ); // passes Blob and filesize String to the callback

                function save( dataBlob, filesize ){
                    saveAs( dataBlob, 'X_network.png' ); // FileSaver.js function
                }
            });
            
            // Below are the functions that handle actual exporting:
            // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
			function getSVGString( svgNode ) {
                svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
                var cssStyleText = getCSSStyles( svgNode );
                appendCSS( cssStyleText, svgNode );

                var serializer = new XMLSerializer();
                var svgString = serializer.serializeToString(svgNode);
                svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
                svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

                return svgString;

				function getCSSStyles( parentElement ) {
                    var selectorTextArr = [];

                    // Add Parent element Id and Classes to the list
                    selectorTextArr.push( '#'+parentElement.id );
                    for (var c = 0; c < parentElement.classList.length; c++)
                            if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
                                selectorTextArr.push( '.'+parentElement.classList[c] );

                    // Add Children element Ids and Classes to the list
                    var nodes = parentElement.getElementsByTagName("*");
                    for (var i = 0; i < nodes.length; i++) {
                        var id = nodes[i].id;
                        if ( !contains('#'+id, selectorTextArr) )
                            selectorTextArr.push( '#'+id );

                        var classes = nodes[i].classList;
                        for (var c = 0; c < classes.length; c++)
                            if ( !contains('.'+classes[c], selectorTextArr) )
                                selectorTextArr.push( '.'+classes[c] );
                    }

                    // Extract CSS Rules
                    var extractedCSSText = "";
                    for (var i = 0; i < document.styleSheets.length; i++) {
                        var s = document.styleSheets[i];

                        try {
                            if(!s.cssRules) continue;
                        } catch( e ) {
                                if(e.name !== 'SecurityError') throw e; // for Firefox
                                continue;
                            }

                        var cssRules = s.cssRules;
                        for (var r = 0; r < cssRules.length; r++) {
                            if ( contains( cssRules[r].selectorText, selectorTextArr ) )
                                extractedCSSText += cssRules[r].cssText;
                        }
                    }


                    return extractedCSSText;

                    function contains(str,arr) {
                        return arr.indexOf( str ) === -1 ? false : true;
                    }

                }

                function appendCSS( cssText, element ) {
                    var styleElement = document.createElement("style");
                    styleElement.setAttribute("type","text/css"); 
                    styleElement.innerHTML = cssText;
                    var refNode = element.hasChildNodes() ? element.children[0] : null;
                    element.insertBefore( styleElement, refNode );
                }
            }

            function svgString2Image( svgString, width, height, format, callback ) {
                var format = format ? format : 'png';

                var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL

                var canvas = document.createElement("canvas");
                var context = canvas.getContext("2d");

                canvas.width = width;
                canvas.height = height;

                var image = new Image();
                image.onload = function() {
                    context.clearRect ( 0, 0, width, height );
                    context.drawImage(image, 0, 0, width, height);

                    canvas.toBlob( function(blob) {
                        var filesize = Math.round( blob.length/1024 ) + ' KB';
                        if ( callback ) callback( blob, filesize );
                    });
                };
                image.src = imgsrc;
            }
            
        </script>
        
    </body>
    
</html>


